"use strict";define("Test/TestResultsGrid",["require","exports","VSS/Reflux/Action","Test/common-util/Common","Test/common-util/Resources","Test/common-util/Telemetry","VSS/Core/Util/String","Test/Client/TestManagementServices","VSS/Platform/Feature","Test/common-util/TelemetryConstants","Test/common-util/Common.Utils","Test/common-converters/TestResultConverter","Test/common-util/FilterHelper","VSS/Reflux/Store","VSSUI/Utilities/Date","OfficeFabric/DetailsList","react","Test/common-util/TCMPerfScenarios","Test/common-util/TestOutcomeUtils","Test/common-util/TestResults.Filtering.Common","Tfs/Platform/Page","VSS/Core/Util/Accessibility","VSS/Platform/Components/FPSLink","VSS/Platform/Layout","VSS/Platform/Location","VSSUI/Icon","VSSUI/Image","VSSUI/Link","VSSUI/MessageBar","VSSUI/Spinner","VSSUI/TooltipEx","VSSUI/Tree"],(function(e,t,s,i,a,r,o,n,l,u,h,d,c,g,p,_,m,R,T,C,F,S,f,y,I,w,B,G,v,b,D,M){var P,A,O,E,k,x;P=t.Resources={},t.Resources.ResultGridTitle_Test="Test",t.Resources.QueryColumnNameDuration="Duration",t.Resources.ResultGridHeader_FailingRelease="Failing release",t.Resources.ResultGridHeader_FailingBuild="Failing build",t.Resources.ResultGridHeader_FailingSince="Failing since",t.Resources.ResultGridHeader_Owner="Owner",t.Resources.ResultGridHeader_DateStarted="Date started",t.Resources.ResultGridHeader_DateCompleted="Date completed",t.Resources.ResultGridHeader_Tags="Tags",t.Resources.LoadingMessage="Loading...",t.Resources.LoadingTestResultDetailsLabel="Loading details...",t.Resources.NewFailureIndicator="New",t.Resources.TestIndicatorSeparator="|",t.Resources.FlakyResultIndicator="Flaky",t.Resources.MarkedFlakyResultIndication="Marked Flaky",t.Resources.CurrentRelease="Current release",t.Resources.CurrentBuild="Current build",t.Resources.SubResultDisplayName="Sub result {0}",t.Resources.NoResultsForCurrentSetMessage="No test results found for the specified filter(s) in the current set",t.Resources.NoResultsMessage="No test results found for the selected filter(s)",t.Resources.NoResultsForCurrentSetSuggestionMessage="Choose the next result set above to find test results relevant to you",t.Resources.NoResultsSuggestionMessage="Choose a different filter to view test results relevant to you",t.Resources.NoFailedResultsMessage="Hooray! There are no test failures.",t.Resources.NoFailedResultsSuggestionMessage="Change the test outcome filter to view tests relevant to you.",t.Resources.NoConfigAllPassedMessage="All tests passed!",t.Resources.NoConfigAllPassedSuggestionMessage="Start publishing test results to view all test details.",t.Resources.LearnMoreText="Learn More.",t.Resources.TestResultsFilterClearedMessage="Showing {0} of {1} test results.",t.Resources.LoadMoreMessage="Filtered {0} of {1} test results.",t.Resources.ShowMoreTestResults="Show more test results",t.Resources.FetchingAll="Fetching all test results",t.Resources.FilterMoreTestResults="Filter more test results",t.Resources.DetailedListSortedAsc="Test results grid sorted by {0} in ascending order.",t.Resources.DetailedListSortedDesc="Test results grid sorted by {0} in descending order.",t.Resources.TagsList_AriaLabel="Tags list",t.Resources.SelectAll="Select all",t.Resources.SelectRow="Select the row",function(e){t[e]={};t[e].TestResultsGridActionsHub=class{constructor(){this.initializeTestResults=new s.Action,this.onGroupByChanged=new s.Action,this.filterChanged=new s.Action,this.onGridColumnChanged=new s.Action,this.shallowResultsFetched=new s.Action,this.groupedResultsFetched=new s.Action,this.loadStageData=new s.Action,this.onFetchMoreResults=new s.Action,this.onError=new s.Action,this.onWarning=new s.Action,this.onSelectionChange=new s.Action,this.sortDataInGridAndToggleState=new s.Action,this.onChangedToDefaultFilters=new s.Action,this.onTestTagSummaryFetched=new s.Action,this.onMarkTestResultFlaky=new s.Action,this.handleRunLevelResultCount=new s.Action,this.handleRunSummaryCountMismatch=new s.Action}};t[e].TestResultsLeftViewActionHub=class{constructor(){this.enableViewMoreTests=new s.Action}};t[e].TestResultsToGroupMap=class{};t[e].ShallowTestCaseResultData=class{}}("ActionsTestResultsGridActionHub"),function(e){A=t[e]={};class s{static getRunId(e,t){return t===i.TestResultsGroupPivots.Group_By_Test_Run?parseInt(e.groupByValue.id):0}static getPivotValueForGroupValue(e,t){let a="";switch(t){case i.TestResultsGroupPivots.Group_By_Test_Run:a=e.groupByValue.name;break;case i.TestResultsGroupPivots.Group_By_Test_Suite:const t=e.groupByValue;a=0===t.id?"":t.name;break;case i.TestResultsGroupPivots.Group_By_Requirement:const s=e.groupByValue;a=0===parseInt(s.id)?"":s.name;break;case i.TestResultsGroupPivots.Group_By_Container:case i.TestResultsGroupPivots.Group_By_Priority:case i.TestResultsGroupPivots.Group_By_None:case i.TestResultsGroupPivots.Group_By_Owner:a=e.groupByValue}return s.getPivotValue(t,a)}static getPivotValue(e,t){let s="";switch(e){case i.TestResultsGroupPivots.Group_By_Container:case i.TestResultsGroupPivots.Group_By_Test_Run:s=t;break;case i.TestResultsGroupPivots.Group_By_Requirement:s=(0,o.equals)(t,"")?a.NotAssociatedText:t;break;case i.TestResultsGroupPivots.Group_By_Test_Suite:s=t;break;case i.TestResultsGroupPivots.Group_By_Priority:s=(0,o.equals)("255",t)?"":(0,o.format)("{0}: {1}",a.PriorityText,t);break;case i.TestResultsGroupPivots.Group_By_Owner:s=t;break;case i.TestResultsGroupPivots.Group_By_None:s=a.AllText}return(0,o.equals)(s,"")&&(s=a.UnspecifiedText),s}}t[e].GroupByPivotHelper=s;class n{}t[e].Constants=n,n.pageSize=100,n.OutcomeConfidenceField="OutcomeConfidence",n.IsTestResultFlakyField="IsTestResultFlaky",n.TestResultFlakyStateField="TestResultFlakyState",n.filterchangedAction="filterChangedAction",n.groupByChangedAction="groupByChangedAction",n.loadMoreAction="loadMoreAction",n.batchResultsSize=1e5,n.shallowResultsBatchSize=1e4;class l{static async _getTheRegistrySettingsFromServer(e){return new Promise((async(t,s)=>{try{const s=e.getService("IVssContributionService");t(s.getData("ms.vss-test-web.testmanagement-settings-provider"))}catch(e){s(e)}}))}static _getRegistryValue(e,t){if(l._registryData)return l._getValue(t);l._getTheRegistrySettingsFromServer(e).then((e=>(l._registryData=e||{},l._getValue(t))),(e=>{console.warn(`unable to get the registry from the data provider reason:${e}`)}))}static _getValue(e){if(l._registryData){return l._registryData[e]}}static getMegaResultsSize(e){let t;try{t=l._getRegistryValue(e,l._megaResultsSizeRegistryName)}catch(t){console.error(`Couldn't get the registry setting ${l._megaResultsSizeRegistryName}. Reason:${t}`),(0,r.publishEvent)(e,null,"TestTab_RegistryFetch",{RegistryName:l._megaResultsSizeRegistryName,Error:t})}return t?+t:35e4}static getNewShallowResultsBatchSize(e){let t;try{t=l._getRegistryValue(e,l._newShallowResultsBatchSizeRegistryName)}catch(t){console.error(`Couldn't get the registry setting ${l._newShallowResultsBatchSizeRegistryName}. Reason:${t}`),(0,r.publishEvent)(e,null,"TestTab_RegistryFetch",{RegistryName:l._newShallowResultsBatchSizeRegistryName,Error:t})}return t?+t:2e4}}t[e].FilterSettings=l,l._megaResultsSizeRegistryName="/Service/WebAccess/TestManagement/Settings/TotalResultsToFetch",l._newShallowResultsBatchSizeRegistryName="/Service/WebAccess/TestManagement/Settings/ResultsFetchBatchSize"}("TestResultGridHelper"),function(e){O=t[e]={};t[e].TestResultGridSource=class{constructor(e){this.pageContext=e,this._detailedTestResultCache={},this._inProgressStateDPRequestParam={state:"InProgress"},this._completedStateDPRequestParam={state:"Completed"},this.buildResultGridDataProviderName="ms.vss-test-web.test-tab-build-resultdetails-data-provider",this.releaseResultGridDataProviderName="ms.vss-test-web.test-tab-release-resultdetails-data-provider",this._metricsAPIInUnifiedPipeline="WebAccess.TestManagement.UnifiedPipelineMetricsAPI",this._queryTcmDirectly="WebAccess.TestManagement.QueryFromTcmService",this._continuationTokenForTestResults=void 0,this._groupByFieldCache={},this._actionCache={},this._resultsFetchedForCurrentBatch=0,this._fetchingResults=!1}resetCache(){this._continuationTokenForTestResults=void 0,this._groupByFieldCache={},this._actionCache={},this._detailedTestResultCache={},this._resultsFetchedForCurrentBatch=0,this._fetchingResults=!1}getTestTagSummary(e){let t=e.data.mainData,s=this.pageContext.getService(n.TestManagementServiceName);if(e.viewContext===i.ViewContext.Build)return s.getTestTagSummaryForBuild(t.id);{let i=e.data.subData?e.data.subData:null,a=i&&i.environment?i.environment.id:null;return s.getTestTagSummaryForRelease(t.id,a)}}getTestResultsByGroup(e,t,s,a){if(!this._shouldFetchGroupedResults(t)||this._groupByFieldCache[t])return new Promise(((e,s)=>{e({groupByField:t,resultsForGroup:[]})}));let r=e.data.mainData,o=this.pageContext.getService(n.TestManagementServiceName);if(s=s||"",e.viewContext===i.ViewContext.Build)return o.getTestResultsByGroupForBuild(r.id,i.SourceWorkflow.BUILD_SOURCE_WORKFLOW,t,s,"",!0,!1);{let a=e.data.subData?e.data.subData:null,n=a&&a.environment?a.environment.id:null;return o.getTestResultsByGroupForRelease(r.id,n,i.SourceWorkflow.RELEASE_SOURCE_WORKFLOW,t,s,"",!0,!1)}}getTestResultsByGroupFromDataProvider(e){return new Promise((async(t,s)=>{const a=this.pageContext.getService("IVssContributionService");try{if(e.status===i.ViewContextStatus.InProgress){return t(await this._getTestResultsByGroupFromDataProviderAsync(e,a,this._inProgressStateDPRequestParam))}let s;return s=this.pageContext.getService("IVssPerformanceService").isFastPageSwitchScenario()?a.getData(this._getDataProviderName(e),this._completedStateDPRequestParam):a.getData(this._getDataProviderName(e)),this._isDataProviderCacheValid(a,s,e)?t(s.testResultsDetails):(r.publishEvent(this.pageContext,e,u.featureTestTab_ErrorInResultsGridDataProvider,{DataProviderName:this._getDataProviderName(e),error:"Dataprovider data is invalid or stale"}),t(await this._refreshAndGetDataProviderCache(a,e)))}catch(e){s(e)}}))}_isDataProviderCacheValid(e,t,s){if(!t)return!1;if(s.viewContext===i.ViewContext.Build){if(t.buildId!==s.data.mainData.id)return!1}if(s.viewContext===i.ViewContext.Release){const e=t;if(e.releaseId!==s.data.mainData.id||e.releaseEnvId!==s.data.subData.environment.id)return!1}return!e.getData(this._getDataProviderName(s),this._inProgressStateDPRequestParam)}async _refreshAndGetDataProviderCache(e,t){const s=e.getData(this._getDataProviderName(t),this._completedStateDPRequestParam);return this._isDataProviderCacheValid(e,s,t)?s:await e.getDataAsync(this._getDataProviderName(t),this._completedStateDPRequestParam,!0)}_getTestResultsByGroupFromDataProviderAsync(e,t,s){return new Promise(((i,a)=>{t.getDataAsync(this._getDataProviderName(e),s,!0).then((e=>{i(e.testResultsDetails)})).catch((e=>{a(e)}))}))}_getDataProviderName(e){return e.viewContext===i.ViewContext.Build?this.buildResultGridDataProviderName:this.releaseResultGridDataProviderName}getTestResultsByQueryForGivenResultIdentifiers(e){const t=[];return e.map((e=>{t.push({id:e.testResultId,testRun:{id:e.testRunId.toString()}})})),this._getTestResultsByQuery(t)}getSelectedTestCaseResult(e,t,s){return this.pageContext.getService(n.TestManagementServiceName).getResultById(t,s,4)}_getTestResultsByQuery(e){let t=this.pageContext.getService(n.TestManagementServiceName);const s=["Outcome","TestCaseTitle","AutomatedTestName","AutomatedTestStorage","TestResultGroupType"];s.push("Duration"),s.push("ReleaseEnvId"),s.push("Owner"),s.push("FailingSince"),s.push("DateStarted"),s.push("DateCompleted"),(0,l.isFeatureFlagEnabled)(this.pageContext,i.FeatureFlagConstants.TriReportCustomization,!1)&&s.push(A.Constants.OutcomeConfidenceField),(0,l.isFeatureFlagEnabled)(this.pageContext,i.FeatureFlagConstants.EnableTestFlakiness,!1)&&(s.push(A.Constants.IsTestResultFlakyField),s.push(A.Constants.TestResultFlakyStateField));const a={results:e=e.filter(((e,t,s)=>s.indexOf(e)===t)),fields:s};return t.getTestResultsByQuery(a)}getShallowTestResultDetails(e,t,s=!1,a){let r;r=null==a?void 0:a.map((e=>e.toString())).join(",");let o=this.pageContext.getService(n.TestManagementServiceName);if(!this._shouldFetchShallowResults(t,s))return new Promise(((e,t)=>{const i=s?A.FilterSettings.getMegaResultsSize(this.pageContext):A.Constants.batchResultsSize;this._resultsFetchedForCurrentBatch===i&&(this._resultsFetchedForCurrentBatch=0);e({shallowResults:[],isResultFetchedFromServer:!1})}));this._fetchingResults=!0,this._actionCache[t]=!0;let u=this._continuationTokenForTestResults;if(e.runId&&(u=void 0!==this._continuationTokenForTestResults?this._continuationTokenForTestResults:e.runId+"_0",this._continuationTokenForTestResults)){if(+this._continuationTokenForTestResults.split("_")[0]!=+e.runId)return new Promise(((e,t)=>{this._fetchingResults=!1,e({shallowResults:[],isResultFetchedFromServer:!0})}))}let h=e.data.mainData;return this._artifactId=h.id,new Promise(((t,s)=>{let n=(0,l.isFeatureFlagEnabled)(this.pageContext,i.FeatureFlagConstants.EnableFetchAllResultsUntilMegaBatchSize,!1)?A.FilterSettings.getNewShallowResultsBatchSize(this.pageContext):A.Constants.shallowResultsBatchSize;if(e.viewContext===i.ViewContext.Build)this._shouldUsePipelineAPi(e)?o.getTestResultsByPipeline(h.id,void 0,void 0,void 0,a,n,u).then((e=>{h.id===this._artifactId&&(this._continuationTokenForTestResults=null!=e.continuationToken?e.continuationToken:void 0,this._resultsFetchedForCurrentBatch+=e.length,this._fetchingResults=!1,t({shallowResults:e,isResultFetchedFromServer:!0}))}),(e=>{h.id===this._artifactId&&s(e)})):o.getTestResultsByBuildWithContinuationToken(h.id,i.SourceWorkflow.BUILD_SOURCE_WORKFLOW,r,n,u).then((e=>{h.id===this._artifactId&&(this._continuationTokenForTestResults=e.continuationToken,this._resultsFetchedForCurrentBatch+=e.results.length,this._fetchingResults=!1,t({shallowResults:e.results,isResultFetchedFromServer:!0}))}),(e=>{h.id===this._artifactId&&s(e)}));else{let a=e.data.subData?e.data.subData:null,l=a&&a.environment?a.environment.id:null;o.getTestResultsByReleaseWithContinuationToken(h.id,l,i.SourceWorkflow.RELEASE_SOURCE_WORKFLOW,r,n,u).then((e=>{h.id===this._artifactId&&(this._continuationTokenForTestResults=e.continuationToken,this._resultsFetchedForCurrentBatch+=e.results.length,this._fetchingResults=!1,t({shallowResults:e.results,isResultFetchedFromServer:!0}))}),(e=>{h.id===this._artifactId&&s(e)}))}}))}_shouldFetchShallowResults(e,t){if(this._fetchingResults)return!1;if((e===A.Constants.filterchangedAction||e===A.Constants.groupByChangedAction)&&(this._actionCache[A.Constants.filterchangedAction]||this._actionCache[A.Constants.groupByChangedAction]))return!1;const s=t?A.FilterSettings.getMegaResultsSize(this.pageContext):A.Constants.batchResultsSize;return!(this._resultsFetchedForCurrentBatch>0&&!this._continuationTokenForTestResults||this._resultsFetchedForCurrentBatch===s)}_shouldFetchGroupedResults(e){return e===i.TestResultsGroupPivots.Group_By_Test_Run||e===i.TestResultsGroupPivots.Group_By_Requirement||e===i.TestResultsGroupPivots.Group_By_Test_Suite}_shouldUsePipelineAPi(e){return e.contributionSource===i.ContributionSource.Pipeline&&((0,l.isFeatureFlagEnabled)(this.pageContext,this._queryTcmDirectly,!1)&&(0,l.isFeatureFlagEnabled)(this.pageContext,this._metricsAPIInUnifiedPipeline,!1))}}}("SourcesTestResultsGridSource"),function(e){E=t[e]={};class s{constructor(){this._elementsMap={},this.length=0,"undefined"==typeof Set||"function"!=typeof Set.prototype.keys?this._elementsMap={}:this._set=new Set}forEach(e){"undefined"==typeof Set||"function"!=typeof Set.prototype.keys?Object.keys(this._elementsMap).forEach((t=>{e(t)})):this._set.forEach((t=>{e(t)}))}add(e){"undefined"==typeof Set||"function"!=typeof Set.prototype.keys?(this._elementsMap[e.toString()]=!0,this.length++):(this._set.add(e),this.length++)}has(e){return"undefined"==typeof Set||"function"!=typeof Set.prototype.keys?this._elementsMap[e.toString()]:this._set.has(e)}}class a{constructor(){this.resetCache()}static _getIntersectionOfSets(e,t){if(null==t)return e;if(null==e)return t;const i=new s;return t.length>e.length?e.forEach((e=>{t.has(e)&&i.add(e)})):t.forEach((t=>{e.has(t)&&i.add(t)})),i}static _getResultKey(e,t){return(0,o.format)("{0}:{1}",e,t)}resetCache(e){this._cachedOwnerToTestCaseRefIds={},this._cachedContainerToTestCaseRefIds={},this._cachedOutcomeToTestResultIds={},this._cachedTestCaseRefIdToTitle={},this._cachedTestResultIdsToTags={},e||(this._cachedTestRunIdToStage={})}populateCache(e){if(null==e.automatedTestStorage&&(e.automatedTestStorage=""),this._cachedContainerToTestCaseRefIds.hasOwnProperty(e.automatedTestStorage)||(this._cachedContainerToTestCaseRefIds[e.automatedTestStorage]=new s),this._cachedContainerToTestCaseRefIds[e.automatedTestStorage].add(e.refId),null==e.owner&&(e.owner=""),this._cachedOwnerToTestCaseRefIds.hasOwnProperty(e.owner)||(this._cachedOwnerToTestCaseRefIds[e.owner]=new s),this._cachedOwnerToTestCaseRefIds[e.owner].add(e.refId),null!=e.outcome){const t=i.TestOutcomeEnum[e.outcome];2===t&&e.isReRun?(this._cacheOutcome(i.TestResultsOutcomeFilterPivots.Filter_By_Passed,e.runId,e.id),this._cacheOutcome(i.TestResultsOutcomeFilterPivots.Filter_By_PassedOnRerun,e.runId,e.id)):i.Constants.OTHER_OUTCOME_LIST.indexOf(t)>-1?this._cacheOutcome(i.TestResultsOutcomeFilterPivots.Filter_By_Others,e.runId,e.id):this._cacheOutcome(e.outcome,e.runId,e.id)}e.testCaseTitle&&(this._cachedTestCaseRefIdToTitle[e.refId]=e.testCaseTitle.toLowerCase()),e.tags&&e.tags.length&&(this._cachedTestResultIdsToTags[a._getResultKey(e.runId,e.id)]=e.tags)}populateStageCache(e){e.resultsForGroup.forEach((e=>{e.groupByValue&&e.groupByValue.pipelineReference&&e.groupByValue.pipelineReference.stageReference&&(this._cachedTestRunIdToStage[+e.groupByValue.id]=e.groupByValue.pipelineReference.stageReference.stageName)}))}isStageCacheInitialized(){return Object.keys(this._cachedTestRunIdToStage).length>0}filterGroupedResults(e,t){const s={groupByField:e.groupByField,resultsForGroup:[]};return this._populateFilteredTestCaseCachesForTheSelectedFilters(t,e.groupByField),e.resultsForGroup.forEach((i=>{const a={groupByValue:i.groupByValue,results:[],resultsCountByOutcome:i.resultsCountByOutcome,tags:i.tags},r=this._doesRunSatisfyFilter(t,i,e.groupByField);i.results&&i.results.length>0&&i.results.forEach((e=>{this._doesResultSatisfyFilter(e,r,t)&&a.results.push(e)})),(1!==r||a.results&&a.results.length>0)&&s.resultsForGroup.push(a)})),this._clearFilteredIds(),s}_clearFilteredIds(){this._filteredTestResultIdsWithOutComeFilter=null,this._filteredTestResultIdsWithOutComeAndTagFilter=null,this._filteredTestCaseRefIdsWithOwnerAndContainer=null,this._filteredTestCaseRefIdsWithOwnerContainerAndTestCaseName=null}_populateFilteredTestCaseCachesForTheSelectedFilters(e,t){this._clearFilteredIds(),this._IsFilterEmpty(e)||(this._filteredTestResultIdsWithOutComeFilter=this._getTestResultIdsForTheSelectedOutcomes(e),this._filteredTestResultIdsWithOutComeAndTagFilter=this._getTestResultIdsForTheSelectedTags(e,this._filteredTestResultIdsWithOutComeFilter),this._filteredTestCaseRefIdsWithOwnerAndContainer=this._getTestCaseIdsForTheSelectedOwnerAndContainer(e),this._filteredTestCaseRefIdsWithOwnerContainerAndTestCaseName=this._getTestCaseIdsWithTestCaseNameFilter(e,this._filteredTestCaseRefIdsWithOwnerAndContainer))}_IsFilterEmpty(e){return null==e||!(i.FilterByFields.Owner in e||i.FilterByFields.Container in e||i.FilterByFields.TestCaseName in e||i.FilterByFields.Outcome in e||i.FilterByFields.Tags in e)}_getTestResultIdsForTheSelectedOutcomes(e){if(null==e||!(i.FilterByFields.Outcome in e))return null;const t=new s,a=e[i.FilterByFields.Outcome];if(a.values&&a.values.length)for(const e of a.values)this._cachedOutcomeToTestResultIds.hasOwnProperty(e.toString())&&this._cachedOutcomeToTestResultIds[e.toString()].forEach((e=>{t.add(e)}));return t}_getTestCaseIdsForTheSelectedOwnerAndContainer(e){let t=null;for(const r in e){const o=e[r];if(o.values.length){let e=null;switch(r){case i.FilterByFields.Owner:e=new s;for(const t of o.values)this._cachedOwnerToTestCaseRefIds.hasOwnProperty(t.toString())&&this._cachedOwnerToTestCaseRefIds[t.toString()].forEach((t=>{e.add(t)}));break;case i.FilterByFields.Container:e=new s;for(const t of o.values)this._cachedContainerToTestCaseRefIds.hasOwnProperty(t.toString())&&this._cachedContainerToTestCaseRefIds[t.toString()].forEach((t=>{e.add(t)}))}t=a._getIntersectionOfSets(t,e)}}return t}_getTestResultIdsForTheSelectedTags(e,t){if(null==e||!(i.FilterByFields.Tags in e))return t;const a=new s,r=e[i.FilterByFields.Tags];if(r.values&&r.values.length){const e=r.values;if(null===t)for(const t in this._cachedTestResultIdsToTags)this._doesTestResultContainTags(t,e)&&a.add(t);else t.forEach((t=>{this._doesTestResultContainTags(t,e)&&a.add(t)}))}return a}_doesTestResultContainTags(e,t){const s=this._cachedTestResultIdsToTags[e];return!(!s||!s.length)&&s.some((e=>t.indexOf(e)>=0))}_getTestCaseIdsWithTestCaseNameFilter(e,t){let s=t;if(e.hasOwnProperty(i.FilterByFields.TestCaseName)){const t=e[i.FilterByFields.TestCaseName];if(t.values&&t.values.length){const e=t.values[0].toString();s=this._searchForText(e.toLowerCase(),s)}}return s}_searchForText(e,t){const i=new s;if(null===t)for(const t in this._cachedTestCaseRefIdToTitle){const s=parseInt(t);this._doesTestCaseContainSearchText(s,e)&&i.add(s)}else t.forEach((t=>{this._doesTestCaseContainSearchText(t,e)&&i.add(t)}));return i}_doesTestCaseContainSearchText(e,t){return this._cachedTestCaseRefIdToTitle[e].toString().indexOf(t)>=0}_cacheOutcome(e,t,i){this._cachedOutcomeToTestResultIds.hasOwnProperty(e)||(this._cachedOutcomeToTestResultIds[e]=new s),this._cachedOutcomeToTestResultIds[e].add(a._getResultKey(t,i))}_doesRunSatisfyFilter(e,t,s){if(!this._isRunLevelFilterEnable(s))return 0;if(null==e||!(i.FilterByFields.TestCaseName in e)&&!(i.FilterByFields.Tags in e))return 0;let a=!1,r=!1;if(e.hasOwnProperty(i.FilterByFields.Tags)&&t.tags&&t.tags.length){const s=e[i.FilterByFields.Tags];s.values&&s.values.length&&t.tags.some((e=>s.values.indexOf(e)>=0))&&(r=!0)}if(e.hasOwnProperty(i.FilterByFields.TestCaseName)){const s=e[i.FilterByFields.TestCaseName];if(s.values&&s.values.length){const e=s.values[0].toString().toLowerCase();t.groupByValue.name.toLowerCase().indexOf(e)>=0&&(a=!0)}}return r&&a?4:r?2:a?3:1}_isRunLevelFilterEnable(e){return!!(0,o.equals)(e,i.TestResultsGroupPivots.Group_By_Test_Run,!0)}_doesResultSatisfyStageFilter(e,t){if(t&&t.hasOwnProperty(i.FilterByFields.Stages)){const s=t[i.FilterByFields.Stages];if(s.values&&s.values.length){for(let t=0;t<s.values.length;t++)if(this._cachedTestRunIdToStage[+e.testRun.id]===s.values[t].value)return!0;return!1}}return!0}_doesResultSatisfyFilter(e,t,s){let i=null,r=null;return!!this._doesResultSatisfyStageFilter(e,s)&&(0===t||1===t?(i=this._filteredTestCaseRefIdsWithOwnerContainerAndTestCaseName,r=this._filteredTestResultIdsWithOutComeAndTagFilter):2===t?(i=this._filteredTestCaseRefIdsWithOwnerContainerAndTestCaseName,r=this._filteredTestResultIdsWithOutComeFilter):3===t?(i=this._filteredTestCaseRefIdsWithOwnerAndContainer,r=this._filteredTestResultIdsWithOutComeAndTagFilter):(i=this._filteredTestCaseRefIdsWithOwnerAndContainer,r=this._filteredTestResultIdsWithOutComeFilter),null===i&&null===r||null==r&&null!==i&&i.has(e.testCaseReferenceId)||null===i&&null!==r&&r.has(a._getResultKey(parseInt(e.testRun.id),e.id))||null!==i&&null!==r&&i.has(e.testCaseReferenceId)&&r.has(a._getResultKey(parseInt(e.testRun.id),e.id)))}}t[e].TestResultsFilteringManager=a}("StoreFilteringManager"),function(e){k=t.StoreGroupByManager={};t.StoreGroupByManager.TestResultsGroupByManager=class{constructor(){this.resetCache()}resetCache(){this._cachedGroupKeyToResultsForGroups={}}resetShallowFetchedDataInGroupByManager(){let e=this._cachedGroupKeyToResultsForGroups[i.TestResultsGroupPivots.Group_By_Test_Run];e&&e.summaryLoaded&&Object.keys(e.groupSummaryData).forEach((t=>{e.groupSummaryData[t].results=[]})),delete this._cachedGroupKeyToResultsForGroups[i.TestResultsGroupPivots.Group_By_Priority],delete this._cachedGroupKeyToResultsForGroups[i.TestResultsGroupPivots.Group_By_Owner],delete this._cachedGroupKeyToResultsForGroups[i.TestResultsGroupPivots.Group_By_None],delete this._cachedGroupKeyToResultsForGroups[i.TestResultsGroupPivots.Group_By_Container]}populateShallowResult(e){const t=h.TCMContractsConverter.convertShallowTestResultToTestCaseResult(e);this._populateGroupedResultsForEachGroupBy(i.TestResultsGroupPivots.Group_By_Container,e.automatedTestStorage,e,t),this._populateGroupedResultsForEachGroupBy(i.TestResultsGroupPivots.Group_By_Owner,e.owner,e,t),null!=e.priority&&this._populateGroupedResultsForEachGroupBy(i.TestResultsGroupPivots.Group_By_Priority,e.priority.toString(),e,t),null!=e.runId&&this._populateGroupedResultsForEachGroupBy(i.TestResultsGroupPivots.Group_By_Test_Run,e.runId.toString(),e,t),this._populateGroupedResultsForEachGroupBy(i.TestResultsGroupPivots.Group_By_None,"",e,t)}getGroupByResults(e){const t=this._cachedGroupKeyToResultsForGroups[e]?this._cachedGroupKeyToResultsForGroups[e].groupSummaryData:null;if(t){let s=Object.keys(t).map((e=>t[e]));return e===i.TestResultsGroupPivots.Group_By_Test_Run&&this._cacheTestTagSummary&&s.forEach((e=>{const t=A.GroupByPivotHelper.getRunId(e,i.TestResultsGroupPivots.Group_By_Test_Run);this._cacheTestTagSummary.tagsGroupByTestArtifact[t]&&(e.tags=this._cacheTestTagSummary.tagsGroupByTestArtifact[t].map((e=>e.name)))})),{groupByField:e,resultsForGroup:s}}return{groupByField:e,resultsForGroup:[]}}isGroupBySummaryLoaded(e){return this._cachedGroupKeyToResultsForGroups[e]&&this._cachedGroupKeyToResultsForGroups[e].summaryLoaded}populateGroupedResults(e){const t=(0,o.equals)(e.groupByField,i.TestResultsGroupPivots.Group_By_Requirement)||(0,o.equals)(e.groupByField,i.TestResultsGroupPivots.Group_By_Test_Suite);this._cachedGroupKeyToResultsForGroups.hasOwnProperty(e.groupByField)?this._cachedGroupKeyToResultsForGroups[e.groupByField].summaryLoaded=!0:this._cachedGroupKeyToResultsForGroups[e.groupByField]={summaryLoaded:!0,groupSummaryData:{}},e.resultsForGroup.forEach((s=>{const i=this._cachedGroupKeyToResultsForGroups[e.groupByField].groupSummaryData,a=this._getGroupByIdFromGroupedResults(e.groupByField,s);if(i.hasOwnProperty(a))i[a].groupByValue=s.groupByValue,i[a].resultsCountByOutcome=s.resultsCountByOutcome,t&&(i[a].results=s.results);else{let e={groupByValue:s.groupByValue,results:t?s.results:[],resultsCountByOutcome:s.resultsCountByOutcome,tags:s.tags};i[a]=e}}))}updateTagsForTestRun(e){this._cacheTestTagSummary=e}shouldCalculateTotalDuration(e){return e===i.TestResultsGroupPivots.Group_By_Requirement||e===i.TestResultsGroupPivots.Group_By_Test_Run||e===i.TestResultsGroupPivots.Group_By_Test_Suite}_populateGroupedResultsForEachGroupBy(e,t,s,a){this._cachedGroupKeyToResultsForGroups.hasOwnProperty(e)||(this._cachedGroupKeyToResultsForGroups[e]={summaryLoaded:!0,groupSummaryData:{}});const r=this._cachedGroupKeyToResultsForGroups[e].groupSummaryData,o=i.TestOutcomeEnum[s.outcome];if(r.hasOwnProperty(t)){if(r[t].results.push(a),this._shouldCalculateTotalResultCount(e))if(r[t].resultsCountByOutcome.hasOwnProperty(o))r[t].resultsCountByOutcome[o].count+=1;else{const e={count:1,duration:0,outcome:o,rerunResultCount:0};r[t].resultsCountByOutcome[o]=e}}else{let s;if(s=e===i.TestResultsGroupPivots.Group_By_Test_Run?{groupByValue:{id:t},results:[],resultsCountByOutcome:[],tags:[]}:{groupByValue:t,results:[],resultsCountByOutcome:[],tags:[]},s.results.push(a),this._shouldCalculateTotalResultCount(e))if(s.resultsCountByOutcome.hasOwnProperty(o))s.resultsCountByOutcome[o].count+=1;else{const e={count:1,duration:0,outcome:o,rerunResultCount:0};s.resultsCountByOutcome[o]=e}r[t]=s}}_getGroupByIdFromGroupedResults(e,t){let s="";switch(e){case i.TestResultsGroupPivots.Group_By_Test_Run:s=t.groupByValue.id.toString();break;case i.TestResultsGroupPivots.Group_By_Test_Suite:s=t.groupByValue.id.toString();break;case i.TestResultsGroupPivots.Group_By_Requirement:const e=t.groupByValue;parseInt(e.id);s=e.id;break;case i.TestResultsGroupPivots.Group_By_Container:case i.TestResultsGroupPivots.Group_By_Priority:case i.TestResultsGroupPivots.Group_By_None:case i.TestResultsGroupPivots.Group_By_Owner:s=t.groupByValue}return s}_shouldCalculateTotalResultCount(e){return e===i.TestResultsGroupPivots.Group_By_Container||e===i.TestResultsGroupPivots.Group_By_Owner||e===i.TestResultsGroupPivots.Group_By_Priority}}}(),function(e){t[e]={};class s{constructor(e,t,s,i){this._getChildren=e,this._getTreeItem=t,this._map=s,this._uniqueTreeId=i}getChildren(e){return this._getChildren(e,this._uniqueTreeId)}getTreeItem(e){return this._getTreeItem(e)}setTreeListItem(e,t){t.key=e.key,this._map.set(e,t)}getTreeListItem(e){return this._map.get(e)||void 0}getTreeId(){return this._uniqueTreeId}}class a extends g.Store{constructor(e){super(""),this._treeListItemMap=new Map,this._groupsCache=[],this._groupToResultsMap={},this._subResultsCache={},this._resultIdsToBeFetched={},this._resultIdsToBeFetchedCached={},this._groupIdOfRootLevelItems="-1",this._isFirstBatchFetched=!0,this._isAutoFetchComplete=!1,this._uniqueRedrawGridId=(new Date).getTime(),this._tagsForTestRunFF="TestManagement.Server.TagsInTestRun",this._onSelectionChange=e=>{this._state.selectedTreeItems=e,this.emitChanged()},this._onFetchMoreResults=()=>{this._state.showingResultsCount<this._state.fetchedResultsCount&&this._updateResultsAndCurrentState(!0),this._isFirstBatchFetched=!0,this._uniqueRedrawGridId=(new Date).getTime()},this._initializeGroups=e=>{let t=0,s=0;if(this._state.loading=!1,this._state.isInitialized=!0,this._uniqueRedrawGridId=(new Date).getTime(),!e||0===e.resultsForGroup.length)return this._state.endPerfMarker=!0,void this.emitChanged();e.resultsForGroup.forEach((e=>{if(e.resultsCountByOutcome)for(const s in e.resultsCountByOutcome)t+=e.resultsCountByOutcome[s].count;s+=e.results?e.results.length:0})),this._state.failedAbortedCount=s,this._state.totalResultsCount=t,this._groupByManager.populateGroupedResults(e),this._state.isFilteredOrGrouped?this._onFilterChanged(this._state.filterState):(this._initializeGroupDetails(e),this._expandFirstGroupBy()),this._state.endPerfMarker=!0,this._state.errorMessage=null,this._state.warningMessage=null,this.emitChanged()},this._loadStageData=e=>{this._filterManager.populateStageCache(e)},this._onDefaultFilterChanged=e=>{this._state.filterState=e,this._state.loading=!0,this.emitChanged()},this._onTestTagSummaryFetched=e=>{this._groupByManager.updateTagsForTestRun(e),this._groupByField===i.TestResultsGroupPivots.Group_By_Test_Run&&this._groupsCache&&this._groupsCache.length>0&&(this._groupsCache.forEach((t=>{const s=t.runId;s>0&&e.tagsGroupByTestArtifact[s]&&(t.tags=e.tagsGroupByTestArtifact[s].map((e=>e.name)))})),this.emitChanged())},this._onError=e=>{this._state.loading=!1,this._state.errorMessage=e,this._state.endPerfMarker=!0,this.emitChanged()},this._onWarning=e=>{this._state.warningMessage=e,this.emitChanged()},this._cacheGroupedResultsAndUpdateCurrentState=e=>{this._groupByManager.populateGroupedResults(e),this._updateResultsAndCurrentState(!0)},this._onGroupByChanged=e=>{this._groupByField=e,this._state.groupByField=e,this._state.isFilteredOrGrouped=!0,this._state.loading=!0,this._updateResultsAndCurrentState(),this._isFirstBatchFetched=!0,this._handleShallowFetch(),this.emitChanged()},this._onFilterChanged=e=>{this._state.filterState=e,this._state.isFilteredOrGrouped=!0,this._state.loading=!0,this._isFirstBatchFetched=!0,this._updateResultsAndCurrentState(),this._handleShallowFetch(),this.emitChanged()},this._updateGridColumn=e=>{this._state.columnToRender=e,this.emitChanged()},this._cacheShallowResultsAndUpdateCurrentState=e=>{this._cacheShallowResults(e.shallowResults);const t=!!(0,l.isFeatureFlagEnabled)(this._pageContext,i.FeatureFlagConstants.EnableFetchAllResultsUntilMegaBatchSize,!1)&&this._isAutoFetchComplete;this._isFirstBatchFetched||t?(e&&(e.shallowResults&&0!=e.shallowResults.length||1!=e.isResultFetchedFromServer)?this._updateResultsAndCurrentState(!0):(this._state.loading=!1,this.emitChanged()),this._isFirstBatchFetched=!1,this._isAutoFetchComplete=!1):this.emitChanged()},this._sortDataInGridAndToggleState=()=>{this._state.isSortedDescending=!this._state.isSortedDescending,this._state.isFilteredOrGrouped?this._updateResultsToRender():this._sortUnfilterdData(),this._expandFirstGroupBy(),this._uniqueRedrawGridId=(new Date).getTime(),this.emitChanged()},this._onMarkTestResultFlaky=()=>{this.emitChanged()},this._getChildren=(e,t)=>{if(t!==this._uniqueRedrawGridId)return[];if(!e&&this._groupsCache&&this._groupsCache.length>0)return this._expandFirstGroupBy(),this._groupsCache;if(e&&2===e.nodeType&&e.isTestCaseRow)return this._groupToResultsMap[e.groupId]?this._groupToResultsMap[e.groupId]:this._source.getSelectedTestCaseResult(this._artifactData,e.runId,e.resultId?e.resultId:0).then((t=>t?(this._addSubResultsIntoGroupToResultsMap(t,e.groupId,e.isSubResultRow),this._groupToResultsMap[e.groupId]):[]));const s=e?e.groupId:this._groupIdOfRootLevelItems;if(this._groupToResultsMap[s]){if(this._resultIdsToBeFetched[s]&&this._resultIdsToBeFetched[s].length>0){const e={nodeType:3,groupId:s,expanded:!1,runId:0,isTestCaseRow:!0,key:this._generateKey(this._resultIdsToBeFetched[s])};return this._groupToResultsMap[s].concat([e])}return this._groupToResultsMap[s]}const i=this._getNextResultsToBeFetched(s);return 0===i.length?[]:this._source.getTestResultsByQueryForGivenResultIdentifiers(i).then((e=>{if(!e||!e.results||t!==this._uniqueRedrawGridId)return[];if(this._addResultsIntoTestRunToResultsMap(e.results,s),this._resultIdsToBeFetched[s]&&this._resultIdsToBeFetched[s].length>0){const e={nodeType:3,groupId:s,expanded:!1,runId:0,isTestCaseRow:!0,key:this._generateKey(this._resultIdsToBeFetched[s])};return this._groupToResultsMap[s].concat([e])}return this._groupToResultsMap[s]}))},this._getTreeItem=e=>({isExpandable:2==e.nodeType,id:e.groupId?e.groupId.toString():"",defaultIsExpanded:e.expanded,item:e}),this._handleRunLevelResultCap=()=>{this._state.totalResultsCount=this._state.showingResultsCount,this._state.hasMegaFetchStarted||(this._state.failedAbortedCount=this._state.showingResultsCount),0==this._state.showingResultsCount&&(this._state.resultsFound=!1)},this._hideLoadingWhenNoRestCallsMade=()=>{this._state.showLoading=!1,this.emitChanged()},this._pageContext=e.pageContext,this._source=new O.TestResultGridSource(e.pageContext),this._artifactData=e.artifactData,this._state=this._getInitialState(),e.actionHub.initializeTestResults.addListener(this._initializeGroups),e.actionHub.onError.addListener(this._onError),e.actionHub.onWarning.addListener(this._onWarning),e.actionHub.filterChanged.addListener(this._onFilterChanged),e.actionHub.groupedResultsFetched.addListener(this._cacheGroupedResultsAndUpdateCurrentState),e.actionHub.onGroupByChanged.addListener(this._onGroupByChanged),e.actionHub.shallowResultsFetched.addListener(this._cacheShallowResultsAndUpdateCurrentState),e.actionHub.onFetchMoreResults.addListener(this._onFetchMoreResults),e.actionHub.onSelectionChange.addListener(this._onSelectionChange),e.actionHub.onGridColumnChanged.addListener(this._updateGridColumn),e.actionHub.sortDataInGridAndToggleState.addListener(this._sortDataInGridAndToggleState),e.actionHub.onChangedToDefaultFilters.addListener(this._onDefaultFilterChanged),e.actionHub.onTestTagSummaryFetched.addListener(this._onTestTagSummaryFetched),e.actionHub.loadStageData.addListener(this._loadStageData),e.actionHub.onMarkTestResultFlaky.addListener(this._onMarkTestResultFlaky),e.actionHub.handleRunLevelResultCount.addListener(this._handleRunLevelResultCap),e.actionHub.handleRunSummaryCountMismatch.addListener(this._hideLoadingWhenNoRestCallsMade),this._filterManager=new E.TestResultsFilteringManager,this._groupByManager=new k.TestResultsGroupByManager,this._groupByField=i.TestResultsGroupPivots.Group_By_Test_Run}getState(){return this._state}isStageCacheInitialized(){return this._filterManager.isStageCacheInitialized()}getTreeItemProvider(){return this._treeItemProvider&&this._treeItemProvider.getTreeId()===this._uniqueRedrawGridId||(this._treeItemProvider=new s(this._getChildren,this._getTreeItem,this._treeListItemMap,this._uniqueRedrawGridId)),this._treeItemProvider}onFetchMoreElements(e){const t=this._getNextResultsToBeFetched(e);0!==t.length&&this._source.getTestResultsByQueryForGivenResultIdentifiers(t).then((t=>{if(!t||!t.results)return[];this._addResultsIntoTestRunToResultsMap(t.results,e),this._isFirstBatchFetched=!0,this._state.showingResultsCount=this._state.fetchedResultsCount,this._uniqueRedrawGridId=(new Date).getTime(),this.emitChanged()}))}_getInitialState(){return{columnToRender:this._initiallyRenderingColumnList(),loading:!0,endPerfMarker:!1,totalResultsCount:0,fetchedResultsCount:0,showingResultsCount:0,failedAbortedCount:0,isInitialized:!1,viewContext:this._artifactData.viewContext,filterState:c.FilterHelper.getInitialFilterState(),groupByField:i.TestResultsGroupPivots.Group_By_Test_Run,resultsFound:!1,warningMessage:null,errorMessage:null,isFilteredOrGrouped:!1,isSortedDescending:!0,hasMegaFetchStarted:!1,showLoading:!0}}_expandFirstGroupBy(){this._groupsCache&&this._groupsCache.length>0&&(this._groupsCache[0].expanded=!0)}_sortUnfilterdData(){for(const e in this._groupsCache){const t=this._resultIdsToBeFetchedCached[e]?this._resultIdsToBeFetchedCached[e]:[];this._state.isSortedDescending?this._resultIdsToBeFetched[e]=t.sort(d.sortingIdentifierDescending):this._resultIdsToBeFetched[e]=t.sort(d.sortingIdentifierAscending),delete this._groupToResultsMap[e]}this._sortGroupsCache()}_cacheShallowResults(e){if(e&&e.length>0){e.forEach((e=>{this._filterManager.populateCache(e),this._groupByManager.populateShallowResult(e)})),this._state.fetchedResultsCount+=e.length;const t=this._state.fetchedResultsCount<A.FilterSettings.getMegaResultsSize(this._pageContext)&&(this._state.hasMegaFetchStarted?this._state.fetchedResultsCount>=this._state.totalResultsCount:this._state.fetchedResultsCount===this._state.failedAbortedCount),s=(0,l.isFeatureFlagEnabled)(this._pageContext,i.FeatureFlagConstants.EnableFetchAllResultsUntilMegaBatchSize,!1)?A.FilterSettings.getNewShallowResultsBatchSize(this._pageContext):A.Constants.shallowResultsBatchSize;(this._state.fetchedResultsCount>=A.FilterSettings.getMegaResultsSize(this._pageContext)&&this._state.fetchedResultsCount<A.FilterSettings.getMegaResultsSize(this._pageContext)+s||t)&&(this._isAutoFetchComplete=!0)}}_updateResultsAndCurrentState(e=!1){this._groupByManager.isGroupBySummaryLoaded(this._groupByField)&&this._state.fetchedResultsCount>0&&(this._updateResultsToRender(),this._uniqueRedrawGridId=(new Date).getTime(),e&&this.emitChanged())}_updateResultsToRender(){const e=this._groupByManager.getGroupByResults(this._groupByField),t=this._filterManager.filterGroupedResults(e,this._state.filterState);this._initializeGroupDetails(t),this._state.showingResultsCount=this._state.fetchedResultsCount}_initiallyRenderingColumnList(){const e=[];return e.push(i.ColumnIndices.Duration),e.push(i.ColumnIndices.FailingSince),this._artifactData.viewContext===i.ViewContext.Build?e.push(i.ColumnIndices.FailingBuild):this._artifactData.viewContext===i.ViewContext.Release&&e.push(i.ColumnIndices.FailingRelease),(0,l.isFeatureFlagEnabled)(this._pageContext,this._tagsForTestRunFF,!1)&&e.push(i.ColumnIndices.Tags),e}_addSubResultsIntoGroupToResultsMap(e,t,s){let i=[];if(i=s?this._subResultsCache[t]:e.subResults,i&&i)for(let s=i.length-1;s>=0;--s){const a=e,r=i[s],o=this._getResultViewModelFromSubresult(a,t,r);this._groupToResultsMap[t]||(this._groupToResultsMap[t]=[]),this._groupToResultsMap[t].push(o);const n=a.testRun.id.toString()+"."+a.id.toString()+"."+r.id.toString();o.subresults&&(this._subResultsCache[n]=o.subresults)}}_addResultsIntoTestRunToResultsMap(e,t){e.map((e=>{const s=this._getResultViewModelFromTestResult(e,t);this._groupToResultsMap[t]||(this._groupToResultsMap[t]=[]),this._groupToResultsMap[t].push(s),this._state.isSortedDescending?this._groupToResultsMap[t].sort(((e,t)=>d.sortDuration(e.durationInMs,t.durationInMs,!1))):this._groupToResultsMap[t].sort(((e,t)=>d.sortDuration(e.durationInMs,t.durationInMs,!0)))}))}_getResultViewModelFromSubresult(e,t,s){let a=0,r="";const n=this._artifactData;let l=!1;if(e.failingSince&&n)switch(n.viewContext){case i.ViewContext.Build:a=e.failingSince.build?e.failingSince.build.id:0,r=d.getFailingSinceBuildString(n.data.mainData.id,e),l=n.data.mainData.id===e.failingSince.build.id;break;case i.ViewContext.Release:a=e.failingSince.release?e.failingSince.release.id:0,r=d.getFailingSinceReleaseString(n.data.mainData.id,e),l=n.data.mainData.id===e.failingSince.release.id}return{test:s.displayName?s.displayName:(0,o.format)(P.SubResultDisplayName,s.id.toString()),testTitle:s.displayName,storage:e.automatedTestStorage||"",failingSince:e.failingSince?(0,p.ago)(e.failingSince.date):"",failingContextName:r,isNewFailure:!1,runId:parseInt(e.testRun.id),resultId:e.id,testcaseObject:e.testCase,testCaseRefId:e.testCaseReferenceId,failingContextId:a,isTestCaseRow:!0,outcome:i.TestOutcomeEnum[s.outcome],duration:s.durationInMs?h.TCMContractsConverter.ConvertMilliSecondsToReadableFormatForResultSummary(s.durationInMs):h.TCMContractsConverter.ConvertMilliSecondsToReadableFormatForResultSummary(0),dateStarted:s.startedDate?s.startedDate.toLocaleDateString():"",dateCompleted:s.completedDate?s.completedDate.toLocaleDateString():"",owner:e.owner?e.owner.displayName:"",nodeType:null!=s.resultGroupType&&0!==s.resultGroupType?2:1,parentGroupId:t,subresults:s.subResults,groupId:e.testRun.id.toString()+"."+e.id.toString()+"."+s.id.toString(),subResultId:s.id,isSubResultRow:!0,isCurrentArtifact:l,environmentName:e.releaseReference?d.getEnvironmentName(n):""}}_generateKey(e){let t=e[0].toString();const s=e.length;return t=s>A.Constants.pageSize?t.concat(e[A.Constants.pageSize-1].toString()):t.concat(e[s-1].toString()),t.concat("showMore"+(new Date).getTime())}_getResultViewModelFromTestResult(e,t){const s=d.getResultViewModelFromTestResult(e,this._artifactData,t);return s.isUnreliable=this._isTestUnreliable(e.customFields),s.flakyState=this._getFlakyState(e.customFields),s}_initializeGroupDetails(e){const t=e.groupByField;this._resultIdsToBeFetched={},this._resultIdsToBeFetchedCached={},this._groupToResultsMap={},this._groupsCache=[],this._state.resultsFound=!1,this._state.loading=!1,e.resultsForGroup.map(((e,s)=>{if(this._shouldShowGroupDetails(e,this._state.filterState)){let a=this._groupIdOfRootLevelItems;const r=s.toString();if(t){const s=this._getTestGroupDetails(e,t,r);this._groupsCache.push(s),a=r}let o=[];o=this._state.isSortedDescending?e.results.sort(d.sortingComparatorDescending):e.results.sort(d.sortingComparatorAscending),o.map((e=>{const t=new i.TestCaseResultIdentifierWithDuration(parseInt(e.testRun.id),e.id,e.durationInMs);this._resultIdsToBeFetched[a]||(this._resultIdsToBeFetched[a]=[],this._resultIdsToBeFetchedCached[a]=[]),this._resultIdsToBeFetched[a].push(t),this._resultIdsToBeFetchedCached[a].push(t)})),this._state.resultsFound=!0}})),this._sortGroupsCache()}_sortGroupsCache(){this._state.isSortedDescending?this._groupsCache=this._groupsCache.sort(d.sortingTestTreeDataComparerDescending):this._groupsCache=this._groupsCache.sort(d.sortingTestTreeDataComparerAscending)}_shouldShowGroupDetails(e,t){if(e.results.length>0)return!0;return!(!(0,l.isFeatureFlagEnabled)(this._pageContext,"WebAccess.TestManagement.ShowInProgressRunsInInProgressDefaultView",!1)||this._artifactData.status!==i.ViewContextStatus.InProgress||e.groupByValue.state!==i.TestOutcomeEnum[i.TestOutcomeEnum.InProgress])||this._shouldShowAbortedRuns(e,t)}_shouldShowAbortedRuns(e,t){const s=!!e.groupByValue.state&&e.groupByValue.state===i.TestResultsOutcomeFilterPivots.Filter_By_Aborted,a=c.FilterHelper.generateFilterString(t),r=a.indexOf(i.TestResultsOutcomeFilterPivots.Filter_By_Aborted)>0;return!(!s||!r&&!(0,o.equals)(a,"")||!1!==c.FilterHelper.isTagFilterEnabled(t))}_getNextResultsToBeFetched(e){if(!this._resultIdsToBeFetched[e])return[];if(this._resultIdsToBeFetched[e].length>A.Constants.pageSize){return this._resultIdsToBeFetched[e].splice(0,A.Constants.pageSize-1)}const t=this._resultIdsToBeFetched[e];return delete this._resultIdsToBeFetched[e],t}_getRunOutcome(e){let t=-1;const s=e.groupByValue.state;return t=i.TestOutcomeEnum[i.TestOutcomeEnum.InProgress]===s?i.TestOutcomeEnum.InProgress:i.TestOutcomeEnum[i.TestOutcomeEnum.Aborted]===s?i.TestOutcomeEnum.Aborted:e.resultsCountByOutcome[i.TestOutcomeEnum.Failed]&&e.resultsCountByOutcome[i.TestOutcomeEnum.Failed].count>0||!e.resultsCountByOutcome[i.TestOutcomeEnum.Passed]?e.resultsCountByOutcome[i.TestOutcomeEnum.Failed]?i.TestOutcomeEnum.Failed:e.resultsCountByOutcome[i.TestOutcomeEnum.NotImpacted]?i.TestOutcomeEnum.NotImpacted:i.TestOutcomeEnum.Others:i.TestOutcomeEnum.Passed,t}_getTestGroupDetails(e,t,s){let i=0,a=0,r=0;const o=e.results.length,n=this._groupByManager.shouldCalculateTotalDuration(t);for(const t in e.resultsCountByOutcome){const s=e.resultsCountByOutcome[t];i+=s.count,n&&(a+=h.TestReportDataParser.getDurationInMilliseconds(s.duration))}e.groupByValue.completedDate&&e.groupByValue.startedDate&&(r=e.groupByValue.completedDate.getTime()-e.groupByValue.startedDate.getTime());const l=A.GroupByPivotHelper.getPivotValueForGroupValue(e,t);r>0&&(a=r);const u=A.GroupByPivotHelper.getRunId(e,t);let d=-1;0!==u&&(d=this._getRunOutcome(e));return{test:l,isTestCaseRow:!1,duration:n?h.TCMContractsConverter.ConvertMilliSecondsToReadableFormatForResultSummary(a):"",storage:e.groupByValue.storage,expanded:!1,groupId:s,nodeType:2,filteredTestsCount:o,totalTestsCount:i,runId:u,runOutcome:d,durationInMs:a,tags:e.tags}}_isTestUnreliable(e){if(e)for(let t=0;t<e.length;t++){if((0,o.equals)(e[t].fieldName,A.Constants.IsTestResultFlakyField,!0))return!0===e[t].value;if((0,o.equals)(e[t].fieldName,A.Constants.OutcomeConfidenceField,!0))return 0===parseFloat(e[t].value)}return!1}_getFlakyState(e){let t=i.TestResultFlakyState.None;return e&&e.forEach((e=>{(0,o.equals)(e.fieldName,A.Constants.TestResultFlakyStateField,!0)&&(t=Number(e.value))})),t}_handleShallowFetch(){this._state.hasMegaFetchStarted||this._isFilterOutcomeDefault()||(this._groupByManager.resetShallowFetchedDataInGroupByManager(),this._filterManager.resetCache(!0),this._state.fetchedResultsCount=0,this._state.showingResultsCount=0,this._state.hasMegaFetchStarted=!0)}_isFilterOutcomeDefault(){const e=this._state.filterState;return!(!e||!e[i.FilterByFields.Outcome]||2!=e[i.FilterByFields.Outcome].values.length)&&e[i.FilterByFields.Outcome].values.every((e=>e.toString().indexOf(i.TestResultsOutcomeFilterPivots.Filter_By_Failed)>=0||e.toString().indexOf(i.TestResultsOutcomeFilterPivots.Filter_By_Aborted)>=0))}}t[e].TestResultsStore=a}("StoreTestResultsTreeStore"),function(e){t[e]={};t[e].TestResultsListViewActionCreator=class{constructor(e,t,s,i){this._resultsActionHub=e,this._testResultsGridTreeStore=t,this._artifactData=s,this._pageContext=i,this._getTagsummary=!0,this._tagsForTestRunFF="TestManagement.Server.TagsInTestRun",this._source=new O.TestResultGridSource(i)}async initialize(e){const t=i.TestResultsGroupPivots.Group_By_Test_Run,s=c.FilterHelper.generateFilterString(c.FilterHelper.getInitialFilterState()),a=e.status===i.ViewContextStatus.InProgress;return this._artifactData=e,this._source.resetCache(),this._source.getTestResultsByGroupFromDataProvider(e).then((i=>{if(i){if(this._resultsActionHub.initializeTestResults.invoke(i),i.resultsForGroup.length>0&&this._fetchTestTagSummary(e,t),e.runId)return this._source.resetCache(),void this.onFilterChanged(e,c.FilterHelper.getInitialFilterState())}else this._initializeUsingRestApi(t,s,a),r.publishEvent(this._pageContext,this._artifactData,u.featureTestTab_ErrorInResultsGridDataProvider,{DataProviderName:"ms.vss-test-web.test-tab-build-resultdetails-data-provider",error:"No data returned from Dataprovider"})})).catch((e=>{this._initializeUsingRestApi(t,s,a),r.publishEvent(this._pageContext,this._artifactData,u.featureTestTab_ErrorInResultsGridDataProvider,{DataProviderName:"ms.vss-test-web.test-tab-build-resultdetails-data-provider",error:e})}))}onInProgressResults(){const e=i.TestResultsGroupPivots.Group_By_Test_Run;let t=c.FilterHelper.generateFilterString(c.FilterHelper.getInitialFilterState());this._source.resetCache(),this._source.getTestResultsByGroup(this._artifactData,e,t,!0).then((t=>{this._resultsActionHub.initializeTestResults.invoke(t),t&&t.resultsForGroup.length>0&&this._fetchTestTagSummary(this._artifactData,e),this._testResultsGridTreeStore.getState().isFilteredOrGrouped&&this._getShallowTestCaseResultsInBatches("")}),(e=>{this._resultsActionHub.onError.invoke(this._getErrorMessageText(e))}))}onGroupByChanged(e,t){let s=this._testResultsGridTreeStore.getState().hasMegaFetchStarted;this._resultsActionHub.onGroupByChanged.invoke(t),this._handleSourceCache(s),this._artifactData=e,this._source.getTestResultsByGroup(e,t).then((e=>{e&&e.resultsForGroup.length>0&&(this._resultsActionHub.groupedResultsFetched.invoke(e),this._fetchTestTagSummary(this._artifactData,t))}),(e=>{this._resultsActionHub.onError.invoke(this._getErrorMessageText(e))})).then((()=>{this._getShallowTestCaseResultsInBatches(A.Constants.groupByChangedAction)}),(e=>{this._resultsActionHub.onError.invoke(this._getErrorMessageText(e))}))}async onFilterChanged(e,t){if(e.runId){let s=[];s.push(e.runId),t[i.FilterByFields.TestRunId]={values:s}}this._artifactData=e;let s=this._testResultsGridTreeStore.getState().hasMegaFetchStarted;if(this._checkForDefaultFilters(t))this._resultsActionHub.onChangedToDefaultFilters.invoke(t),this._handleDefaultFilters(t);else{if(this._isStageFilterSet(t)&&!this._testResultsGridTreeStore.isStageCacheInitialized()){let t=this._pageContext.getService(n.TestManagementServiceName),s=await t.getTestResultsGroupDetails(+e.data.mainData.id);this._resultsActionHub.loadStageData.invoke(s)}this._resultsActionHub.filterChanged.invoke(t),this._handleSourceCache(s),this._getShallowTestCaseResultsInBatches(A.Constants.filterchangedAction)}let a={OutcomeFilters:t.Outcome,FilterCount:Object.keys(t).length,OwnerFilterApplied:!!t.Owner,ContainerFilterApplied:!!t.AutomatedTestStorage},o=!!t.Tags;a.TagFilterApplied=o,!0===o&&(a.TagFiltersCount=Object.keys(t.Tags).length),r.publishEvent(this._pageContext,this._artifactData,u.featureTestTab_Filter,a)}_initializeUsingRestApi(e,t,s){this._source.getTestResultsByGroup(this._artifactData,e,t,s).then((t=>{this._resultsActionHub.initializeTestResults.invoke(t),console.warn("TestGrid: initializing from REST API"),t&&t.resultsForGroup.length>0&&this._fetchTestTagSummary(this._artifactData,e)}),(e=>{this._resultsActionHub.onError.invoke(this._getErrorMessageText(e))}))}_checkForDefaultFilters(e){return e&&e[i.FilterByFields.Outcome]&&this._testResultsGridTreeStore.getState().groupByField===i.TestResultsGroupPivots.Group_By_Test_Run&&1==Object.keys(e).length&&e[i.FilterByFields.Outcome].values.every((e=>e.toString().indexOf(i.TestResultsOutcomeFilterPivots.Filter_By_Failed)>=0||e.toString().indexOf(i.TestResultsOutcomeFilterPivots.Filter_By_Aborted)>=0))}_isStageFilterSet(e){return!!(e&&e[i.FilterByFields.Stages]&&e[i.FilterByFields.Stages].values&&e[i.FilterByFields.Stages].values.length)}_handleDefaultFilters(e){const t=c.FilterHelper.generateFilterString(e),s=this._artifactData.status===i.ViewContextStatus.InProgress,a=this._testResultsGridTreeStore.getState().groupByField;this._initializeUsingRestApi(a,t,s)}onColumnsChange(e,t){this._artifactData=e,this._resultsActionHub.onGridColumnChanged.invoke(t)}async onFlakyStateChanged(){this._resultsActionHub.onMarkTestResultFlaky.invoke()}onLoadMoreClick(){this._resultsActionHub.onFetchMoreResults.invoke(void 0),this._getShallowTestCaseResultsInBatches(A.Constants.loadMoreAction),this._logTelemetryForLoadMoreClick()}_logTelemetryForLoadMoreClick(){let e=(0,l.isFeatureFlagEnabled)(this._pageContext,i.FeatureFlagConstants.EnableFetchAllResultsUntilMegaBatchSize,!1),t=this._testResultsGridTreeStore.getState(),s=!!(e&&t.fetchedResultsCount<A.FilterSettings.getMegaResultsSize(this._pageContext));r.publishEvent(this._pageContext,this._artifactData,u.featureTestTab_ShowMoreTestResultsAfterFilter,{isAutoFetch:s,megaBatchSize:A.FilterSettings.getMegaResultsSize(this._pageContext),shallowResultsBatchSize:e?A.FilterSettings.getNewShallowResultsBatchSize(this._pageContext):A.Constants.batchResultsSize})}onSelectedItemsChanged(e){this._resultsActionHub.onSelectionChange.invoke(e)}toggleSort(){this._resultsActionHub.sortDataInGridAndToggleState.invoke(void 0)}_handleSourceCache(e){!e&&this._testResultsGridTreeStore.getState().hasMegaFetchStarted&&this._source.resetCache()}_getShallowTestCaseResultsInBatches(e){let t;this._testResultsGridTreeStore.getState().hasMegaFetchStarted||(t=[],t.push(3),t.push(6));let s=this._testResultsGridTreeStore.getState().fetchedResultsCount<=A.FilterSettings.getMegaResultsSize(this._pageContext);s=!!(0,l.isFeatureFlagEnabled)(this._pageContext,i.FeatureFlagConstants.EnableFetchAllResultsUntilMegaBatchSize,!1)&&s,this._source.getShallowTestResultDetails(this._artifactData,e,s,t).then((e=>{if(this._artifactData.runId){const t=this._artifactData.runId;e.shallowResults=e.shallowResults.filter((e=>e.runId==+t))}return this._resultsActionHub.shallowResultsFetched.invoke(e),!!(e.shallowResults&&e.shallowResults.length>0)})).then((e=>{e?this._getShallowTestCaseResultsInBatches(""):(this._artifactData.runId&&this._resultsActionHub.handleRunLevelResultCount.invoke(),this._resultsActionHub.handleRunSummaryCountMismatch.invoke())}),(e=>{this._resultsActionHub.onError.invoke(this._getErrorMessageText(e))}))}_getErrorMessageText(e){return null==e?"":null!=e.message?e.message:null!=e.info?e.info:e.toString()}_fetchTestTagSummary(e,t){this._getTagsummary&&t===i.TestResultsGroupPivots.Group_By_Test_Run&&(0,l.isFeatureFlagEnabled)(this._pageContext,this._tagsForTestRunFF,!1)&&this._source.getTestTagSummary(e).then((t=>{e.status!==i.ViewContextStatus.InProgress&&(this._getTagsummary=!1),t&&t.tagsGroupByTestArtifact&&Object.keys(t.tagsGroupByTestArtifact).length&&this._resultsActionHub.onTestTagSummaryFetched.invoke(t)}),(e=>{this._resultsActionHub.onWarning.invoke("Request for Tags has failed. Please Try Again."),r.publishEvent(this._pageContext,this._artifactData,u.featureTestTab_ErrorInResultsGridDataProvider,{DataProviderName:"ms.vss-test-web.test-tab-build-resultdetails-data-provider",error:"Test Tag API Call failure"})}))}}}("ActionsTestResultsGridActionsCreator"),function(e){x=t[e]={};class s extends y.VssComponent{constructor(e,t,s){super(e,t),this._artifactData=s,this.dontOpenDetailsPaneCssClass="dont-open-detail-pane",this._getTreeRef=e=>{this._treeRef=e},this._handleStoreChange=()=>{this.setState(Object.assign(Object.assign({},this.props.store.getState()),{treeItemProvider:this.props.store.getTreeItemProvider()}))},this._onSelectedItemsChanged=e=>{this.props.actionCreator.onSelectedItemsChanged(e),this._logTelemetryOnSelectionChanged(e)},this._onCellClick=e=>{if(!e||!e.treeItem||!e.treeItem.item)return;this._lastSelectedItemOfGrid=document.activeElement;const t=e.treeItem.item;this._openRightPane(t)},this._onRowDidMount=(e,t)=>{e.treeItem&&e.treeItem.item&&3===e.treeItem.item.nodeType&&this.props.store.onFetchMoreElements(e.treeItem.item.groupId)},this._onLoadMoreClick=e=>{e&&e.preventDefault(),this.props.actionCreator.onLoadMoreClick()},this._sortColumn=(e,t)=>{this.props.actionCreator.toggleSort(),t.isSortedDescending?(0,S.announce)((0,o.localeFormat)(P.DetailedListSortedAsc,P.QueryColumnNameDuration),!0,500):(0,S.announce)((0,o.localeFormat)(P.DetailedListSortedDesc,P.QueryColumnNameDuration),!0,500),r.publishEvent(this.context.pageContext,this.props.artifactData,u.featureTestTab_DurationSorted,{[u.eventClicked]:1})},this._onRenderTagsColumn=(e,t,s)=>e.item&&e.item.tags&&0!==e.item.tags.length?m.createElement(y.WrappedComponent,{dependencies:["ms.vss-test-web.tagsList"],wrappedType:"test-tags-list",context:this.props.artifactData,tags:e.item.tags}):m.createElement("div",null),this._onRenderTestColumn=(e,t,s)=>{if(!e.item)return m.createElement("div",null);const i=e.item,a=this._getOutcomeConfidenceElement(i),r=this._getCountElement(i),o=i.outcome?(0,T.getFriendlyName)(i.outcome):"";return 3===i.nodeType?m.createElement(b.Spinner,{size:"small",ariaLabel:P.LoadingMessage}):m.createElement("div",{className:"test-results-cell flex-row flex-center"},this._getOutcomeIconElement(i,o),m.createElement(D.Tooltip,{text:i.test},m.createElement("span",{className:"clickable-text",onClick:()=>{this._lastSelectedItemOfGrid=document.activeElement,this._openRightPane(i)}},i.test)),a,r)},this._onRenderFailingArtifactColumn=(e,t,s)=>{if(!e.item||!e.item.failingContextName||!e.item.failingContextId)return;let a="",r="";return this.props.artifactData.viewContext===i.ViewContext.Build?(r=u.featureTestTab_BuildLinkClicked,a=this._getBuildUrl(e.item.failingContextId.toString())):(u.featureTestTab_ReleaseLinkClicked,a=this._getReleaseUrl(e.item.failingContextId.toString())),m.createElement("span",{className:"text-ellipsis"},m.createElement(D.Tooltip,{text:e.item.failingContextName},m.createElement("span",null,e.item.isCurrentArtifact?e.item.failingContextName:this._getFailingArtifactLink(a,e.item.failingContextName,r))))},this.state=Object.assign(Object.assign({},this.props.store.getState()),{treeItemProvider:this.props.store.getTreeItemProvider()}),this._performanceService=this.context.pageContext.getService("IVssPerformanceService"),this._markedAsTTI=!1,this._historyService=t.pageContext.getService("IVssHistoryService"),this._broughtBackFocusToSelectedElement=!0}componentDidUpdate(e){this.props.isOnlyRunFetch?this.props.artifactData.runId?this._handleArtifactUpdate(e):(this.props.artifactData.runId=this.runId,this._closeTestResultGridPerfScenario(),this.props.actionCreator.initialize(this.props.artifactData)):this._handleArtifactUpdate(e),0==this.props.isDetailsPanelOpened&&0==this._broughtBackFocusToSelectedElement&&(this.setFocusToLastSelectedItems(),this._broughtBackFocusToSelectedElement=!0)}_handleArtifactUpdate(e){this._closeTestResultGridPerfScenario(),(0,h.hasArtifactChanged)(this.props.artifactData,e.artifactData)&&this.props.actionCreator.initialize(this.props.artifactData)}componentDidMount(){const e=this._historyService.getState();this.runId=e[s.c_runIdKey],this.props.isOnlyRunFetch&&(this.props.artifactData.runId=this.runId),this.props.store.addChangedListener(this._handleStoreChange),this.props.actionCreator.initialize(this.props.artifactData),this._closeTestResultGridPerfScenario()}componentWillUnmount(){this.props.store.removeChangedListener(this._handleStoreChange),this.state.endPerfMarker||this.props.artifactData.contributionSource!==i.ContributionSource.Build&&this.props.artifactData.contributionSource!==i.ContributionSource.Pipeline||this._performanceService.endScenario(i.ViewContext[this.props.artifactData.viewContext],this.props.artifactData.contributionSource,!0,void 0,{aborted:!0,reason:"Component getting unmounted before marking the scenario.",state:this._getArtifactStatus()})}render(){if(!this.props.showTestResultsGrid)return null;1==this.props.isDetailsPanelOpened&&(this._broughtBackFocusToSelectedElement=!1);const e=this.state.hasMegaFetchStarted?this.state.totalResultsCount:this.state.failedAbortedCount;if(this.state.loading)return this._getLoadingSpinner();if(this.state.errorMessage&&""!==this.state.errorMessage)return m.createElement(v.MessageBar,{className:"test-results-grid-error-message-bar",severity:"Error"},this.state.errorMessage);if(!this.state.resultsFound){const t=(0,C.areFilterStatesEqual)(this.state.filterState,c.FilterHelper.getInitialFilterState())&&0===this.state.fetchedResultsCount;return m.createElement("div",{className:"flex-grow"},this.state.showingResultsCount>0&&this.state.showingResultsCount<e&&this.state.showLoading&&this._getFilterMessageBar(this.state.showingResultsCount,e),!t&&this._getNoResultsFoundImage(),t&&this._getNoFailedResultsImage())}return m.createElement(m.Fragment,null,this.state.warningMessage&&""!==this.state.warningMessage&&this._getWarningMessageBar(this.state.warningMessage),this.state.showingResultsCount>0&&this.state.showingResultsCount<e&&this.state.showLoading&&this._getFilterMessageBar(this.state.showingResultsCount,e),m.createElement("div",{className:"flex-grow scroll-auto","data-is-scrollable":!0},m.createElement(M.Tree,{className:"results-tree",columns:this._getColumns(this.state.columnToRender),treeItemProvider:this.state.treeItemProvider,onRowDidMount:this._onRowDidMount,selectionMode:_.SelectionMode.multiple,onSelectedItemsChanged:this._onSelectedItemsChanged,onItemInvoked:this._onCellClick,checkboxVisibility:_.CheckboxVisibility.onHover,ariaLabelForSelectionColumn:P.SelectAll,checkButtonAriaLabel:P.SelectRow,componentRef:this._getTreeRef})))}setFocusToLastSelectedItems(){if(this.state.selectedTreeItems&&1==this.state.selectedTreeItems.length&&this._treeRef){let e=this.state.selectedTreeItems[0].groupId;requestAnimationFrame((()=>this._treeRef.setSelectedItemsById([e]))),this._lastSelectedItemOfGrid&&this._lastSelectedItemOfGrid.parentElement&&this._lastSelectedItemOfGrid.parentElement.scrollIntoView()}}_closeTestResultGridPerfScenario(){if((this.props.artifactData.contributionSource===i.ContributionSource.Build||this.props.artifactData.contributionSource===i.ContributionSource.Pipeline)&&this.state.endPerfMarker&&!this._markedAsTTI){if(this.state.errorMessage)this._performanceService.endScenario(i.ViewContext[this.props.artifactData.viewContext],this.props.artifactData.contributionSource,!0,void 0,{state:this._getArtifactStatus(),aborted:!0,reason:this.state.errorMessage});else{const e=this._performanceService.isFastPageSwitchScenario();this._performanceService.endScenario(i.ViewContext[this.props.artifactData.viewContext],this.props.artifactData.contributionSource,!0,void 0,{state:this._getArtifactStatus(),testsCount:this.state.totalResultsCount,isFPS:e})}this._markedAsTTI=!0}}_getArtifactStatus(){return null==this.props.artifactData.status?"undefined":i.ViewContextStatus[this.props.artifactData.status]}_openRightPane(e){this._shouldShowRightPane(e)&&(this._performanceService.startScenario(R.TestResultDetailsViewLoaded,!1),this.props.onRowClick(e),this._fireWindowResize())}_shouldShowRightPane(e){return 3!==e.nodeType&&!(2===e.nodeType&&!e.runId)}_fireWindowResize(){const e=document.createEvent("Event");e.initEvent("resize",!1,!0),window.dispatchEvent(e)}_logTelemetryOnSelectionChanged(e){if(1==e.length){const t=e[0].outcome;r.publishEvent(this.context.pageContext,this.props.artifactData,u.featureTestTab_TestRowVisited,{TestResultOutcome:t})}let t=0;e.forEach((e=>{t=e.subResultId?t+1:t})),t>0&&r.publishEvent(this.context.pageContext,this.props.artifactData,u.featureResultsListView_SelectionOfHierarchicalResults,{Count:t})}_getLoadingSpinner(){return m.createElement(b.Spinner,{ariaLabel:P.LoadingTestResultDetailsLabel,className:"flex-grow",size:"large",label:P.LoadingTestResultDetailsLabel})}_getNoResultsFoundImage(){const e=(0,I.getAssetLocation)(this.context.pageContext,"ms.vss-test-web/common-content/no-results-image.png"),t=this.state.fetchedResultsCount<this.state.totalResultsCount?P.NoResultsForCurrentSetMessage:P.NoResultsMessage,s=this.state.fetchedResultsCount<this.state.totalResultsCount?P.NoResultsForCurrentSetSuggestionMessage:P.NoResultsSuggestionMessage;return(0,S.announce)(t),m.createElement("div",{className:"no-results-div flex-column flex-center"},m.createElement(B.Image,{className:"no-results-image",src:e,alt:""}),m.createElement("span",{className:"no-results-message"},t),m.createElement("span",{className:"no-results-suggestion"},s))}_getNoFailedResultsImage(){let e,t,s;return this.props.isNoConfigRuns?(e=(0,I.getAssetLocation)(this.context.pageContext,"ms.vss-test-web/common-content/no-config-all-passed.svg"),t=P.NoConfigAllPassedMessage,s=P.NoConfigAllPassedSuggestionMessage):(e=(0,I.getAssetLocation)(this.context.pageContext,"ms.vss-test-web/common-content/no-failed-tests.svg"),t=P.NoFailedResultsMessage,s=P.NoFailedResultsSuggestionMessage),(0,S.announce)(t),m.createElement("div",{className:"no-results-div flex-column flex-center"},m.createElement(B.Image,{className:"no-failed-tests-image",src:e,alt:""}),m.createElement("span",{className:"no-results-message"},t),m.createElement("span",{className:"no-results-suggestion"},s,this.props.isNoConfigRuns&&m.createElement(f.FPSLinkComponent,{className:"test-in-azure-pipeline-link",href:"https://go.microsoft.com/fwlink/?linkid=2056113",telemetrySource:u.featureTestTab_TestInAzurePipelineFwLinkClicked},P.LearnMoreText)))}_getWarningMessageBar(e){return m.createElement(v.MessageBar,{className:"test-results-grid-error-message-bar",severity:"Error"},e)}_getFilterMessageBar(e,t){return(0,l.isFeatureFlagEnabled)(this.context.pageContext,i.FeatureFlagConstants.EnableFetchAllResultsUntilMegaBatchSize,!1)&&this.state.totalResultsCount<=A.FilterSettings.getMegaResultsSize(this.context.pageContext)?m.createElement(v.MessageBar,{className:"load-more-tests-info",iconProps:{}},this._getFetchAllMessageAndLoadingIcon()):m.createElement(v.MessageBar,{className:"load-more-tests-info"},this._getLoadMoreMessage(e,t)," ",this._getNextFilterMessageAndLink())}_getLoadMoreMessage(e,t){const s=0===Object.keys(this.state.filterState).length,i=(0,o.format)(s?P.TestResultsFilterClearedMessage:P.LoadMoreMessage,e,t);return m.createElement("span",null,i)}_getNextFilterMessageAndLink(){const e=0===Object.keys(this.state.filterState).length;return m.createElement(G.Link,{role:"button",className:"load-more-click",onClick:this._onLoadMoreClick,href:"#"},e?P.ShowMoreTestResults:P.FilterMoreTestResults)}_getFetchAllMessageAndLoadingIcon(){const e=m.createElement(b.Spinner,{size:"small",className:"flex-grow"});return m.createElement("span",{className:"flex-row"},e," ",P.FetchingAll)}_getColumns(e){const t=[],s=this._columnEntry(i.ColumnIndices.Test);return s&&t.push(s),e.map((e=>{const s=this._columnEntry(e);s&&t.push(s)})),t}_columnEntry(e){let t;switch(e){case i.ColumnIndices.Test:t={fieldName:P.ResultGridTitle_Test,key:i.ColumnIndices.Test,name:P.ResultGridTitle_Test,ariaLabel:P.ResultGridTitle_Test,minWidth:180,maxWidth:700,isResizable:!0,headerClassName:"testresults-column-header testresults-test",className:"testresults-column-cell testresults-test",columnActionsMode:_.ColumnActionsMode.disabled,onRender:this._onRenderTestColumn};break;case i.ColumnIndices.Duration:t={fieldName:P.QueryColumnNameDuration,key:i.ColumnIndices.Duration,name:P.QueryColumnNameDuration,ariaLabel:P.QueryColumnNameDuration,minWidth:80,maxWidth:200,isResizable:!0,isCollapsable:!0,headerClassName:"testresults-column-header testresults-duration",className:"testresults-column-cell testresults-duration",isSorted:!0,isSortedDescending:this.state.isSortedDescending,columnActionsMode:this.state.loading?_.ColumnActionsMode.disabled:_.ColumnActionsMode.clickable,onColumnClick:e=>{this._sortColumn(e,t)},onRender:(e,t,s)=>this._getElementWithTooltip(e.item?e.item.duration:void 0)};break;case i.ColumnIndices.FailingRelease:t={fieldName:P.ResultGridHeader_FailingRelease,key:i.ColumnIndices.FailingRelease,name:P.ResultGridHeader_FailingRelease,ariaLabel:P.ResultGridHeader_FailingRelease,minWidth:100,isResizable:!0,isCollapsable:!0,headerClassName:"testresults-column-header testresults-failingContext",className:"testresults-column-cell testresults-failingContext",columnActionsMode:_.ColumnActionsMode.disabled,onRender:this._onRenderFailingArtifactColumn};break;case i.ColumnIndices.FailingBuild:t={fieldName:P.ResultGridHeader_FailingBuild,key:i.ColumnIndices.FailingBuild,name:P.ResultGridHeader_FailingBuild,ariaLabel:P.ResultGridHeader_FailingBuild,minWidth:100,isResizable:!0,isCollapsable:!0,headerClassName:"testresults-column-header testresults-failingContext",className:"testresults-column-cell testresults-failingContext",columnActionsMode:_.ColumnActionsMode.disabled,onRender:this._onRenderFailingArtifactColumn};break;case i.ColumnIndices.FailingSince:t={fieldName:P.ResultGridHeader_FailingSince,key:i.ColumnIndices.FailingSince,name:P.ResultGridHeader_FailingSince,ariaLabel:P.ResultGridHeader_FailingSince,minWidth:90,maxWidth:280,isResizable:!0,isCollapsable:!0,headerClassName:"testresults-column-header testresults-failingSince",className:"testresults-column-cell testresults-failingSince",columnActionsMode:_.ColumnActionsMode.disabled,onRender:(e,t,s)=>this._getElementWithTooltip(e.item?e.item.failingSince:void 0)};break;case i.ColumnIndices.Owner:t={fieldName:P.ResultGridHeader_Owner,key:i.ColumnIndices.Owner,name:P.ResultGridHeader_Owner,ariaLabel:P.ResultGridHeader_Owner,minWidth:120,isResizable:!0,isCollapsable:!0,headerClassName:"testresults-column-header testresults-owner",className:"testresults-column-cell testresults-owner",columnActionsMode:_.ColumnActionsMode.disabled,onRender:(e,t,s)=>this._getElementWithTooltip(e.item?e.item.owner:void 0)};break;case i.ColumnIndices.DateStarted:t={fieldName:P.ResultGridHeader_DateStarted,key:i.ColumnIndices.DateStarted,name:P.ResultGridHeader_DateStarted,ariaLabel:P.ResultGridHeader_DateStarted,minWidth:150,isResizable:!0,isCollapsable:!0,headerClassName:"testresults-column-header testresults-date-started",className:"testresults-column-cell testresults-date-started",columnActionsMode:_.ColumnActionsMode.disabled,onRender:(e,t,s)=>this._getElementWithTooltip(e.item?e.item.dateStarted:void 0)};break;case i.ColumnIndices.DateCompleted:t={fieldName:P.ResultGridHeader_DateCompleted,key:i.ColumnIndices.DateCompleted,name:P.ResultGridHeader_DateCompleted,ariaLabel:P.ResultGridHeader_DateCompleted,minWidth:150,isResizable:!0,isCollapsable:!0,headerClassName:"testresults-column-header testresults-date-completed",className:"testresults-column-cell testresults-date-completed",columnActionsMode:_.ColumnActionsMode.disabled,onRender:(e,t,s)=>this._getElementWithTooltip(e.item?e.item.dateCompleted:void 0)};break;case i.ColumnIndices.Tags:t={fieldName:P.ResultGridHeader_Tags,key:i.ColumnIndices.Tags,name:P.ResultGridHeader_Tags,ariaLabel:P.ResultGridHeader_Tags,minWidth:150,isResizable:!0,isCollapsable:!0,headerClassName:"testresults-column-header testresults-tags",className:"testresults-column-cell testresults-tags",columnActionsMode:_.ColumnActionsMode.disabled,onRender:this._onRenderTagsColumn};break;default:return}return t}_getFailingArtifactLink(e,t,s){return m.createElement(f.FPSLinkComponent,{href:e,className:"artifact-url "+this.dontOpenDetailsPaneCssClass,onClick:e=>{r.publishEvent(this.context.pageContext,this._artifactData,s,{[u.eventClicked]:1})},rel:"nofollow noopener noreferrer",telemetrySource:s,telemetryProperties:{[u.eventClicked]:1}},t)}_getOutcomeIconElement(e,t){if(-1===e.runOutcome&&!e.isTestCaseRow)return;let s,i;if(e.outcome)s=(0,T.getIconDetails)(e.outcome),i=(0,T.getFriendlyName)(e.outcome);else{if(!e.runOutcome)return;s=(0,T.getIconDetails)(e.runOutcome),i=(0,T.getFriendlyName)(e.runOutcome)}return m.createElement(G.Link,{role:"tooltip",target:"_blank",className:"outcome-icon",tooltipProps:{text:t}},m.createElement("div",{className:"testresult-outcome-icon"},m.createElement(w.Icon,{iconName:s.iconName,ariaLabel:i,className:s.className})))}_getBuildUrl(e){const t=(0,F.getTFSPageData)(this.context.pageContext),s={};return s.buildId=e,s.project=t&&t.project?t.project.name:"",(0,I.routeUrl)(this.context.pageContext,"ms.vss-build-web.ci-results-hub-route",s)}_getReleaseUrl(e){const t=(0,F.getTFSPageData)(this.context.pageContext),s={};return s.releaseId=e,s.project=t&&t.project?t.project.name:"",(0,I.routeUrl)(this.context.pageContext,"ms.vss-releaseManagement-web.cd-release-progress-default-route",s)}_getOutcomeConfidenceElement(e){return e.isTestCaseRow&&(e.isNewFailure||e.isUnreliable||e.flakyState)?m.createElement("div",{className:"outcome-confidence flex-row flex-center"},e.isNewFailure&&m.createElement("span",{className:"new-failure-indicator"},P.NewFailureIndicator),e.isNewFailure&&e.isUnreliable&&m.createElement("span",{className:"result-indicator-separator"},P.TestIndicatorSeparator),e.isUnreliable&&m.createElement("span",{className:"flaky-result-indicator",style:{textDecoration:e.flakyState===i.TestResultFlakyState.Unmarked?"line-through":"none"}},P.FlakyResultIndicator),(e.isNewFailure||e.isUnreliable)&&e.flakyState===i.TestResultFlakyState.Marked&&m.createElement("span",{className:"result-indicator-separator"},P.TestIndicatorSeparator),e.flakyState===i.TestResultFlakyState.Marked&&m.createElement("span",{className:"marked-flaky-result-indicator"},P.MarkedFlakyResultIndication)):void 0}_getCountElement(e){if(e.isTestCaseRow)return;let t=(0,o.format)("({0}/{1})",e.filteredTestsCount,e.totalTestsCount);return this.state.hasMegaFetchStarted||this.state.groupByField===i.TestResultsGroupPivots.Group_By_Test_Run||this.state.groupByField===i.TestResultsGroupPivots.Group_By_Requirement||this.state.groupByField===i.TestResultsGroupPivots.Group_By_Test_Suite||(t=(0,o.format)("({0})",e.filteredTestsCount)),m.createElement("span",{className:"testresult-group-count"}," ",t," ")}_getElementWithTooltip(e){return m.createElement(D.Tooltip,{overflowOnly:!0,text:e},m.createElement("span",{className:"flex flex-grow text-ellipsis"}," ",e," "))}}t[e].TestResultsTree=s,s.c_runIdKey="runId"}("ComponentsTestResultsGrid"),function(e){t[e]={};class s extends y.VssComponent{constructor(e,t){super(e,t),this.onGroupByChange=e=>{this._actionCreator.onGroupByChanged(this.props.artifactData,e)},this.onFilterChange=e=>{this._actionCreator.onFilterChanged(this.props.artifactData,e)},this.onColumnsChange=e=>{this._actionCreator.onColumnsChange(this.props.artifactData,e)},this.onViewMoreTestsClicked=()=>{this._actionCreator.onInProgressResults()},this._onFlakyStateChanged=()=>{this._actionCreator.onFlakyStateChanged()},this._onViewMoreTestsEnable=()=>{this._actionCreator.initialize(this.props.artifactData),this.props.testResultsLeftViewActionHub.enableViewMoreTests.removeListener(this._onViewMoreTestsEnable)},this._store=this.props.gridStore,this._actionCreator=this.props.gridActionCreator}componentDidMount(){this.props.testResultsLeftViewActionHub.enableViewMoreTests.addListener(this._onViewMoreTestsEnable)}componentWillUnmount(){this.props.testResultsLeftViewActionHub.enableViewMoreTests.removeListener(this._onViewMoreTestsEnable)}render(){return m.createElement("div",{className:"flex-column flex-grow scroll-hidden test-results-left-view"},this.props.showGridComponents&&m.createElement(y.WrappedComponent,{dependencies:["ms.vss-test-web.testResultsGridToolbar"],wrappedType:"test-results-grid-toolbar",context:this.props.artifactData,treeStore:this._store,onGroupByChange:this.onGroupByChange,onFilterChange:this.onFilterChange,onColumnsChange:this.onColumnsChange,onViewMoreTestsClicked:this.onViewMoreTestsClicked,onFlakyStateChange:this._onFlakyStateChanged,parentActionHub:this.props.testResultsLeftViewActionHub,isNoConfigRuns:this.props.isNoConfigRuns}),m.createElement("div",{className:"scroll-auto flex-column flex-grow"},m.createElement(x.TestResultsTree,{artifactData:this.props.artifactData,actionCreator:this._actionCreator,onRowClick:this.props.onGridRowClick,store:this._store,showTestResultsGrid:this.props.showGridComponents,isNoConfigRuns:this.props.isNoConfigRuns,isOnlyRunFetch:this.props.isOnlyRunFetch,isDetailsPanelOpened:this.props.isDetailsPanelOpened})))}}t[e].TestResultsLeftView=s}("ComponentsTestResultLeftView")}),["Resources","Actions/TestResultsGridActionHub","TestResultGridHelper","Sources/TestResultsGridSource","Store/FilteringManager","Store/GroupByManager","Store/TestResultsTreeStore","Actions/TestResultsGridActionsCreator","Components/TestResultsGrid","Components/TestResultLeftView"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-test-web.testResultsGrid"}}));