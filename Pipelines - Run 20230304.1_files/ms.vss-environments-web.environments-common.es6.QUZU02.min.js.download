"use strict";define("Environments/EnvironmentsCommon",["require","exports","DistributedTask/Client/RestClient/TaskAgent","VSS/Platform/Feature","VSS/Platform/Location","Environments/Flux/ActionCreatorBase","Environments/Flux/Store","Environments/Flux/ActionsHubManager","react","VSS/Core/Observable","VSS/Platform/Layout","VSSUI/Dialog","VSSUI/Observer","VSSUI/MessageCard","Environments/Flux/StoreManager"],(function(e,t,n,s,o,i,r,a,u,l,c,d,h,m,g){var v,w,p,_,f,C;v=t.Resources={},t.Resources.CancelButtonText="Cancel",t.Resources.CouldNotAuthenticateAAD="Could not authenticate to Azure Active Directory. If a popup blocker is enabled in the browser, disable it and try again.",t.Resources.EnvironmentSecurity="Environment security",t.Resources.NoPermissionsToManageSecurity="You do not have sufficient permissions to manage environment security.",t.Resources.OkButtonText="OK",t.Resources.DeleteButtonText="Delete",t.Resources.SpnAuthorizationFailedError="Authorization failed",function(e){function n(e,t,n){return function(){if(void 0===n)return t.apply(e,arguments);var s=Array.prototype.slice.call(arguments,0);return n instanceof Array?s=s.concat(n):s.push(n),t.apply(e,s)}}w=t.DelayedFunction={},t.DelayedFunction.delegate=n;t.DelayedFunction.DelayedFunction=class{constructor(e,t,s,o,i){this._invokeOnCooldownComplete=!1,this._interval=t,this._name=s,this._func=n(e,o,i)}start(){var e=this;this._timeoutHandle||(this._timeoutHandle=window.setTimeout((function(){delete e._timeoutHandle;try{e._invoke.call(e)}finally{}}),this._interval))}reset(){this.cancel(),this.start()}cancel(e=!1){this._timeoutHandle&&(window.clearTimeout(this._timeoutHandle),delete this._timeoutHandle),e&&this.clearCooldown(),this._invokeOnCooldownComplete=!1}clearCooldown(e=!0){this._cooldownHandle&&(window.clearTimeout(this._cooldownHandle),delete this._cooldownHandle),!e&&this.invokeOnCooldownComplete&&this.invokeNow()}extendCooldown(){this._startCooldown()}invokeNow(){this.cancel(),this._invoke()}setDelay(e){this._interval=e}setMethod(e,t,s){this._func=n(e,t,s)}isPending(){return!!this._timeoutHandle}isCoolingDown(){return!!this._cooldownHandle}invokeOnCooldownComplete(){this._invokeOnCooldownComplete=!0}_invoke(){this._func(),this._startCooldown()}_startCooldown(){this._cooldownHandle&&window.clearTimeout(this._cooldownHandle),this._cooldownHandle=window.setTimeout((()=>{delete this._cooldownHandle,this._invokeOnCooldownComplete&&(this.invokeNow(),this._invokeOnCooldownComplete=!1)}),this._interval)}}}(),function(e){t.AadAuthorizer={};t.AadAuthorizer.AadAuthorizer=class{constructor(e){this._pageContext=e,this._distributedTaskClient=(0,n.getTaskAgentClient)(e)}getAccessTokenKey(e,t,n,s,o){return new Promise(((n,i)=>{if(s)n(s);else if(e){let s=e.id;void 0===typeof window&&i("");let r=window.location.origin+e.url+"/_admin/_services/completecallbackbyauthcode";null!=o&&(r+="?endpointId="+o+"&projectId="+s),this.authorize(t,r,3,"",!0).then((e=>{n(e)}),(e=>{i(e)}))}else i("")}))}authorize(e,t,n,o,i,r){return new Promise(((a,u)=>{if(this._pageContext.getService("IVssPageService").getData().isDevfabric&&(0,s.isFeatureFlagEnabled)(this._pageContext,"VisualStudio.Services.UseProdAzureResourcesOnDevFabric",!1))return a("");this._getAadOAuthLoginUrl(e,t,n,o,i,r).then((e=>{if(e=e.value||e,this.authWindow=window.open(e,"","width = 960, height = 600, location = true, menubar = false, toolbar = false"),""!==o)return a("");this._pollAuthWindow().then((e=>a(e)),(e=>u(e)))}),(e=>u(e)))}))}_pollAuthWindow(){return new Promise(((e,t)=>{this._monitorAuthProgress=new w.DelayedFunction(this,1e3,"monitorAuthProgress",(()=>{try{if(this.authWindow)if(this.authWindow.closed)t(""),this._cleanupAuthWindow();else try{this.authWindow.vstsaadoauthcompleted?(this.authWindow.vstsaadoautherrormessage?t(this.authWindow.vstsaadoautherrormessage):this.authWindow.vstsaadoauthaccesstokenkey?e(this.authWindow.vstsaadoauthaccesstokenkey):t(v.SpnAuthorizationFailedError),this._cleanupAuthWindow()):this._monitorAuthProgress.reset()}catch(e){this._monitorAuthProgress.reset()}else t(v.CouldNotAuthenticateAAD),this._cleanupAuthWindow()}catch(e){t(e),this._cleanupAuthWindow()}})),this._monitorAuthProgress.start()}))}_cleanupAuthWindow(){if(this.authWindow)try{this.authWindow.close(),this.authWindow=null}catch(e){}this._monitorAuthProgress&&(this._monitorAuthProgress.cancel(),delete this._monitorAuthProgress)}_getAadOAuthLoginUrl(e,t,n,s="",o=!1,i){return i?Promise.resolve(i):this._distributedTaskClient.createAadOAuthRequest(e,t,n,s,o)}}}(),t.Constants={},(C=t.Constants.CommonConstants||(t.Constants.CommonConstants={})).NamespaceId="83d4c2e6-e57d-4d6e-892b-b87222b7ad20",C.NamespaceSeparator="/",C.AdminPermission=8,C.Environment="Environments",t.DateUtils={},t.DateUtils.defaultComparer=function(e,t){return e instanceof Date&&t instanceof Date?e.getTime()-t.getTime():e instanceof Date?1:t instanceof Date?-1:0},function(e){t.GuidUtils={};t.GuidUtils.GuidUtils=class{static newGuid(){var e=(128+Math.floor(64*Math.random())).toString(16);return this.oct(8)+"-"+this.oct(4)+"-4"+this.oct(3)+"-"+e+this.oct(2)+"-"+this.oct(12)}static oct(e){if(!e)return Math.floor(16*Math.random()).toString(16);for(var t="",n=0;n<e;n++)t+=this.oct();return t}}}(),function(e){p=t.Utils={},t.Utils.getErrorMessage=function(e){return e?e.message||e:""};class n{}t.Utils.EnvironmentTabKeys=n,n.EnvironmentResourcesTabKey="resources",n.EnvironmentDeploymentsTabKey="deployments";class s{}t.Utils.ResourceSectionTypes=s,s.Kubernetes="kubernetesSection",s.VmProvider="vmProviderSection",s.newVmProvider="virtualMachineProviderSection",function(e){e.CreateNew="createNew",e.EnvironmentName="name",e.Description="description"}(t.Utils.UrlParamKeys||(t.Utils.UrlParamKeys={}))}(),function(e){function n(e,t,n){const s=r(e);let i=Object.assign({project:s.project},n);!s.team||n.project&&n.project!==s.project||(i.team=s.team);return(0,o.routeUrl)(e,t,i)}function s(e,t){let n=i(e,t);return parseInt(n)}function i(e,t){let n=r(e);return n?n[t]:""}function r(e){return e.getService("IVssNavigationService").getCurrentRoute().routeValues}function a(e,t){const n=e.getService("IVssHistoryService").getState();return n&&n[t]?n[t]:""}t.Link={},t.Link.createUrlForRoute=n,t.Link.getResourceIdFromRoute=function(e){let n=r(e);return n[t.Link.resourceId]?parseInt(n[t.Link.resourceId]):-1},t.Link.getCurrentEnvironmentIdFromRoute=function(e){return s(e,"environmentId")||s(e,"id")},t.Link.getEnvironmentPageUrl=function(e,t,s=p.EnvironmentTabKeys.EnvironmentResourcesTabKey){return n(e,"ms.vss-environments-web.environments-route-with-id",{environmentId:t.toString(),view:s})},t.Link.getEnvironmentsSecurityPageUrl=function(e,t){let s={};return t&&(s.environmentId=t.toString()),n(e,"ms.vss-environments-web.environments-security-default-route",s)},t.Link.getEnvironmentChecksPageUrl=function(e,t){let s={};return t&&(s.environmentId=t.toString()),n(e,"ms.vss-environments-web.environment-checks-default-route",s)},t.Link.getEnvironmentsRunDetailsPageUrl=function(e,t,s,o,i,r){return n(e,"ms.vss-environments-web.environment-rundetails-default-route",{environmentId:t.toString(),environmentExecutionRecordId:s.toString(),ownerId:o.toString(),definitionId:i.toString(),planType:r,view:"jobshistory"})},t.Link.getEnvironmentsPageUrl=function(e){return n(e,"ms.vss-environments-web.environments-default-route",{})},t.Link.getResourcePageUrl=function(e,t,s,o){return n(e,o=o||"ms.vss-environments-web.kubernetes-summary-default-route",{environmentId:t.toString(),resourceId:s.toString()})},t.Link.getRouteValueAsNumber=s,t.Link.getRouteValue=i,t.Link.getRouteValues=r,t.Link.getResourceRoute=function(e){switch(e){case 4:return"ms.vss-environments-web.kubernetes-summary-default-route";case 2:return"ms.vss-environments-web.virtualmachinegroups-summary-default-route";default:return""}},t.Link.getHistoryStateAsNumber=function(e,t){const n=a(e,t);return parseInt(n)},t.Link.getHistoryStateAsString=a,t.Link.resourceId="resourceId"}(),function(e){_=t.MessagesActions={};class n extends i.ActionsHubBase{static getKey(){return"environments-message-bar-actions"}initialize(e){this._addMessage=new i.Action,this._clearMessage=new i.Action}get addMessage(){return this._addMessage}get clearMessage(){return this._clearMessage}}t.MessagesActions.MessagesActions=n}(),function(e){f=t.MessagesStore={};class n extends r.StoreBase{constructor(){super(...arguments),this._addMessage=e=>{this._state[e.key]=e.value,this.emitChanged()},this._clearMessage=e=>{this._state[e]&&delete this._state[e],this.emitChanged()}}static getKey(){return"environments-message-store"}initialize(e){super.initialize(e),this._state={},this._actions=a.ActionsHubManager.GetActionsHub(_.MessagesActions,e),this._actions.addMessage.addListener(this._addMessage),this._actions.clearMessage.addListener(this._clearMessage)}disposeInternal(){this._actions.addMessage.removeListener(this._addMessage),this._actions.clearMessage.removeListener(this._clearMessage)}getMessage(e){return this._state[e]}getMessages(){return this._state}}t.MessagesStore.MessagesStore=n}(),t.Telemetry={},t.Telemetry.publishTelemetry=function(e,t,n,s={}){e.getService("IVssTelemetryService").publishEvent(t,n,s)},function(e){t.DeleteDialog={},t.DeleteDialog.getDeleteDialog=function(e,t){const{id:s,headerText:o,message:i,onOkClick:r}=t,a=e.getService("IVssLayoutManager");s>0&&a.renderCallout((e=>u.createElement(n,{id:s,headerText:o,message:i,onOkClick:r,onDismiss:e})))};class n extends c.VssComponent{render(){const e=this.props,t=new l.ObservableValue(!1),n=new l.ObservableValue(!1),s=new l.ObservableValue(null),o=()=>{t.value=!1,e.onDismiss()};return t.value=!0,u.createElement(h.Observer,{isDialogOpen:t,buttonsDisabled:n,errorMessage:s},(i=>i.isDialogOpen?u.createElement(d.Dialog,{titleProps:{text:e.headerText},footerButtonProps:[{text:v.CancelButtonText,disabled:i.buttonsDisabled,onClick:o},{text:v.DeleteButtonText,disabled:i.buttonsDisabled,primary:!0,onClick:()=>{n.value=!0,e.onOkClick(e.id,(()=>t.value=!1),(e=>{s.value=e,n.value=!1})),e.doNotDismissOnOkClick||(t.value=!1)}}],onDismiss:o},s.value&&u.createElement(m.MessageCard,{severity:"Error",onDismiss:()=>s.value=null},s.value),e.message):null))}}c.Components.add("deleteEnvironmentResourceDialog",n)}(),function(e){t[e]={};class n extends c.VssComponent{constructor(e,t){super(e,t),this.onMessagesStoreChange=()=>{let e=this._messagesStore.getMessages();this.setState({errorMessages:e})},this._instanceId=this.getInstanceId(t),this._messagesStore=g.StoreManager.CreateStore(f.MessagesStore,this._instanceId),this._messagesStore.addChangedListener(this.onMessagesStoreChange),this.state={errorMessages:{}}}componentWillUnmount(){this._messagesStore.removeChangedListener(this.onMessagesStoreChange),this.props.keepMessageStore||g.StoreManager.DeleteStore(f.MessagesStore,this.props.instanceId),super.componentWillUnmount()}getErrorMessageView(e,t){let n=this.getMessage(e);if(n)return u.createElement("div",{className:"margin-bottom"},u.createElement(m.MessageCard,{className:t,severity:"Error",onDismiss:()=>a.ActionsHubManager.GetActionsHub(_.MessagesActions,this._instanceId).clearMessage.invoke(e)},n))}getMessage(e){if(this.state.errorMessages.hasOwnProperty(e))return this.state.errorMessages[e]}}t[e].EnvironmentBaseComponent=n}("EnvironmentBaseComponent")}),["Resources","DelayedFunction","AadAuthorizer","Constants","DateUtils","GuidUtils","Utils","Link","MessagesActions","MessagesStore","Telemetry","DeleteDialog","EnvironmentBaseComponent"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-environments-web.environments-common"}}));