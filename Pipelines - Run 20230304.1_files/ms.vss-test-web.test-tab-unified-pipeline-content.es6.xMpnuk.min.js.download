"use strict";define("Test/TestTabInPipeline",["require","exports","react","VSS/Core/Observable","VSS/Platform/Context","VSS/Platform/Feature","Test/common-util/Common","Test/TestResultsView/Components/TestResultsView","VSSUI/Utilities/ScreenSize"],(function(e,t,s,i,a,r,n,u,o){var l;l=t.Resources={},t.Resources.Loading="Loading",t.Resources.TestTabText="Tests",function(e){t[e]={};class d extends a.VssService{constructor(){super(...arguments),this._showTestTab=()=>{let e=this._getArtifactData(this._contextualData);if(0==this._tabs.value.length){const t=this.pageContext.getService("IVssContributionService");this._checkAndAddTab(e,t,!1)}else this._tab.render=()=>this._getTestResultsView(e)},this._tabs=new i.ObservableArray,this._pipelineSummaryDataProviderId="ms.vss-test-web.test-tab-unifiedPipeline-summary-data-provider",this._buildSummaryDataProviderId="ms.vss-test-web.test-tab-build-summary-data-provider",this._metricsAPIInUnifiedPipeline="WebAccess.TestManagement.UnifiedPipelineMetricsAPI",this._tab={id:"ms.vss-test-web.unified-test-results-tab",name:l.TestTabText,order:2}}getTabs(e,t){let s=!1;if(t){this._contextualData=t;const e=this.pageContext.getService("IVssContributionService");let i=this._getArtifactData(t);if(i.status===n.ViewContextStatus.Completed){if(this._shouldUsePipelineAPi()){const t=e.getData(this._pipelineSummaryDataProviderId);if(t&&t.runSummary&&t.runSummary.totalRunsCount>0)return this._tab.render=()=>this._getTestResultsView(i),[this._tab]}else{const t=e.getData(this._buildSummaryDataProviderId);if(t&&t.totalRunsCount>0)return this._tab.render=()=>this._getTestResultsView(i),[this._tab]}s=!0}this._contextualData.notifyUpdated.subscribe(this._showTestTab),this._checkAndAddTab(i,e,s)}return this._tabs}_serviceEnd(e){this._contextualData.notifyUpdated.unsubscribe(this._showTestTab)}_checkAndAddTab(e,t,s){let i={state:"Completed"};if(s||(i={state:"InProgress"}),this._shouldUsePipelineAPi()){t.getDataAsync(this._pipelineSummaryDataProviderId,i,!0).then((t=>{t&&t.runSummary&&t.runSummary.totalRunsCount>0&&(this._tab.render=()=>this._getTestResultsView(e),this._tabs.push(this._tab))}))}else{t.getDataAsync(this._buildSummaryDataProviderId,i,!0).then((t=>{t&&t.totalRunsCount>0&&(this._tab.render=()=>this._getTestResultsView(e),this._tabs.push(this._tab))}))}}_getTestResultsView(e){return s.createElement(o.ScreenSizeObserver,null,(t=>s.createElement("div",{className:"testtab-pipeline-extension",ref:e=>this._resultsContainerRef=e},s.createElement(u.TestResultsView,{artifactData:e,widthAvailableToRender:this._resultsContainerRef?this._resultsContainerRef.clientWidth:void 0}))))}_getArtifactData(e){const t={id:e.runId.value,sourceBranch:e.sourceBranch.value,repository:{id:e.sourceRepositoryId.value,type:e.sourceRepositoryType.value},definition:{id:e.pipelineId.value},stages:e.stages.value,status:e.status.value},s=this._getPipelineStatus(e.status.value);return{viewContext:n.ViewContext.Build,data:{mainData:t},status:s,contributionSource:n.ContributionSource.Pipeline}}_getPipelineStatus(e){return 1===e?n.ViewContextStatus.InProgress:2===e?n.ViewContextStatus.Completed:n.ViewContextStatus.Others}_shouldUsePipelineAPi(){return(0,r.isFeatureFlagEnabled)(this.pageContext,this._metricsAPIInUnifiedPipeline,!1)}}t[e].TestResultsTabProviderService=d,a.Services.add("test-results-provider-service",{serviceFactory:d})}("ServiceTestResultsTabProviderService")}),["Resources","Service/TestResultsTabProviderService"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-test-web.test-tab-unified-pipeline-content"}}));