"use strict";define("Build/CDPipelinesTab",["require","exports","react","VSS/Platform/Layout","VSSUI/Table","VSSUI/Utilities/Provider","VSSUI/Status","VSSUI/Ago","VSSUI/Card","VSS/Platform/FPS","VSSUI/Dropdown","VSSUI/FilterBar","VSSUI/Utilities/DropdownSelection","Build/Common/Library/Indicator","VSSUI/Utilities/Filter","VSS/Platform/Context","VSS/Core/Observable","VSSUI/Observer","VSS/Core/Util/String"],(function(e,t,s,i,a,n,r,l,u,o,c,d,p,S,h,m,b,_,g){var C,P,D,f;C=t.Resources={},t.Resources.Canceled="Canceled",t.Resources.CDPipelines="Associated pipelines",t.Resources.CDPipelinesLabel="Associated pipelines runs",t.Resources.Failed="Failed",t.Resources.KeywordFilterPlaceholderText="Filter by keywords",t.Resources.On="on",t.Resources.PartiallySucceeded="Partially succeeded",t.Resources.Queued="Queued",t.Resources.RunColumnName="Run",t.Resources.Running="Running",t.Resources.StartTimeColumnName="Start time",t.Resources.State="State",t.Resources.Succeeded="Succeeded",function(e){P=t[e]={};class c extends i.VssComponent{constructor(e){super(e),this._onActivateRow=(e,t)=>{let s=this.context.pageContext.getService("IBuildLinkingService").getBuildUrl(t.data.buildId,"",t.data.projectId);(0,o.onClickFPS)(this.context.pageContext,s,!0,e)},this._renderStartTimeCell=(e,t,i,n)=>s.createElement(a.SimpleTableCell,{columnIndex:t,tableColumn:i,key:"col-"+t},s.createElement("span",{className:"flex-row flex-center text-ellipsis fontWeightSemiBold"},n.startTime&&s.createElement(l.Ago,{date:n.startTime,format:1}))),this._renderRunCell=(e,t,i,n)=>{let l=s.createElement("span",{className:"text-ellipsis primary-text fontWeightSemiBold"},n.commitMessage),u=s.createElement("div",{className:"flex-row flex-center font-size"},s.createElement("span",{className:"font-size text-ellipsis secondary"},"#"+n.buildNumber+" "+C.On+" "+n.definitionName,"   "));return s.createElement(a.TwoLineTableCell,{ariaRowIndex:e,columnIndex:t,tableColumn:i,key:"col-"+t,iconProps:{render:()=>s.createElement(r.Status,Object.assign({},this._statusProps(n.runStatus,n.runResult),{key:n.runResult,size:"24",className:"flex-self-center margin-right-8"}))},line1:l,line2:u})},this._tableColumns=[{id:"run",width:-5,name:C.RunColumnName,renderCell:this._renderRunCell},{id:"start-time",width:-5,name:C.StartTimeColumnName,renderCell:this._renderStartTimeCell}],this._statusProps=(e,t)=>{switch(e){case 32:return Object.assign({},r.Statuses.Waiting);case 1:return Object.assign({},r.Statuses.Running);case 2:switch(t){case 2:return Object.assign({},r.Statuses.Success);case 4:return Object.assign({},r.Statuses.Warning);case 8:return Object.assign({},r.Statuses.Failed);case 32:return Object.assign({},r.Statuses.Canceled)}case 4:return Object.assign({},r.Statuses.Canceled);default:return Object.assign({},r.Statuses.Waiting)}}}render(){return s.createElement(u.Card,{className:"flex-grow bolt-table-card"},s.createElement(a.Table,{className:"cd-pipelines-table-border",ariaLabel:C.CDPipelinesLabel,columns:this._tableColumns,itemProvider:this._getItemProvider(this.props.data),onActivate:this._onActivateRow}))}_getItemProvider(e){const t=e.map((e=>e));return new n.ArrayItemProvider(t)}}t[e].CDPipelinesTabView=c}("ComponentsCDPipelinesTabView"),D=t.Constants={},(t.Constants.RunFilterKeys||(t.Constants.RunFilterKeys={})).StatusFilter="statusFilter",function(e){f=t[e]={};class a extends i.VssComponent{constructor(e,t){super(e,t),this._queuedInfo=(0,S.getStatusIndicatorData)(S.Status.Queued),this._inProgressInfo=(0,S.getStatusIndicatorData)(S.Status.InProgress),this._succeededInfo=(0,S.getStatusIndicatorData)(S.Status.Succeeded),this._warningInfo=(0,S.getStatusIndicatorData)(S.Status.Warning),this._failedInfo=(0,S.getStatusIndicatorData)(S.Status.Failed),this._canceledInfo=(0,S.getStatusIndicatorData)(S.Status.Cancelled),this._stateFilterItems=[{id:S.Status.Queued,text:C.Queued,iconProps:{render:()=>s.createElement(r.Status,Object.assign({},this._queuedInfo.statusProps,{size:"16",animated:!1}))}},{id:S.Status.InProgress,text:C.Running,iconProps:{render:()=>s.createElement(r.Status,Object.assign({},this._inProgressInfo.statusProps,{size:"16",animated:!1}))}},{id:S.Status.Succeeded,text:C.Succeeded,iconProps:{render:()=>s.createElement(r.Status,Object.assign({},this._succeededInfo.statusProps,{size:"16",animated:!1}))}},{id:S.Status.Warning,text:C.PartiallySucceeded,iconProps:{render:()=>s.createElement(r.Status,Object.assign({},this._warningInfo.statusProps,{size:"16",animated:!1}))}},{id:S.Status.Failed,text:C.Failed,iconProps:{render:()=>s.createElement(r.Status,Object.assign({},this._failedInfo.statusProps,{size:"16",animated:!1}))}},{id:S.Status.Cancelled,text:C.Canceled,iconProps:{render:()=>s.createElement(r.Status,Object.assign({},this._canceledInfo.statusProps,{size:"16",animated:!1}))}}],this._onFilterUpdated=()=>{const e=this._filter.getState()[D.RunFilterKeys.StatusFilter],t=e?e.value:"";this.props.updateRunDetailsData(t)},this.onDismiss=()=>{this._filter.reset()},this.statusSelection=new p.DropdownMultiSelection,this._filter=new h.Filter,this._filter.subscribe(this._onFilterUpdated,h.FILTER_APPLIED_EVENT),this._filter.subscribe(this._onFilterUpdated,h.FILTER_RESET_EVENT)}componentDidMount(){super.componentDidMount()}componentWillUnmount(){super.componentWillUnmount()}get filter(){return this._filter}dispose(){this._filter.unsubscribe(this._onFilterUpdated,h.FILTER_APPLIED_EVENT),this._filter.unsubscribe(this._onFilterUpdated,h.FILTER_RESET_EVENT)}render(){return s.createElement("div",{className:"page-content-bottom page-content-top"},s.createElement(d.FilterBar,{filter:this._filter,onDismissClicked:this.onDismiss},s.createElement(c.DropdownFilterBarItem,{filterItemKey:D.RunFilterKeys.StatusFilter,items:this._stateFilterItems,containerClassName:"status-dropdown",placeholder:C.State,selection:this.statusSelection})))}}t[e].CDPipelinesTabFilterBar=a}("ComponentsCDPipelinesTabFilterBar"),function(e){t.ComponentsCDPipelinesTabService={};class i extends m.VssService{constructor(){super(...arguments),this._renderCDPipelines=()=>s.createElement(_.Observer,{data:this._data},(e=>s.createElement("div",null,s.createElement(f.CDPipelinesTabFilterBar,{updateRunDetailsData:this._updateRunDetailsData}),s.createElement(P.CDPipelinesTabView,{data:e.data})))),this._updateCDPipelinesTab=async(e=1e3)=>{var t;this._getRunDetailsData().then((s=>{if(s&&s.length>0&&(s.forEach((e=>{this.runDetails.push(e)})),this._continuationToken=s[s.length-1].buildId,t=s,this._data.value=this.runDetails,t&&t.length==this.paginationLimit&&e>1))return this._updateCDPipelinesTab(e-1);0==this._tabs.length&&this._data.value&&this._data.value.length>0&&this._tabs.push(this._tab)}))},this._getRunDetailsData=()=>new Promise(((e,t)=>{const s={continuationToken:this._continuationToken+"",buildId:this._contextualData.runId.value+"",paginationLimit:this.paginationLimit+""};this.pageContext.getService("IVssContributionService").getDataAsync(this._cdPipelinesDataProviderId,s,!0).then((s=>{s?e(s):t(new Error("cant resolve"))}))})),this._tab={id:"cdPipelines",name:C.CDPipelines,render:this._renderCDPipelines},this._updateRunDetailsData=e=>{var t=[];e.length>0?this.runDetails.map((s=>{var i=this._getStatusString(s.runStatus,s.runResult);e.forEach((e=>{g.equals(i,e,!0)&&t.push(s)}))})):t=this.runDetails,this._data.value=t},this._getStatusString=(e,t)=>{switch(e){case 32:return S.Status.Queued;case 1:return S.Status.InProgress;case 2:switch(t){case 2:return S.Status.Succeeded;case 4:return S.Status.Warning;case 8:return S.Status.Failed;case 32:return S.Status.Cancelled}case 4:return S.Status.Cancelled;default:return S.Status.Warning}},this._data=new b.ObservableValue(void 0),this._tabs=new b.ObservableArray,this._cdPipelinesDataProviderId="ms.vss-build-web.cd-pipelines-runs-details-for-ci-pipeline-run-data-provider",this._continuationToken=2147483647,this.paginationLimit=100,this.runDetails=[]}getTabs(e,t){return t&&t.notifyUpdated&&(this._contextualData=t,this._updateCDPipelinesTab(),this._contextualData.notifyUpdated.subscribe(this._updateCDPipelinesTab)),this._tabs}_serviceEnd(e){this._contextualData&&this._contextualData.notifyUpdated&&this._contextualData.notifyUpdated.unsubscribe(this._updateCDPipelinesTab),super._serviceEnd(e)}}m.Services.add("cd-pipelines-tab-service",{serviceFactory:i})}()}),["Resources","Components/CDPipelinesTabView","Constants","Components/CDPipelinesTabFilterBar","Components/CDPipelinesTabService"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-build-web.cd-pipelines-tab"}}));