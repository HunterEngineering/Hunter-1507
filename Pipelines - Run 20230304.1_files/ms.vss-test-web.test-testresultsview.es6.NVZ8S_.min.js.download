"use strict";define("Test/TestResultsView",["require","exports","VSS/Reflux/Action","VSS/Reflux/Store","react","Test/common-util/Common","Test/common-util/Resources","Test/common-util/Telemetry","Test/common-util/TelemetryConstants","Test/TestResultsGrid/Actions/TestResultsGridActionHub","Test/TestResultsGrid/Actions/TestResultsGridActionsCreator","Test/TestResultsGrid/Components/TestResultLeftView","Test/TestResultsGrid/Store/TestResultsTreeStore","Test/TestSummary/Actions/TestResultsReportActionsHub","Test/TestSummary/Components/Summary","VSS/Platform/Feature","VSS/Platform/Layout","VSS/Platform/Location","VSS/Platform/Util/Url","VSSUI/Button","VSSUI/Components/Splitter/index","VSSUI/Image","VSSUI/Spinner"],(function(e,t,s,i,a,n,r,o,l,u,h,c,d,g,p,m,_,S,f,w,R,b,C){var v,V,D;v=t.Resources={},t.Resources.BuildDoesNotHaveTestReports="No test runs are available for this build. Run tests and get rich reports by using an appropriate built-in task such as the <a class='bolt-link' href='https://go.microsoft.com/fwlink/?linkid=835764' rel='nofollow noopener noreferrer' target='_blank'>Visual Studio Test task</a>. Alternately, run tests using a runner of your choice such as <a class='bolt-link' href='https://junit.org' rel='nofollow noopener noreferrer' target='_blank'>JUnit</a>, <a class='bolt-link' href='https://xunit.github.io/' rel='nofollow noopener noreferrer' target='_blank'>xUnit</a>, <a class='bolt-link' href='https://go.microsoft.com/fwlink/?linkid=2081227' rel='nofollow noopener noreferrer' target='_blank'>mocha, jest, </a><a class='bolt-link' href='https://go.microsoft.com/fwlink/?linkid=2081228' rel='nofollow noopener noreferrer' target='_blank'>pytest, </a><a class='bolt-link' href='https://go.microsoft.com/fwlink/?linkid=2080895' rel='nofollow noopener noreferrer' target='_blank'>rspec, </a>etc. and use the <a class='bolt-link' href='https://go.microsoft.com/fwlink/?LinkId=857107' rel='nofollow noopener noreferrer' target='_blank'>Publish Test Results</a> task to get rich reports.",t.Resources.NoTestResultsMessage="Test results are not yet available.",function(e){V=t[e]={};t[e].TestResultsViewActionHub=class{constructor(){this.openTestResultDetailsView=new s.Action,this.onPivotChagnedInDetailsPane=new s.Action,this.onGridRowClicked=new s.Action}},function(e){e[e.Off=0]="Off",e[e.HalfScreen=1]="HalfScreen",e[e.FullScreen=2]="FullScreen",e[e.MobileView=3]="MobileView"}(t[e].DetailsPaneMode||(t[e].DetailsPaneMode={}))}("ActionsTestResultsViewActionHub"),function(e){D=t[e]={};class s extends i.Store{constructor(e,t,s){super(e),this._testResultSummaryActionHub=t,this._testResultsViewActionHub=s,this._openDetailsPanel=e=>{e.mobileView?this._state.detailsPaneMode=V.DetailsPaneMode.MobileView:this._state.detailsPaneMode=V.DetailsPaneMode.HalfScreen,this._state.selectedTestResultTreeData=e.testResultTreeData,this._state.runId=e.testResultTreeData.runId,this._state.resultId=e.testResultTreeData.resultId,this._state.paneView="debug",this.emitChanged()},this._onSummaryResultsLoaded=e=>{this._state.isLoading=!1,this._state.errorCode=e.errorCode,this._state.errorMessage=e.errorMessage,this._state.isNoConfigRuns=e.isNoConfigRuns,this.emitChanged()},this._openViewWithDetailsMode=e=>{e.isFullscreen?this._state.detailsPaneMode=V.DetailsPaneMode.FullScreen:(this._state.detailsPaneMode=V.DetailsPaneMode.HalfScreen,this._state.onlyRunFetch=!0),this._state.runId=e.runId,this._state.resultId=e.resultId,this._state.paneView=e.paneView,this.emitChanged()},this._onPivotChangedInDetailPane=e=>{this._state.paneView=e,this.emitChanged()},this._setState(),this._testResultsViewActionHub.onGridRowClicked.addListener(this._openDetailsPanel),this._testResultSummaryActionHub.onSummaryLoaded.addListener(this._onSummaryResultsLoaded),this._testResultsViewActionHub.openTestResultDetailsView.addListener(this._openViewWithDetailsMode),this._testResultsViewActionHub.onPivotChagnedInDetailsPane.addListener(this._onPivotChangedInDetailPane)}dispose(){this._testResultsViewActionHub.onGridRowClicked.removeListener(this._openDetailsPanel),this._testResultSummaryActionHub.onSummaryLoaded.removeListener(this._onSummaryResultsLoaded),this._testResultsViewActionHub.openTestResultDetailsView.removeListener(this._openViewWithDetailsMode),this._testResultsViewActionHub.onPivotChagnedInDetailsPane.removeListener(this._onPivotChangedInDetailPane)}getState(){return this._state}_setState(){this._state={detailsPaneMode:V.DetailsPaneMode.Off,isLoading:!0}}}t[e].TestResultsViewStore=s}("StoreTestResultsViewStore"),function(e){t[e]={};const s=()=>a.createElement(C.Spinner,{size:"large",className:"result-detail-panel overlay-right-section"});class i extends _.VssComponent{constructor(e,t){super(e,t),this.onRenderFarElement=()=>{let e=null;return this.state.detailsPaneMode===V.DetailsPaneMode.HalfScreen?e=a.createElement(w.Button,{ref:this._exitOrEnterFullScreenButtonRef,subtle:!0,ariaLabel:r.EnterFullScreenModeText,className:"enter-full-screen",iconProps:{iconName:"FullScreen"},onClick:this._enterDetailsPanelFullScreen,tooltipProps:{showOnFocus:!0,text:r.EnterFullScreenModeText}}):this.state.detailsPaneMode===V.DetailsPaneMode.FullScreen&&(e=a.createElement(w.Button,{ref:this._exitOrEnterFullScreenButtonRef,subtle:!0,ariaLabel:r.ExitFullScreenModeText,className:"exit-full-screen",iconProps:{iconName:"BackToWindow"},onClick:this._exitDetailsPanelFullScreen,tooltipProps:{showOnFocus:!0,text:r.ExitFullScreenModeText}})),a.createElement("div",{className:"result-detail-panel overlay-right-section"},a.createElement("div",{className:"overlay-panel-buttons-container"},(this.state.detailsPaneMode===V.DetailsPaneMode.HalfScreen||this.state.detailsPaneMode===V.DetailsPaneMode.MobileView)&&a.createElement(w.Button,{subtle:!0,ariaLabel:r.CloseDetailsPane,iconProps:{iconName:"Cancel"},onClick:this._closePanel,tooltipProps:{showOnFocus:!0,text:r.CloseDetailsPane}}),e),a.createElement(_.WrappedComponent,{dependencies:["ms.vss-test-web.test-resultdetails","ms.vss-test-web.test-result-details-tab-items"],wrappedType:"test-result-details",testResultTreeData:this.state.selectedTestResultTreeData,runId:this.state.runId,resultId:this.state.resultId,paneView:this.state.paneView,viewContext:this.props.artifactData,isFullScreen:this.state.detailsPaneMode===V.DetailsPaneMode.FullScreen,linkedStackTrace:!0,showHistory:!0,showHeader:!0,isNoConfigRuns:this.state.isNoConfigRuns,loadingComponent:s,onPivotChanged:e=>{this._testResultViewActionHub.onPivotChagnedInDetailsPane.invoke(e)}}))},this._enterDetailsPanelFullScreen=()=>{const e=this._store.getState();e.detailsPaneMode=V.DetailsPaneMode.FullScreen,this.setState(e),o.publishEvent(this.context.pageContext,this.props.artifactData,l.featureTestTab_DetailsPanelFullView,{count:1})},this._exitDetailsPanelFullScreen=()=>{const e=this._store.getState();e.detailsPaneMode=V.DetailsPaneMode.HalfScreen,this.setState(e),this._fireWindowResize()},this._closePanel=()=>{o.publishEvent(this.context.pageContext,this.props.artifactData,l.featureTestTab_DetailsPanelClosed,{count:1});const e=this._store.getState();e.detailsPaneMode=V.DetailsPaneMode.Off,e.paneView="debug",e.runId=void 0,e.resultId=void 0,e.paneView=void 0,this.setState(e),this._pageStateHistoryService&&(this.state.onlyRunFetch||this._pageStateHistoryService.queueValueChange("runId","",0),this._pageStateHistoryService.queueValueChange("resultId","",0),this._pageStateHistoryService.queueValueChange("paneView","",0)),this._fireWindowResize()},this.onRenderNearElement=()=>a.createElement("div",{className:"flex-column overlay-left-section"},a.createElement("div",{className:"test-results-summary-view"},a.createElement(p.Summary,{artifactData:this.props.artifactData,actionsHub:this._summaryActionHub})),a.createElement(c.TestResultsLeftView,{artifactData:this.props.artifactData,onGridRowClick:e=>{this._onGridRowClicked(e)},testResultsLeftViewActionHub:this._testResultsLeftViewActionHub,showGridComponents:!(!this.state.isLoading&&this.state.errorCode),gridActionHub:this._gridActionHub,gridStore:this._gridStore,gridActionCreator:this._gridActionCreator,isNoConfigRuns:this.state.isNoConfigRuns,isOnlyRunFetch:this.state.onlyRunFetch,isDetailsPanelOpened:this.state.detailsPaneMode!==V.DetailsPaneMode.Off})),this._handleStoreChange=()=>{const e=this._store.getState();this.setState(this._store.getState()),this._isReleaseFlow&&this.updateNavigationWithCurrentUrl(),this._pageStateHistoryService&&(this._pageStateHistoryService.queueValueChange("runId",null!=e.runId?`${e.runId}`:"",0),this._pageStateHistoryService.queueValueChange("resultId",null!=e.resultId?`${e.resultId}`:"",0),this._pageStateHistoryService.queueValueChange("paneView",null!=e.paneView?`${e.paneView}`:"",0))},this._projectNavigationWindowWidth=260,this._exitOrEnterFullScreenButtonRef=a.createRef(),this._summaryActionHub=new g.TestResultsReportActionsHub,this._testResultViewActionHub=new V.TestResultsViewActionHub,this._testResultsLeftViewActionHub=new u.TestResultsLeftViewActionHub,this._store=new D.TestResultsViewStore("TestResultsView",this._summaryActionHub,this._testResultViewActionHub),this.state=this._store.getState(),"ms.vss-test-web.test-result-in-release-environment-editor-tab"===this.props.artifactData.contributionSource&&(this._isReleaseFlow=!0),this._pageStateHistoryService=t.pageContext.getService("IPageStateHistoryService"),this._testSignalRHubNotificationSync=new H(this._summaryActionHub,this._testResultsLeftViewActionHub,t.pageContext,this.props.artifactData),this._historyService=t.pageContext.getService("IVssHistoryService"),this.resultsNotAvailableImageResourceName=(0,S.getAssetLocation)(this.context.pageContext,"ms.vss-test-web/common-content/waiting-for-results.png"),this._gridActionHub=new u.TestResultsGridActionsHub,this._gridStore=new d.TestResultsStore({actionHub:this._gridActionHub,artifactData:this.props.artifactData,pageContext:t.pageContext}),this._gridActionCreator=new h.TestResultsListViewActionCreator(this._gridActionHub,this._gridStore,this.props.artifactData,t.pageContext),this.watchForTestResultChanges()}componentDidMount(){this._store.addChangedListener(this._handleStoreChange);const e=this._historyService.getState(),t=e[i.c_resultIdKey],s=e[i.c_runIdKey],a=e[i.c_paneViewKey];if(s&&+s>0){const e={runId:+s,resultId:null!=t?+t:0,paneView:a,isFullscreen:!(0,m.isFeatureFlagEnabled)(this.context.pageContext,n.FeatureFlagConstants.CTUrlSharing,!1)};this._testResultViewActionHub.openTestResultDetailsView.invoke(e);const i={};i.runId=s,t&&(i.resultId=t),a&&(i.paneView=a),o.publishEvent(this.context.pageContext,this.props.artifactData,l.featureTestTab_DetailsDirectLink,i)}this.setState(this._store.getState())}componentDidUpdate(){this.props.artifactData.status===n.ViewContextStatus.InProgress?this.watchForTestResultChanges():this.unwatchForTestResultChanges()}componentWillUnmount(){this._isReleaseFlow?this.resetAndUpdateNavigationWithCurrentUrl():this._pageStateHistoryService&&(this._pageStateHistoryService.queueValueChange("runId","",0),this._pageStateHistoryService.queueValueChange("resultId","",0),this._pageStateHistoryService.queueValueChange("paneView","",0)),this.unwatchForTestResultChanges(),this._store.removeChangedListener(this._handleStoreChange)}static getDerivedStateFromProps(e,t){let s=t;return(s.detailsPaneMode===V.DetailsPaneMode.HalfScreen||s.detailsPaneMode===V.DetailsPaneMode.FullScreen)&&e.widthAvailableToRender&&e.widthAvailableToRender<=i._leftPaneMinWidth+i._rightPaneMinWidth?(s.detailsPaneMode=V.DetailsPaneMode.MobileView,s):null}render(){const e=this.getSplitterProps();return a.createElement(a.Fragment,null,this.state.isLoading&&this._getLoadingSpinner(),this.state.errorCode&&this._getErrorMessageElement(),a.createElement("div",{className:"scroll-hidden test-results-container",ref:e=>this._resultsContainerRef=e},a.createElement(R.Splitter,Object.assign({},e))))}_fireWindowResize(){const e=document.createEvent("Event");e.initEvent("resize",!1,!0),window.dispatchEvent(e)}getSplitterProps(){return this.state.detailsPaneMode==V.DetailsPaneMode.Off?{className:"horizontal test-overlay-panel-component right-fix",fixedElement:1,onRenderNearElement:this.onRenderNearElement,nearElementClassName:"overview-panel scrollable-container",initialFixedSize:this._getInitialWidth()}:this.state.detailsPaneMode>=V.DetailsPaneMode.FullScreen?{className:"horizontal test-overlay-panel-component right-fix",onRenderNearElement:this.onRenderNearElement,fixedElement:1,onRenderFarElement:this.onRenderFarElement,nearElementClassName:"overview-panel scrollable-container hide-left-container",farElementClassName:"details-panel-fullView",minFixedSize:window.innerWidth,disabled:!0}:{className:"horizontal test-overlay-panel-component right-fix",fixedElement:1,onRenderNearElement:this.onRenderNearElement,onRenderFarElement:this.onRenderFarElement,nearElementClassName:"overview-panel scrollable-container",farElementClassName:"details-panel",initialFixedSize:this._getInitialWidth(),minFixedSize:i._rightPaneMinWidth,maxFixedSize:this._getMaxWidth()}}_getInitialWidth(){if(window.innerWidth>=1366)return(window.innerWidth-this._projectNavigationWindowWidth)/2}_getMaxWidth(){if(this._resultsContainerRef)return Math.max(i._rightPaneMinWidth,this._resultsContainerRef.clientWidth-i._leftPaneMinWidth)}_onGridRowClicked(e){let t=!1;this.props.widthAvailableToRender&&this.props.widthAvailableToRender<i._leftPaneMinWidth+i._rightPaneMinWidth&&(t=!0),this._testResultViewActionHub.onGridRowClicked.invoke({testResultTreeData:e,mobileView:t})}_getErrorMessageElement(){return this.props.artifactData.status===n.ViewContextStatus.InProgress&&this._shouldShowWaitingForResultsImage(this.state.errorCode)?this._getInProgressLoadingComponent():this.state.errorMessage?this._getEmptyResultsMessageBar(this.state.errorMessage):this._getEmptyResultsMessageBar(v.BuildDoesNotHaveTestReports)}_getLoadingSpinner(){return a.createElement("div",{className:"flex flex-center justify-center test-results-loading-spinner-div"},a.createElement(C.Spinner,{ariaLabel:r.LoadingTestResultDetailsLabel,className:"testresultsview-loading-spinner",size:"large",label:r.LoadingTestResultDetailsLabel}))}_shouldShowWaitingForResultsImage(e){return!(!e||1!==e&&0!==e)}_getInProgressLoadingComponent(){return a.createElement("div",{className:"flex flex-column flex-center justify-center waiting-for-results-div"},a.createElement(b.Image,{className:"waiting-for-results-image",src:this.resultsNotAvailableImageResourceName}),a.createElement("span",{className:"fontSizeLLL fontWeightNormal waiting-for-results-message"},v.NoTestResultsMessage))}_getEmptyResultsMessageBar(e){return a.createElement("div",{className:"empty-results-div fontSize flex"},a.createElement("span",{className:"empty-results-message-bar",dangerouslySetInnerHTML:{__html:e}}))}resetAndUpdateNavigationWithCurrentUrl(){const e=this.getUrlQueryparams();this._pageStateHistoryService&&(this._pageStateHistoryService.queueValueChange("runId","",0),this._pageStateHistoryService.queueValueChange("resultId","",0),this._pageStateHistoryService.queueValueChange("paneView","",0),this._pageStateHistoryService.queueValueChange("environmentId","",0),this._pageStateHistoryService.queueValueChange("extensionId","",0),this._pageStateHistoryService.queueValueChange("_a","",0),this._pageStateHistoryService.queueValueChange("definitionId","",0)),e.forEach((e=>{"runId"!=e.name&&"resultId"!=e.name&&"paneView"!=e.name&&this._pageStateHistoryService.queueValueChange(e.name,null!=e.value?e.value:"",0)}))}updateNavigationWithCurrentUrl(){this.getUrlQueryparams().forEach((e=>{"runId"!=e.name&&"resultId"!=e.name&&"paneView"!=e.name&&this._pageStateHistoryService.queueValueChange(e.name,null!=e.value?e.value:"",0)}))}getUrlQueryparams(){return new f.Uri(window.location.href).queryParameters}async watchForTestResultChanges(){if(this._testHub)return;if((0,m.isFeatureFlagEnabled)(this.context.pageContext,n.FeatureFlagConstants.InProgressRefreshUsingSignalREnabled,!0)&&this.props.artifactData.status===n.ViewContextStatus.InProgress)try{const e=this.context.pageContext.getService("IVssContributionService");if(await e.getContributionAsync("ms.vss-test-web.test-reporting-signalr"),this._testHub=this.context.pageContext.getService("ITestSignalRHub"),this._testHub){const e=this._getProjectId();if(!e)throw new Error("Unable to get projectId");if(this.props.artifactData.viewContext===n.ViewContext.Build){const t=this.props.artifactData.data.mainData;await this._testHub.initialize(this.context.pageContext,e,this._testSignalRHubNotificationSync),await this._testHub.watchBuild(t.id)}else if(this.props.artifactData.viewContext===n.ViewContext.Release){const t=this.props.artifactData.data.mainData,s=this.props.artifactData.data.subData.environment;await this._testHub.initialize(this.context.pageContext,e,this._testSignalRHubNotificationSync),await this._testHub.watchRelease(t.id,s.id)}console.log("testHub: Successfully connected to Server")}}catch(e){console.warn(`Error occurred while subscribing to testHub signals : ${e}`);const t={};t[l.errorOccurredDuringSignalRConnection]=e,o.publishEvent(this.context.pageContext,this.props.artifactData,l.featureTestTabSignalR,t)}}_getProjectId(){const e=this.context.pageContext.getService("ITfsPageService");if(e){const t=e.getData();if(t&&t.project)return t.project.id}return""}unwatchForTestResultChanges(){if(this._testHub)if(this.props.artifactData.viewContext===n.ViewContext.Build)this._testHub.unwatchBuild(this.props.artifactData.data.mainData.id).then((()=>{this._testHub&&(this._testHub.dispose(),this._testHub=void 0),console.log("testHub: Disconnected from server")})).catch((e=>{console.error(`Error occurred while un-watching build : ${e}`)}));else if(this.props.artifactData.viewContext===n.ViewContext.Release){const e=this.props.artifactData.data.mainData,t=this.props.artifactData.data.subData;this._testHub.unwatchRelease(e.id,t.id).then((()=>{this._testHub&&(this._testHub.dispose(),this._testHub=void 0),console.log("testHub: Disconnected from server")})).catch((e=>{console.error(`Error occurred while un-watching release : ${e}`)}))}}}t[e].TestResultsView=i,i.c_resultIdKey="resultId",i.c_runIdKey="runId",i.c_paneViewKey="paneView",i._rightPaneMinWidth=500,i._leftPaneMinWidth=500;class H{constructor(e,t,s,i){this._summaryActionsHub=e,this._resultsViewActionHub=t,this._pageContext=s,this._artifactData=i}testRunStatsChangedForBuild(e){this._artifactData.data.mainData.id===e&&this._handleTestRunChangeSignal()}testRunStatsChangedForRelease(e,t){this._artifactData.data.mainData.id===e&&this._artifactData.data.subData.environment.id===t&&this._handleTestRunChangeSignal()}_handleTestRunChangeSignal(){console.log("testHub: Received signal from server"),this._summaryActionsHub.refreshTestResultSummary.invoke(void 0),this._resultsViewActionHub.enableViewMoreTests.invoke(void 0),o.publishEvent(this._pageContext,this._artifactData,l.featureTestTab_SignalRRefreshed,{})}}}("ComponentsTestResultsView")}),["Resources","Actions/TestResultsViewActionHub","Store/TestResultsViewStore","Components/TestResultsView"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-test-web.test-testresultsview"}}));