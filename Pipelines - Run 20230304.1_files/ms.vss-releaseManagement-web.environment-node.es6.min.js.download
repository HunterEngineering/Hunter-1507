"use strict";define("Release/EnvironmentNode",["require","exports","VSSUI/Status","react","VSSUI/Util","VSS/Platform/Layout","VSS/Core/Util/String","VSSUI/Utilities/Date","VSSUI/TooltipEx","Release/Helpers/Link","VSSUI/Icon","VSS/Platform/Components/ErrorBoundary"],(function(e,t,n,s,o,a,r,i,d,u,p,l){var c,v,m,h;c=t.Resources={},t.Resources.WaitingOnManualInterventionCreatedOnText="Waiting on manual intervention {0}",t.Resources.ArtifactConditionsNotMetText="Artifact conditions not met",t.Resources.EnvironmentStatusCanceled="Canceled",t.Resources.EnvironmentStatusInProgress="In progress",t.Resources.EnvironmentStatusNotDeployed="Not deployed",t.Resources.EnvironmentStatusPartiallySucceeded="Partially succeeded",t.Resources.EnvironmentStatusQueued="Queued",t.Resources.EnvironmentStatusRejected="Rejected",t.Resources.EnvironmentStatusScheduled="Scheduled",t.Resources.EnvironmentStatusSucceeded="Succeeded",t.Resources.EnvironmentStatusUndefined="Undefined",t.Resources.EnvironmentStatusApprovalPending="Pending approval",t.Resources.EnvironmentStatusCanceling="Canceling...",t.Resources.EnvironmentStatusDeferred="Deferred",t.Resources.EnvironmentStatusFailed="Failed",t.Resources.EnvironmentStatusManualInterventionPending="manual intervention",t.Resources.EnvironmentStatusGates="Processing gates",t.Resources.PendingIntervention="Pending intervention",t.Resources.EnvironmentDeploymentDeferredToText="Deployment will start on {0}",t.Resources.ApprovalPendingOnFormat="approval pending on {0}",t.Resources.YouText="you",function(e){var n;function s(e){if(!e)return null;const t=Math.max(...e.map((e=>e.attempt)));return e.find((e=>e.attempt===t))}v=t.StatusComputer={},function(e){e.Canceled="canceled",e.Canceling="canceling",e.Deferred="deferred",e.Failed="failed",e.InProgress="inprogress",e.PreApprovalPending="preapprovalpending",e.PostApprovalPending="postapprovalpending",e.PreEvaluatingGates="preevaluatinggates",e.PostEvaluatingGates="postevaluatinggates",e.NotDeployed="notdeployed",e.PartiallySucceeded="partiallysucceeded",e.Rejected="rejected",e.Queued="queued",e.Scheduled="scheduled",e.Succeeded="succeeded",e.Undefined="undefined",e.Pending="pending"}(n=t.StatusComputer.ReleaseEnvironmentStatusIndicator||(t.StatusComputer.ReleaseEnvironmentStatusIndicator={})),t.StatusComputer.getComputedStatus=function(e,t){let n;switch(e){case 1:n=a[t];break;case 2:n=r[t];break;case 16:n=i[t]||4}return n||(n=o[e]),n},t.StatusComputer.getStatusInfo=function(e){return d[e]},t.StatusComputer.geComputedStatusToInfoMap=function(){return d},t.StatusComputer.getPendingApprovals=function(e){let t=[];if(e.preDeploymentConditionsInfo&&e.preDeploymentConditionsInfo.approvalInfo){e.preDeploymentConditionsInfo.approvalInfo.approvals.forEach((e=>{1===e.status&&t.push(e)}))}if(e.postDeploymentConditionsInfo&&e.postDeploymentConditionsInfo.approvalInfo){e.postDeploymentConditionsInfo.approvalInfo.approvals.forEach((e=>{1===e.status&&t.push(e)}))}return t},t.StatusComputer.getFirstMIWithStatus=function(e,t){const n=s(e.deploySteps);if(!n)return null;let o=null;return n.releaseDeployPhases.some((e=>2===e.status&&e.manualInterventions.some((e=>e.status===t&&(o=e,!0))))),o},t.StatusComputer.getLatestDeploymentAttempt=s;const o={},a={},r={},i={},d={};o[0]=25,o[1]=7,o[2]=5,o[4]=19,o[8]=8,o[16]=4,function(){let e=a;e[1]=13,e[4]=11,e[2048]=0,e[4096]=0,e[32]=3,e[64]=14,e[16384]=15,e[16]=12,e[8]=5,e[32768]=2,e[65536]=21,e[131072]=22}(),function(){let e=r;e[4]=9,e[8192]=6,e[32768]=2,e[64]=16,e[16384]=17,e[65536]=23,e[131072]=24}(),function(){let e=i;e[2048]=1,e[1024]=20,e[16]=10,e[131072]=24}(),function(){let e=d;e[0]={statusText:c.EnvironmentStatusNotDeployed,statusIndicator:n.NotDeployed},e[1]={statusText:c.EnvironmentStatusFailed,statusIndicator:n.Failed},e[2]={statusText:c.EnvironmentStatusCanceling,statusIndicator:n.Canceling},e[3]={statusText:c.EnvironmentStatusDeferred,statusIndicator:n.Deferred},e[4]={statusText:c.EnvironmentStatusFailed,statusIndicator:n.Failed},e[5]={statusText:c.EnvironmentStatusInProgress,statusIndicator:n.InProgress},e[6]={statusText:c.PendingIntervention,statusIndicator:n.Pending},e[7]={statusText:c.EnvironmentStatusNotDeployed,statusIndicator:n.NotDeployed},e[8]={statusText:c.EnvironmentStatusPartiallySucceeded,statusIndicator:n.PartiallySucceeded},e[9]={statusText:c.EnvironmentStatusApprovalPending,statusIndicator:n.PostApprovalPending},e[10]={statusText:c.EnvironmentStatusFailed,statusIndicator:n.Failed},e[11]={statusText:c.EnvironmentStatusApprovalPending,statusIndicator:n.PreApprovalPending},e[12]={statusText:c.EnvironmentStatusNotDeployed,statusIndicator:n.NotDeployed};let t={statusText:c.EnvironmentStatusQueued,statusIndicator:n.Queued};e[13]=t,e[14]=t,e[15]=t,t={statusText:c.EnvironmentStatusInProgress,statusIndicator:n.InProgress},e[16]=t,e[17]=t,e[18]={statusText:c.EnvironmentStatusScheduled,statusIndicator:n.Scheduled},e[19]={statusText:c.EnvironmentStatusSucceeded,statusIndicator:n.Succeeded},e[20]={statusText:c.EnvironmentStatusFailed,statusIndicator:n.Failed},e[21]={statusText:c.EnvironmentStatusGates,statusIndicator:n.PreEvaluatingGates},e[22]={statusText:c.EnvironmentStatusNotDeployed,statusIndicator:n.NotDeployed},e[23]={statusText:c.EnvironmentStatusGates,statusIndicator:n.PostEvaluatingGates},e[24]={statusText:c.EnvironmentStatusFailed,statusIndicator:n.Failed},e[25]={statusText:c.EnvironmentStatusUndefined,statusIndicator:n.Undefined}}()}(),function(e){function s(e){if(!e||!e.deploySteps||e.deploySteps.length<=0)return 7;const t=(0,v.getLatestDeploymentAttempt)(e.deploySteps);return t?(0,v.getComputedStatus)(t.status||0,t.operationStatus||0):25}m=t.Helpers={},function(e){e[e.Small=0]="Small",e[e.Large=1]="Large"}(t.Helpers.ReleaseEnvironmentTileSize||(t.Helpers.ReleaseEnvironmentTileSize={})),t.Helpers.getStatusText=function(e){const t=s(e);return(0,v.getStatusInfo)(t).statusText},t.Helpers.getIconStatusProps=function(e){const t=o[e];return t||n.Statuses.Queued},t.Helpers.getBorderColorCssPrefix=function(e){const t=s(e);return(0,v.getStatusInfo)(t).statusIndicator},t.Helpers.getComputedStatusForEnvironment=s;const o={[v.ReleaseEnvironmentStatusIndicator.NotDeployed]:n.Statuses.Queued,[v.ReleaseEnvironmentStatusIndicator.InProgress]:n.Statuses.Running,[v.ReleaseEnvironmentStatusIndicator.PreApprovalPending]:n.Statuses.Waiting,[v.ReleaseEnvironmentStatusIndicator.PostApprovalPending]:n.Statuses.Waiting,[v.ReleaseEnvironmentStatusIndicator.PreEvaluatingGates]:n.Statuses.Running,[v.ReleaseEnvironmentStatusIndicator.PostEvaluatingGates]:n.Statuses.Running,[v.ReleaseEnvironmentStatusIndicator.Succeeded]:n.Statuses.Success,[v.ReleaseEnvironmentStatusIndicator.Canceled]:n.Statuses.Canceled,[v.ReleaseEnvironmentStatusIndicator.Canceling]:n.Statuses.Canceled,[v.ReleaseEnvironmentStatusIndicator.Deferred]:n.Statuses.Waiting,[v.ReleaseEnvironmentStatusIndicator.Failed]:n.Statuses.Failed,[v.ReleaseEnvironmentStatusIndicator.Rejected]:n.Statuses.Failed,[v.ReleaseEnvironmentStatusIndicator.Queued]:n.Statuses.Queued,[v.ReleaseEnvironmentStatusIndicator.Scheduled]:n.Statuses.Waiting,[v.ReleaseEnvironmentStatusIndicator.PartiallySucceeded]:n.Statuses.Warning,[v.ReleaseEnvironmentStatusIndicator.Undefined]:n.Statuses.Queued,[v.ReleaseEnvironmentStatusIndicator.Pending]:n.Statuses.Waiting}}(),function(e){h=t.EnvironmentNode={};class p extends a.VssComponent{render(){let e=this.props.environment,t=(0,m.getBorderColorCssPrefix)(e),n=(0,m.getStatusText)(e),a=(0,m.getComputedStatusForEnvironment)(e);const r=[v.ReleaseEnvironmentStatusIndicator.InProgress,v.ReleaseEnvironmentStatusIndicator.PreEvaluatingGates,v.ReleaseEnvironmentStatusIndicator.PostEvaluatingGates].some((e=>e===t));return s.createElement(l,Object.assign({},this.props,{nodeHeight:24,nodeWidth:this.props.nodeWidth,className:(0,o.css)(this.props.className,"active-rel-env-node"),contentClass:(0,o.css)((!!this.props.isLastDeployed||r)&&"highlight"),statusIndicator:t,statusText:n,computedStatus:a}))}}t.EnvironmentNode.EnvironmentNode=p;class l extends a.VssComponent{constructor(){super(...arguments),this._renderTooltipContent=()=>{let e=this._getEnvironmentDescription();return s.createElement("div",{className:"env-summary-node-tooltip-new-plat"},s.createElement("div",null,this.props.environment.name),s.createElement("div",null,e),this.props.showArtifactConditionsNotMetMessage&&s.createElement("div",{className:"tooltip-env-artifact-conditions-not-met-text"},c.ArtifactConditionsNotMetText))},this._onEnvironmentClick=e=>{if(this.props.preventClickOnNode)return;if(this.props.onReleaseFound&&this.props.onReleaseFound(),this._hasPendingApproval&&this.props.onNodeWithApprovalClicked)return void this.props.onNodeWithApprovalClicked();if(this._hasPendingManualIntervention&&this.props.onNodeWithMIClicked)return void this.props.onNodeWithMIClicked();const t=(0,u.createUrlForRoute)(this.context.pageContext,"ms.vss-releaseManagement-web.cd-release-progress-default-route",{_a:"release-environment-logs",releaseId:this.props.environment.release.id.toString(10),environmentId:this.props.environment.id.toString(10),project:this.props.projectId});(0,u.handleEventAndNavigate)(this.context.pageContext,e,t)},this._onEnvironmentNodeKeyDown=e=>{"Enter"!==e.key&&""!==e.key&&"Spacebar"!==e.key||(this._onEnvironmentClick&&this._onEnvironmentClick(e),e.preventDefault(),e.stopPropagation())}}render(){const e="node-description"+this.context.pageContext.getUniqueNumber();return s.createElement(d.Tooltip,{renderContent:this._renderTooltipContent},s.createElement("div",{"data-is-focusable":!0,"data-is-grid-focusable":!0,onClick:this._onEnvironmentClick,onKeyDown:this._onEnvironmentNodeKeyDown,"aria-label":this.props.environment.name,"aria-describedby":e,style:{marginRight:this.props.nodeRightMargin}},s.createElement("div",{className:"hidden",id:e},this._getTooltipDescription()),this._getNodeContent()))}get _hasPendingApproval(){return this.props.pendingApprovals.length>0}get _hasPendingManualIntervention(){return 6===this.props.computedStatus}get _approvalType(){return this._hasPendingApproval?this.props.pendingApprovals[0].approvalType:0}_getNodeContent(){const e={height:this.props.nodeHeight,width:this.props.nodeWidth},t=!(/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor))&&this.props.nodeWidth<45,a=(0,o.css)("env-summary-node-new-plat",this.props.preventClickOnNode?"":"cursor-pointer","env-"+this.props.environment.id,this.props.className);let r=`${this._getStatus()}-env-node`;const i=(0,m.getIconStatusProps)(this.props.statusIndicator);let d=this._hasPendingApproval?`${this._getApprovalClass()}-env-node`:"";return s.createElement("div",{className:a},s.createElement("div",{className:(0,o.css)("node-content flex flex-center ","border",r,d,this.props.contentClass),style:e},s.createElement(n.Status,Object.assign({},i,{size:"12",className:"env-node-icon flex-noshrink"})),s.createElement("div",{className:"node-text overflow-ellipsis",tabIndex:0,role:"button"},t?"...":this.props.environment.name)))}_getStatus(){switch(this.props.statusIndicator){case v.ReleaseEnvironmentStatusIndicator.Canceled:case v.ReleaseEnvironmentStatusIndicator.Canceling:case v.ReleaseEnvironmentStatusIndicator.Failed:case v.ReleaseEnvironmentStatusIndicator.Rejected:return v.ReleaseEnvironmentStatusIndicator.Failed;case v.ReleaseEnvironmentStatusIndicator.InProgress:case v.ReleaseEnvironmentStatusIndicator.PostEvaluatingGates:return v.ReleaseEnvironmentStatusIndicator.InProgress;default:return this.props.statusIndicator}}_getApprovalClass(){return this._hasPendingApproval?1===this._approvalType?"pre-approval":"post-approval":""}_getEnvironmentDescription(){if(this._hasPendingApproval){let e=[];for(const t of this.props.pendingApprovals){const n=this._isApprovalPendingOnMe(t)?c.YouText:t.approver.displayName;e.push(n)}let t=e.join(", ");return(0,r.localeFormat)(c.ApprovalPendingOnFormat,t)}if(this._hasPendingManualIntervention){let e=(0,v.getFirstMIWithStatus)(this.props.environment,1);const t=e&&e.createdOn?(0,i.ago)(e.createdOn):"";return(0,r.localeFormat)(c.WaitingOnManualInterventionCreatedOnText,t)}return this.props.statusText}_getTooltipDescription(){let e="",t=this._getEnvironmentDescription();return e=(0,r.format)("{0} {1}",this.props.environment.name,t),e}_isApprovalPendingOnMe(e){const t=this.context.pageContext.getService("IVssPageService").getData();return!!t&&e.approver.id.toLowerCase()===t.user.id.toLowerCase()}}t.EnvironmentNode.ActiveReleaseEnvironmentNodeContent=l}(),function(e){t.EnvironmentChain={};class n extends a.VssComponent{constructor(e){super(e),this._expandEnvironments=()=>{this.props.onExpandClick(this._getChainWidthOnExpand())},this._onShowMoreButtonKeyPress=e=>{"Enter"!==e.key&&" "!==e.key&&"Spacebar"!==e.key||this._expandEnvironments()}}render(){let e=null;return e=(this.props.visibleEnvCount?this.props.environments.length-this.props.visibleEnvCount:0)>0?this._getEnvironmentsChainWithShowMoreButton():this._getAllEnvironmentsChain(),s.createElement(l.ErrorBoundary,{handlerComponentType:"tfs.page-error-handler"},e)}_getAllEnvironmentsChain(){const e=this._getNodes(this.props.environments);return s.createElement("div",{className:this.props.cssClass}," ",e," ")}_getEnvironmentsChainWithShowMoreButton(){const e=this.props.environments.slice(0,this.props.visibleEnvCount),t=this._getNodes(e);return s.createElement("div",{className:(0,o.css)(this.props.cssClass,"active-rel-env-cell-with-more-button")},t,this._getShowMoreEnvironmentsButton())}_getNodes(e){return e.map((e=>{let t=function(e,t,n,s,o){let a=[];const r=(0,v.getLatestDeploymentAttempt)(e.deploySteps);if(!r||4===r.operationStatus){const t=e=>1===e.status&&e.id&&e.approver;a.push(...(e.preDeployApprovals||[]).filter(t)),a.push(...(e.postDeployApprovals||[]).filter(t))}return{environment:e,pendingApprovals:a,isLastDeployed:t&&t[e.definitionEnvironmentId]===e.release.id,onReleaseFound:n,onNodeWithApprovalClicked:s?()=>s(e.id):void 0,onNodeWithMIClicked:o?()=>o(e.id):void 0}}(e,this.props.definitionEnvironmentCurrentReleaseMap,this.props.onReleaseFound,this.props.onNodeWithApprovalClicked,this.props.onNodeWithMIClicked);return t.nodeWidth=this.props.envNodeWidth?this.props.envNodeWidth:this.props.envNodeMinWidth||42,s.createElement(h.EnvironmentNode,Object.assign({className:this.props.releaseEnvironmentNodeCss,nodeRightMargin:this.props.envNodeRightMargin||10,key:t.environment.id,projectId:this.props.projectId},t,{preventClickOnNode:this.props.preventClickOnNode}))}))}_getShowMoreEnvironmentsButton(){const e=this.props.visibleEnvCount?this.props.environments.length-this.props.visibleEnvCount:0;return s.createElement("div",{onClick:this._expandEnvironments,"data-is-focusable":!0,tabIndex:0,onKeyDown:this._onShowMoreButtonKeyPress,className:"active-release-show-more-button"},s.createElement(p.Icon,{iconName:"Add",className:"active-release-show-more-icon"}),s.createElement("span",null,(0,r.localeFormat)("{0}",e)))}_getChainWidthOnExpand(){return this.props.environments.length*((this.props.envNodeWidth?this.props.envNodeWidth:this.props.envNodeMinWidth||42)+(this.props.envNodeRightMargin||10))+20}}t.EnvironmentChain.EnvironmentsChain=n}()}),["Resources","StatusComputer","Helpers","EnvironmentNode","EnvironmentChain"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-releaseManagement-web.environment-node"}}));