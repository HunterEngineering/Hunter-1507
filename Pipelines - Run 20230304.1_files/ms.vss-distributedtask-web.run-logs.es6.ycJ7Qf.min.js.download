"use strict";define("PipelinesUI",["require","exports","react","VSSUI/Icon","VSS/Core/Observable","VSSUI/Button","VSSUI/Intersection","VSSUI/Measure","VSSUI/Observer","VSSUI/Spinner","VSSUI/Status","VSSUI/TooltipEx","VSSUI/TreeEx","VSSUI/Util","VSSUI/Utilities/TreeItemProvider"],(function(e,t,s,i,n,r,o,l,a,c,h,d,u,g,_){var p,m,f,y,v;p=t.Resources={},t.Resources.Copied="Copied to clipboard",t.Resources.CopyLink="Copy permalink",t.Resources.ExpandGroup="Expand group on line {0}",t.Resources.LogSection="Logs section",t.Resources.SearchKeyword="Type a keyword to search..",function(e){m=t.UtilitiesParser={};t.UtilitiesParser.TimestampRegex=/^.{27}Z /gm,t.UtilitiesParser.BrightClassPostfix=" bright",t.UtilitiesParser.RegexToIdentify=/\u200C/;const s=/(?:\u001b\[)(?:[\?|#])?(?:(?:[0-9]{1,3})?(?:(?:;[0-9]{0,3})*)?[A-Z|a-z])/;t.UtilitiesParser.ansiEscapeCodeRegexString="(?:\\[)(?:[?|#])?(?:(?:[0-9]{1,3})?(?:(?:;[0-9]{0,3})*)?[A-Z|a-z])";const i=/https?\:\/\/([^\]\):\s]*([\]\):](?!\s))*)+/;var n;!function(e){e.Reset="0",e.Bold="22",e.Italic="23",e.Underline="24",e.Fg="39",e.Bg="49"}(n||(n={}));const r={1:"bold",3:"italic",4:"underline"};var o;t.UtilitiesParser.bgColors={40:"b",41:"r",42:"g",43:"y",44:"bl",45:"m",46:"c",47:"w",100:"gr"},t.UtilitiesParser.fgColors={30:"b",31:"r",32:"g",33:"y",34:"bl",35:"m",36:"c",37:"w",90:"gr"},t.UtilitiesParser.plain="plain",t.UtilitiesParser.command="command",t.UtilitiesParser.debug="debug",t.UtilitiesParser.error="error",t.UtilitiesParser.info="info",t.UtilitiesParser.section="section",t.UtilitiesParser.verbose="verbose",t.UtilitiesParser.warning="warning",t.UtilitiesParser.group="group",t.UtilitiesParser.endGroup="endgroup",t.UtilitiesParser.icon="icon",t.UtilitiesParser.commandToType={command:1,debug:2,error:3,info:4,section:5,verbose:6,warning:7,group:8,endgroup:9,icon:10},function(e){e[e.Group=0]="Group",e[e.Icon=1]="Icon"}(o=t.UtilitiesParser.RenderType||(t.UtilitiesParser.RenderType={})),t.UtilitiesParser.commandToRenderType={group:o.Group,icon:o.Icon},t.UtilitiesParser.typeToCommand={0:t.UtilitiesParser.plain,1:t.UtilitiesParser.command,2:t.UtilitiesParser.debug,3:t.UtilitiesParser.error,4:t.UtilitiesParser.info,5:t.UtilitiesParser.section,6:t.UtilitiesParser.verbose,7:t.UtilitiesParser.warning,8:t.UtilitiesParser.group,9:t.UtilitiesParser.endGroup,10:t.UtilitiesParser.icon};const l=[t.UtilitiesParser.command,t.UtilitiesParser.debug,t.UtilitiesParser.error,t.UtilitiesParser.info,t.UtilitiesParser.section,t.UtilitiesParser.verbose,t.UtilitiesParser.warning,t.UtilitiesParser.group,t.UtilitiesParser.endGroup,t.UtilitiesParser.icon];function a(e){let t="";e=e||"";for(let s=0;s<e.length;s++){const i=e.charAt(s);t+="&"===i?"&amp;":"<"===i?"&lt;":">"===i?"&gt;":'"'===i?"&quot;":"'"===i?"&#x27;":"/"===i?"&#x2F;":i}return t}function c(e){return(e||"").toLocaleLowerCase()}t.UtilitiesParser.getType=function(e){return t.UtilitiesParser.typeToCommand[e.type]},t.UtilitiesParser.escape=a,t.UtilitiesParser.getText=c;const h=-1;t.UtilitiesParser.Parser=class{parse(e,t,s,i,n){let r="";return this.getStates(e).forEach((e=>{let o="";const l=e.output;if(e.style){let t=e.style.fg,s=e.style.bg;t&&(o+=`ansifg-${t} `),s&&(o+=`ansibg-${s} `),e.style.bold&&(o+="fontWeightHeavy "),e.style.italic&&(o+=" italic"),e.style.underline&&(o+=" underline")}let a="<span";o&&(a+=` class='${o}'`),n&&(a+=` id='${n}'`),a+=">";let h="",d=-1,u=0,g=[];if(s){const e=s.selectedLine;let t=!1;s.lines.slice(0,100).forEach((s=>{s.line===e&&(t=!0),g.push(s.line)})),e&&!t&&g.push(s.selectedLine)}if(s&&-1!==g.indexOf(t)){const e=s.text;let n=1;const r=c(l);for(;-1!==(d=r.indexOf(c(e),d+1))&&!(n>=50);){const r=l.substring(u,d);r&&(h+=this._escape(r,!1)),u=d+e.length;const o=l.substring(d,u);h+=`<span class="dt-fm ${t===s.selectedLine?"select":""}">`+this._escape(o,!!i)+"</span>",n++}if(u>0&&l.length>u){const e=l.substring(u,l.length);h+=this._escape(e,!1)}1===n&&(h=this._escape(l,!0))}else h=this._getLink(l,i);r+=a+h+"</span>"})),r}parseLines(e,s,i){let n=[],r=[],o=s||0,a=o,c=h,d=!0,u="",g="",_=h;const p=()=>{g="",u=""},m=()=>{c=h},f=()=>{if(-1!==l.indexOf(u)){if(d=!1,m(),_=t.UtilitiesParser.commandToType[u],u===t.UtilitiesParser.section||u===t.UtilitiesParser.group||u===t.UtilitiesParser.endGroup||u===t.UtilitiesParser.command){if(!(e.substring(a,a+29)||"").match(t.UtilitiesParser.TimestampRegex)){const t="##"===e.substring(a,a+2)?4:2;a=a+t+u.length}}u===t.UtilitiesParser.group&&(v=!0),u===t.UtilitiesParser.endGroup&&y&&(x=!0)}p()};let y,v=!1,x=!1,w=i||0;"\n"===e.charAt(o)&&(o+=1,a+=1);for(let s=o;s<e.length;s++){const o=e.charAt(s);if(d=!0,"\n"===o||s===e.length-1){"]"===o&&f();let e={type:_,start:a,end:s,lineIndex:n.length+(i||0)},t=!1;0!==_?(t=!0,v&&(y=e,v=!1),x&&y&&(t=!1,y.isGroup=!0,x=!1,y=void 0)):0===_&&(t=!0),t&&(e.index=w++,r.push(e)),y&&e!==y&&(e.group={lineIndex:y.lineIndex,nodeIndex:y.index}),r.length>0&&n.push({nodes:r}),r=[],a=s+1,m(),_=h,p(),d=!1}else if("#"===o)""!==g&&"#"!==g||(d=!1,g+="#");else if("["===o)("##"===g||0===g.length)&&(d=!1,g+="[");else if("]"===o){if(u===t.UtilitiesParser.icon){let t=s+1,i=t;for(let s=t;s<e.length;s++){if(" "===e[s]){i=s;break}}r.push({type:10,lineIndex:n.length,start:t,end:i,index:w++}),s=i+1,a=s;continue}f()}d&&("##["!==g&&"["!==g||(u+=o.toLowerCase()),u.length>8&&p(),c===h&&(c=a,_===h&&(_=0)))}return n}getStates(e){let i=[];if(!s.test(e))return[{output:e}];let o="",l="",a="",c={},h=!1,d=[];for(let s=0;s<e.length;s++){const u=e[s];h?";"===u?a&&(d.push(a),a=""):"m"===u?(a?(h=!1,d.push(a),c.style=c.style||{},d.forEach((e=>{const s=c.style,i=parseInt(e);t.UtilitiesParser.fgColors[e]?s.fg=t.UtilitiesParser.fgColors[e]:t.UtilitiesParser.bgColors[e]?s.bg=t.UtilitiesParser.bgColors[e]:e===n.Fg?s.fg="":e===n.Bg?s.bg="":i>=91&&i<=97?s.fg=t.UtilitiesParser.fgColors[i-60]+t.UtilitiesParser.BrightClassPostfix:i>=101&&i<=107?s.bg=t.UtilitiesParser.bgColors[i-60]+t.UtilitiesParser.BrightClassPostfix:r[e]?s[r[e]]=!0:e===n.Bold?s.bold=!1:e===n.Italic?s.italic=!1:e===n.Underline&&(s.underline=!1)})),o="",l="",a=""):(h=!1,o=""),d=[]):isNaN(parseInt(u))?(a="",h=!1,o=""):4===a.length?(a="",h=!1,""!==u&&(o="",l+=u)):a+=u:o?""===o&&"["===u&&(h=!0,l&&(c.output=l,i.push(c),c={},l="")):""===u?o=u:l+=u}return l&&(c.output=l+(o||""),i.push(c)),i}_escape(e,t){return t?e:a(e)}_wrapLink(e){return`<a class="is-link" href= ${e}>`+e+"</a>"}_getLink(e,t){const s=e.match(i);if(s){const i=e.split(s[0])[0],n=this._escape(s[0],!!t),r=e.indexOf(s[0])+s[0].length;let o=e.slice(r);return"\n"!==o&&"\r\n"!==o&&(o=this._getLink(o,t)),this._escape(i,!!t)+this._wrapLink(n)+o}return this._escape(e,!!t)}}}(),function(e){f=t[e]={};const n=e=>s.createElement("span",{dangerouslySetInnerHTML:{__html:e.data}});class r extends s.Component{render(){const e=this.props;return s.createElement(s.Fragment,null,e.line.nodes.map((t=>{const r=(e.raw||"").substring(t.start,t.end+1),o=e.subParser.parse(r,e.lineNumber,e.findResult,e.pureHTML,e.contentId);switch(t.type){case 10:return s.createElement("span",{key:t.index},s.createElement(i.Icon,{iconName:r.trim(),className:"line-icon"}));case 8:return s.createElement("span",{key:t.index},s.createElement("span",{className:"group-expand"},s.createElement(i.Icon,{iconName:"TriangleSolidRight12 "+(e.expanded?"rotate":""),className:"group-icon",role:"button",ariaExpanded:!!e.expanded,ariaLabel:e.expanded?"collapse":"expand"}),s.createElement(n,{data:o})));default:return s.createElement("span",{key:t.index,className:`pl-${(0,m.getType)(t)}`},s.createElement(n,{data:o}))}})))}}t[e].LineTransform=r}("ComponentsLogViewerLineTransform"),function(e){y=t.UtilitiesLogParser={};t.UtilitiesLogParser.LogParser=class{constructor(){this._parser=new m.Parser}parse(e,t,s){return this._parser.parseLines(e,t,s)}}}(),function(e){v=t[e]={};const x="data-line",w="data-lsec",L=e=>{const t=e.copy&&e.copy.key===e.sectionKey&&e.copy.line===e.line,n=e.onClick?r.Button:"span";return s.createElement(n,Object.assign({key:e.index,className:(0,g.css)("line-area flex-center flex-row flex-grow justify-start",e.className,e.onClick&&"cursor-pointer"),role:"group"},e.onClick?{onClick:e.onClick}:{}),s.createElement("span",Object.assign({className:"flex-noshrink flex-self-start line","data-lsec":e.sectionKey,"data-line":e.line,role:"treeitem"},e.isSnap?{"data-snap":"1"}:{},e.onCopyLink?{onClick:e.onCopyLink}:{})),e.content&&s.createElement("span",{className:"content"},e.content),e.onCopyLink&&s.createElement(d.Tooltip,{text:t?p.Copied:p.CopyLink},s.createElement("span",{className:"link","data-lsec":e.sectionKey,"data-line":e.line,onClick:e.onCopyLink},s.createElement(i.Icon,{iconName:"Link",className:"fontSizeM"}))))};class b extends s.Component{constructor(e){super(e),this._subParser=new m.Parser,this._container=s.createRef(),this._viewerWidth=new n.ObservableValue(0),this._largestRowWidth=new n.ObservableValue(0),this._findLine=new n.ObservableValue(void 0),this._find=new k,this._findText="",this._scrollPending=!1,this._autoScroll=!0,this._maxHeight=85e5,this._showLog={},this._data={},this._sections={},this._selectionChanged={},this._copyChanged={},this._pending={},this._sectionTreeRef={},this.toHome=()=>{this._noScroll(),this._jump(!0)},this.toEnd=()=>{this._jump()},this._containerKeyDown=e=>{if(this._toSelectAll&&(e.ctrlKey||e.metaKey)&&"a"===e.key){const t=document.querySelector(`[data-sec="${this._toSelectAll}"]`);if(t){const s=window.getSelection(),i=document.createRange();i.selectNodeContents(t),s.removeAllRanges(),s.addRange(i),e.preventDefault()}}},this._getTreeRef=e=>(this._sectionTreeRef[e]||(this._sectionTreeRef[e]=s.createRef()),this._sectionTreeRef[e]),this._bindKeys=e=>{const t=e.target;t&&"INPUT"===t.tagName||("Home"===e.key?(e.preventDefault(),this.toHome()):"End"===e.key&&(e.preventDefault(),this.toEnd()))},this._onMeasureContainer=(e,t)=>{this._viewerWidth.value!==e&&(this._viewerWidth.value=e,this._viewerWidth.value>this._largestRowWidth.value&&(this._largestRowWidth.value=this._viewerWidth.value))},this._onSectionsChanged=e=>{(e.removedItems||[]).forEach((e=>{delete this._showLog[e.key],delete this._data[e.key],delete this._selectionChanged[e.key],delete this._copyChanged[e.key],delete this._sections[e.key]}));const t=e.addedItems||[],s=e.changedItems||[];return this._initializeSections(t.concat(s),!0),t.length>0},this._findFromIndex=(e,t)=>{if(t&&t.length>0)for(let s=0;s<t.length;s++){if(t[s].data.nodes[0].lineIndex===e)return t[s];if(!t[s+1]||t[s+1].data.nodes[0].lineIndex>e)return this._findFromIndex(e,t[s].childItems)}},this._reFind=()=>{this._findText&&requestAnimationFrame((()=>{this._find.find(this._findText,this._getFindProps())}))},this._getFindContent=e=>this._data[e]?this._data[e].value.content:"",this._onFind=e=>{if(e&&e.lines.length>0){const t=e.lines[e.toScrollIndex],s=this._data[t.key]&&this._data[t.key].value;s&&(this._findLine.value={key:t.key,line:t.line},this._scrollPending=!0,s.findResult=e,this._scrollToLine())}else this._findLine.value=void 0,Object.keys(this._showLog).forEach((e=>{let t=Object.assign({},this._data[e].value);t.findResult=void 0,this._data[e].value=t}))},this._onScroll=()=>{const e=this._container.current;if(this._scrollPending)return;let t=!1;if(this._autoScrollLine){const e=this._getTreeRef(this._autoScrollLine.key).current,s=e&&e.getStats();t=this._autoScrollLine.line===(s&&s.lastMaterialized+1)}this._autoScroll=t||!!this._sections&&!!e&&e.scrollHeight-e.offsetHeight-e.scrollTop<25},this._onSnapLineClick=e=>{if(e){const t=e.currentTarget;if(t){e.stopPropagation();const s=t.querySelector(".link");if(s){const e=s.getAttribute(w)||"";this._sections[e].value.isExpanded=!1;const t=parseInt(s.getAttribute(x)||"");this.select(e,t)}}}},this._copyLink=e=>{if(e){const t=e.target.parentElement;let s=t&&t.querySelector(".link");if(s||(s=t),s){e.stopPropagation();const t=s.getAttribute(w)||"",i=parseInt(s.getAttribute(x)||""),n=this.props.sections.value.find((e=>e.key===t));if(n&&n.getLineLink){const e=n.getLineLink(n,i);window.clipboardData&&window.clipboardData.setData("text",e);const s=t=>{t.clipboardData&&t.clipboardData.setData("text",e),t.preventDefault()};document.addEventListener("copy",s);const r=document.execCommand("copy");document.removeEventListener("copy",s),r&&(this._copy={key:t,line:i},this._copyChanged[t].value=!this._copyChanged[t].value,window.history.replaceState(window.history.state,document.title,e))}}}},this._parser=new y.LogParser,this.state={findActive:!1},this._initializeSections(this.props.sections.value)}render(){return s.createElement(a.Observer,{sections:{observableValue:this.props.sections,filter:this._onSectionsChanged},find:this._find.result},(e=>{const t=e.sections;return s.createElement(o.Intersection,null,s.createElement("div",{"aria-label":p.LogSection,className:`pl-reader fontSize ${this.props.className}`,onScroll:this._onScroll,ref:this._container,onKeyDown:this._containerKeyDown},s.createElement(l.Measure,{onMeasure:this._onMeasureContainer},s.createElement("div",{className:"reader-main-content flex-grow"},s.createElement("ol",null,t.map((e=>{const t=e.key;return s.createElement("li",{key:t,"data-sec":t},s.createElement(a.Observer,{findLine:this._find.result,showLog:this._showLog[t],data:this._data[t],section:this._sections[t],largestRowWidth:this._largestRowWidth,viewerWidth:this._viewerWidth},(e=>{const i=e.section,n=e.data.lines||[],o=e.data.lines||[],l=e.showLog&&o.length>0,c=!(!this._showLog[t]||!this._showLog[t].value||0!=o.length),d=i.hasData||n.length>0,p=i.statusProps&&i.statusProps===h.Statuses.Failed;let m;const y=e.findLine;if(y){if(y.markers[t]){m=Object.assign({},y),m.lines=y.lines;const e=y.lines[y.toScrollIndex];e&&e.key===t&&(m.selectedLine=e.line)}}const v=t+"-log",x=e.largestRowWidth<=e.viewerWidth?"100%":`${e.largestRowWidth}px`;let w=e.viewerWidth-50;return s.createElement("div",{className:(0,g.css)("flex-column content-area",i.getLineLink&&"linkable",i.className),style:{width:x}},s.createElement("div",{className:"flex-row sec-sticky"},s.createElement(r.Button,Object.assign({className:(0,g.css)("flex flex-row sec-area",d&&"cursor-pointer",l&&"expand",i.hidden&&"hide"),ariaControls:v,disabled:!d,ariaExpanded:l},d?{onClick:e=>this._onToggleLog(t)}:{}),s.createElement("div",{className:"status-area flex flex-grow",style:{width:w+"px"}},s.createElement("div",{className:"flex-grow flex-self-center flex flex-row sec-content"},s.createElement(P,{iconProps:i.iconProps,statusProps:i.statusProps,spinner:c,noStatusFaint:p}),s.createElement("span",{className:"title text-ellipsis body-m"},i.title)),i.getFarRight&&s.createElement("div",{className:"far-right body-s flex-self-center"},i.getFarRight(i)))),s.createElement("div",{className:"flex-row flex-grow"})),s.createElement(u.FixedHeightTree,{id:v,className:(0,g.css)(!l&&"hide"),focuszoneProps:{activateOnEnter:!!i.getLineLink},itemProvider:l?e.data.treeProvider:new _.TreeItemProvider([]),maxHeight:this._maxHeight,onToggle:(t,s)=>{s.underlyingItem.childItems&&e.data.treeProvider&&!t.defaultPrevented&&(e.data.treeProvider.toggle(s.underlyingItem),t.preventDefault())},pageSize:60,renderLoadingRow:(t,i)=>{const n=e.section.asyncInfo;return n?(n.getMore(n.payload),s.createElement("div",{className:"flex-row flex-grow"},s.createElement("div",{className:"shimmer shimmer-line log-async-loading"}))):s.createElement("div",null)},renderRow:(n,r,o)=>s.createElement(a.Observer,{findResult:this._find.result,x:this._copyChanged[t]},(o=>{const l=n+1,a=this._selection&&this._selection.key===t&&this._selection.lineToScroll===l,c=this._copy&&this._copy.line===l,h=a||c?"highlight":"",d=o.findResult;let u;if(d){if(d.markers[t]){u=Object.assign({},d),u.lines=d.lines;const e=d.lines[d.toScrollIndex];e&&e.key===t&&(u.selectedLine=e.line)}}const _=s.createElement(f.LineTransform,{expanded:r.underlyingItem.expanded,section:t,line:r.underlyingItem.data,pureHTML:i.showHtml,subParser:this._subParser,raw:e.data.content,lineNumber:l,findResult:u,contentId:`rowContent-${n}`});return s.createElement("div",{className:(0,g.css)("line-row flex-row flex-grow",r.underlyingItem.childItems&&"group-item")},s.createElement(L,{index:l,sectionKey:t,className:h,line:l,content:_,onCopyLink:i.getLineLink&&this._copyLink,copy:this._copy}))})),rowHeight:20,ref:e.data.treeRef}),!l&&i.snaps&&i.snaps.length>0&&s.createElement("div",{className:"lines-content"},i.snaps.map(((e,n)=>{const r=this._parser.parse(e.content)[0],o=s.createElement(f.LineTransform,{section:t,line:r,subParser:this._subParser,raw:e.content,lineNumber:e.line,findResult:m});return o&&s.createElement(L,{index:n,sectionKey:t,key:t+n,className:"snap",isSnap:!0,line:e.line,content:o,onClick:this._onSnapLineClick,onCopyLink:i.getLineLink&&this._copyLink,copy:this._copy})}))))})))})))))))}))}componentDidMount(){const e=this._selection&&this._selection.key;e&&this._setContent(e),this._container.current&&this._container.current.focus(),this._find.result.subscribe(this._onFind)}componentWillUnmount(){this._unregisterScrollable(),this._find.result.unsubscribe(this._onFind)}initializeScrollable(e){this._scrollable=e,this._scrollable.addEventListener("keydown",this._bindKeys)}select(e,t){this._showLog[e]&&(t?(this._selection={key:e,lineToScroll:t},this._toLine={key:e,line:t},this._scrollPending=!0):this._selection=void 0,this._setContent(e),this._selectionChanged[e].value=!this._selectionChanged[e].value,this._toSelectAll=e)}updateContent(e){const t=this._showLog[e]&&this._showLog[e].value;void 0!==t&&!0!==t||this._setContent(e,!0)}focus(){this._container.current&&this._container.current.focus()}find(e){this._noScroll(),this._findText=e,this._find.find(this._findText,this._getFindProps())}findNext(){this._findText&&this._find.down()}clearFind(){this._find.result&&(this._find.result.value=void 0)}findPrev(){this._findText&&this._find.up()}getFindResult(){return this._find.result}_noScroll(){this._autoScroll=!1,delete this._autoScrollLine}_getTreeItemsFromLines(e){let t={},s=-1,i=[];for(let n=0;n<e.length;n++){const r=e[n],o=r.nodes[0];if(r.nodes.some((e=>!!e.isGroup)))-1!=s&&(i.push(t[s]),s=-1),s=r.nodes[0].lineIndex,t[s]={data:r};else if(o.group&&t[o.group.lineIndex]){const e=t[o.group.lineIndex];e.childItems?e.childItems.push({data:r}):e.childItems=[{data:r}]}else-1!=s&&(i.push(t[s]),s=-1),i.push({data:r})}return-1!=s&&i.push(t[s]),i}_jump(e=!1){const t=this.props.sections.value||[],s=e?t[0]:t[t.length-1];this._goTo(s,e)}_goTo(e,t){if(this._container.current&&e){let s=this._container.current.querySelector(`[data-sec="${e.key}"]`);const i=this.props.sections.value||[];s&&(i.length>1&&s.scrollIntoView({behavior:"auto",block:"center"}),1==i.length&&s.scrollIntoView(t))}}_unregisterScrollable(){this._scrollable&&this._scrollable.removeEventListener("keydown",this._bindKeys)}_initializeSections(e,t=!1){const s=this._selection?this._selection.key:null;e.forEach((e=>{if(this._sections[e.key]){if(this._sections[e.key].value=e,t)return void(this._showLog[e.key].value&&this._setContent(e.key,!0))}else this._sections[e.key]=new n.ObservableValue(e);const i=!(s!==e.key&&!e.isExpanded)||void 0;this._showLog[e.key]?this._showLog[e.key].value=i:this._showLog[e.key]=new n.ObservableValue(i),this._data[e.key]?this._data[e.key].value={}:this._data[e.key]=new n.ObservableValue({}),this._selectionChanged[e.key]?this._selectionChanged[e.key].value=!1:this._selectionChanged[e.key]=new n.ObservableValue(!1),this._copyChanged[e.key]?this._copyChanged[e.key].value=!1:this._copyChanged[e.key]=new n.ObservableValue(!1),e.isExpanded&&this._setContent(e.key)}))}_scroll(e,t,s="center",i){const n=t-1;if(e&&e.treeItems&&e.treeRef&&e.treeRef.current){let t=this._findFromIndex(n,e.treeItems);t&&e.treeProvider&&e.treeProvider.expand(t,!0),e.treeRef.current.scrollIntoView(n,{block:s})}requestAnimationFrame((()=>{i&&i()}))}_recountLineIndexIfHasGroups(e,t){var s=t.split("\r\n");for(let t=0;t<s.length&&e>t;t++)"##[endgroup]"==s[t]&&e--;return e}_getFindProps(){let e=[],t=[],s=[],i=[];return Object.keys(this._sections).forEach((n=>{const r=this._showLog[n]&&this._showLog[n].value&&this._data[n]&&this._data[n].value;if(r){i.push(n);const o=r.treeRef&&r.treeRef.current&&r.treeRef.current.getStats();o&&s.push({startIndex:o.firstMaterialized,endIndex:o.lastMaterialized});const l=Math.max(e.length-1,0);e=e.concat(r.lines);const a=Math.max(e.length-1,0);t.push({startIndex:l,endIndex:a})}})),{getContent:this._getFindContent,lines:e,sectionKeys:i,sectionMarkers:t,sectionLimits:s}}_onToggleLog(e){this._showLog[e].value=!this._showLog[e].value,this._showLog[e].value&&(this._setContent(e),requestAnimationFrame((()=>{this._scroll(this._data[e].value,0,"nearest")})));let t=this._viewerWidth.value-20;this.props.sections.value.forEach((e=>{let s=this._data[e.key].value;this._showLog[e.key].value&&s.largestRowWidth&&(t=Math.max(t,s.largestRowWidth))})),this._largestRowWidth.value=t,this._reFind()}_setContent(e,t=!1){const s=this.props.sections.value.find((t=>t.key===e));if(s){this._showLog[e].value||(this._showLog[e].value=!0);const i=this._data[e]&&this._data[e].value;if(t||!i.content){this._pending[s.key]=!0;const i=s.getData();i&&(i.then?i.then((i=>{this._onData(s,e,i,t)})):this._onData(s,e,i,t))}else this._onData(s,e,i.content)}}_onData(e,t,s,i){if(!this._data[t])return void console.error("section data can't be null",t);const n=this._data[t].value;let r=0,o=s||"";const l=e.parser||this._parser;let a,c=n.showTimestamps!=this.props.showTimestamps;if(!c&&o.indexOf(n.content)>0&&(c=!0),o=this.props.showTimestamps?o:o.replace(m.TimestampRegex,""),o=o.replace(/[â€œâ€]/g,""),c)a=l.parse(o);else{const e=n.content?n.content.length:0;r=n.lines?n.lines.length:0,a=l.parse(o,e,r)}let h=0;a.forEach((e=>{const t=e.nodes.length;if(t>0){const s=e.nodes[0].start,i=e.nodes[t-1].end;h=Math.max(h,8*(i-s))}}));const d=this._getTreeItemsFromLines(a),u=n.treeItems&&!c?n.treeItems.concat(d):d,g=new _.TreeItemProvider(u),p=e.asyncInfo;p&&p.hasMore&&g.value.unshift({underlyingItem:{data:void 0}});const f=this._getTreeRef(t);this._largestRowWidth.value<h&&(this._largestRowWidth.value=h);let y={lines:r?n.lines.concat(a):a,content:o,findResult:n.findResult,treeProvider:g,treeItems:u,treeRef:f,largestRowWidth:h,showTimestamps:!!this.props.showTimestamps};this._data[t].value=y,!i&&this._reFind(),delete this._pending[e.key],i&&!e.noAutoScroll&&this._autoScroll&&n&&n.lines&&n.lines.length<y.lines.length?(this._autoScrollLine={key:t,line:y.lines.length},this._scrollPending=!0):delete this._autoScrollLine,this._scrollToLine()}_deferScroll(){requestAnimationFrame((()=>{this._scrollToLine()}))}_scrollToLine(){let e=this._toLine||this._findLine.value||this._autoScrollLine;if(!e||this._pending[e.key])return;const t=e&&this._data[e.key]&&this._data[e.key].value;if(this._scrollPending&&e&&t&&t.lines&&this._container.current&&t.lines.length>0){const s=this._container.current.querySelector(`[data-sec="${e.key}"]`);if(s){if(s.querySelector('[data-snap="1"]'))return void this._deferScroll();const i=()=>{this._scrollPending=!1,e===this._toLine&&(this._toLine=void 0),e===this._findLine.value&&(this._findLine.value=void 0)};let n="nearest";e!==this._toLine&&e!==this._findLine.value||(n="center"),e===this._autoScrollLine&&(n="end"),e.line=this._recountLineIndexIfHasGroups(e.line,t.content),t&&this._scroll(t,e.line,n,i)}}}}function P(e){const[t,n]=s.useState(!1);return s.useLayoutEffect((()=>{if(e.spinner){const t=setTimeout((()=>{e.spinner&&n(!0)}),150);return()=>{clearTimeout(t)}}n(!1)}),[e.spinner]),s.createElement(s.Fragment,null,t&&s.createElement(c.Spinner,{size:"xsmall",className:"status-spinner"}),!t&&s.createElement(s.Fragment,null,e.statusProps&&s.createElement(h.Status,Object.assign({},e.statusProps,{className:"flex-self-center fontSizeM "+(e.noStatusFaint?"":"faint"),size:"16"})),e.iconProps&&s.createElement(i.Icon,Object.assign({},e.iconProps,{className:"fontSizeML status-icon"}))))}t[e].LogViewer=b;class k{constructor(){this._toScrollIndex=0,this._value="",this._result=new n.ObservableValue(void 0),this._onChange=(e,t,s)=>{let i;this._value=t,this._value===this._prevValue&&s.sectionKeys===this._prevSearchSectionKeys||(this._toScrollIndex=0),this._prevValue=t,this._prevSearchSectionKeys=s.sectionKeys;let n=[],r={};if(t){const e=s.lines;for(let i=0;i<s.sectionMarkers.length;i++){const o=Math.max(n.length-1,-1),l=s.sectionKeys[i],a=s.sectionMarkers[i].startIndex,c=Math.max(s.sectionLimits[i].startIndex,0),h=s.sectionMarkers[i].endIndex;for(let r=a+c;r<=h;r++){const o=e[r],c=i>0?Math.max(r-a,0):r+1;this._match(t,l,o,c,n,s)}if(c!==a)for(let r=a;r<=c;r++){const o=e[r],c=i>0?Math.max(r-a,0):r+1;this._match(t,l,o,c,n,s)}const d=Math.max(n.length-1,0);n.length>0&&(r[l]={startIndex:o+1,endIndex:d})}}n.length>0&&(i={lines:n,text:t,toScrollIndex:this._toScrollIndex,scrollCount:n.length,markers:r}),this._result.value=i}}find(e,t){this._onChange(null,e,t)}get result(){return this._result}down(){if(this._result.value){const t=this._toScrollIndex+1;this._toScrollIndex=t>this._result.value.lines.length-1?0:t;var e=Object.assign({},this._result.value);e.toScrollIndex=this._toScrollIndex,this._result.value=e}}up(){if(this._result.value){const t=this._toScrollIndex-1;this._toScrollIndex=t<0?this._result.value.lines.length-1:t;var e=Object.assign({},this._result.value);e.toScrollIndex=this._toScrollIndex,this._result.value=e}}_match(e,t,s,i,n,r){let o=!1;const l=s.nodes.length;if(l>0){const i=s.nodes[0].start,n=s.nodes[l-1].end,a=r.getContent(t);-1!==(0,m.getText)(a.substring(i,n)).indexOf((0,m.getText)(e))&&(o=!0)}o&&n.push({key:t,line:i})}}}("ComponentsLogViewerLogViewer"),t.LogViewer={},Object.defineProperty(t.LogViewer,"LogViewer",{enumerable:!0,get:function(){return v.LogViewer}})}),["Resources","Utilities/Parser","Components/LogViewer/LineTransform","Utilities/LogParser","Components/LogViewer/LogViewer","LogViewer"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-distributedtask-web.run-logs"}}));