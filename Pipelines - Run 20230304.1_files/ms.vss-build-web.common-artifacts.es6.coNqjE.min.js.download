"use strict";define("Build/Common/Artifacts",["require","exports","Build/Common/Library/ErrorHandler","Build/Flux/Action","react","Build/Common/Library/Navigation","VSS/Legacy/Legacy","VSS/Core/Util/String","VSS/Platform/Context","Build/Flux/Store","Build/Common/Library/Stores/Permissions","Build/Common/Library/Security","Build/Shared/Components/DetailsSection/DetailsSection","VSSUI/Icon","VSSUI/Link","VSSUI/TooltipEx","VSSUI/Menu"],(function(t,e,r,i,s,o,a,n,c,l,d,p,u,f,h,m,A){var y,v,S,C,b,g,_,x,w,T,B,L,E,R,P;y=e.Resources={},e.Resources.AriaBuildArtifactDetailsChevron="Show build artifact details",e.Resources.AriaBuildArtifactsList="List of build artifacts",e.Resources.BuildArtifacts="Build artifacts published",e.Resources.BuildArtifactFormat="Artifact {0}",e.Resources.BuildArtifactLabelFormat="Label {0}",e.Resources.ContainerType="File container",e.Resources.Download="Download",e.Resources.DownloadFormat="Download {0}",e.Resources.PipelineArtifact="Pipeline artifact",e.Resources.FilePathType="File share",e.Resources.GitRefType="GitRef",e.Resources.MoreOptions="More options",e.Resources.SymbolRequestType="SymbolRequest",e.Resources.SymbolStoreType="SymbolStore",e.Resources.TfvcLabelType="TfvcLabel",e.Resources.UnknownType="Unknown",e.Resources.VersionControlType="VersionControl",e.Resources.ViewContents="View contents",function(t){v=e.Source={};class r{constructor(t){this._client=t.client,this._projectId=t.projectId}getArtifacts(t){return this._client.getArtifacts(this._projectId,t).then(r.sortArtifacts)}getArtifact(t,e){return this._client.getArtifact(this._projectId,t,e)}}e.Source.ArtifactsSource=r,r.sortArtifacts=t=>(t||[]).sort(((t,e)=>t.name>e.name?1:t.name<e.name?-1:0))}(),function(t){S=e.Action={};e.Action.ArtifactsActionCreator=class{constructor(t){this._actionHub=t.actionHub||new s,this._source=new v.ArtifactsSource({client:t.client,projectId:t.projectId})}fetchArtifacts(t){this._source.getArtifacts(t).then((t=>this._actionHub.artifactsAvailable.invoke(t))).catch(r.handleError)}fetchArtifact(t,e){this._source.getArtifact(t,e).then((t=>this._actionHub.artifactAdded.invoke(t))).catch(r.handleError)}};class s{constructor(){this._artifactAdded=new i.Action,this._artifactsAvailable=new i.Action}get artifactAdded(){return this._artifactAdded}get artifactsAvailable(){return this._artifactsAvailable}}e.Action.ArtifactsActionHub=s}(),C=e.Common={},(P=e.Common.BuildArtifactTypes||(e.Common.BuildArtifactTypes={})).FilePath="FilePath".toLowerCase(),P.SymbolStore="SymbolStore".toLowerCase(),P.VersionControl="VersionControl".toLowerCase(),P.Container="Container".toLowerCase(),P.GitRef="GitRef".toLowerCase(),P.TfvcLabel="TfvcLabel".toLowerCase(),P.SymbolRequest="SymbolRequest".toLowerCase(),P.PipelineArtifact="PipelineArtifact".toLowerCase(),P.Unknown="Unknown".toLowerCase(),function(t){b=e.providersBase={};e.providersBase.Base=class{constructor(t,e,r){this.pageContext=t,this.artifact=e,this.providerContext=r}getArtifact(){return this.artifact}getProviderContext(){return this.providerContext}supportsDownload(){return!1}supportsExploring(){return!1}getDisplayOptions(){return{text:this.artifact.name,iconName:"ZipFolder",tooltip:(0,n.format)(y.BuildArtifactFormat,this.artifact.name),type:this.getType()}}onDownload(){this.supportsDownload()&&this.openLink(this.getDownloadURL())}onExplore(){this.pageContext.getService("IVssLayoutManager").renderCallout((t=>{const e={modules:["Build/Scripts/ArtifactExplorerDialogLWP"],wrappedType:"ci-artifacts-explorer-dialog",artifact:this.artifact,buildId:this.providerContext.buildId,projectId:this.providerContext.projectId};return s.createElement(a.LegacyComponent,e)}))}getDownloadURL(){return this.supportsDownload()?this.artifact.resource.downloadUrl:""}showCopyDialog(){this.pageContext.getService("IVssLayoutManager").renderCallout((t=>{const e={modules:["Build/Scripts/ArtifactExplorerDialogLWP"],wrappedType:"ci-artifacts-copy-dialog",content:this.artifact.resource.downloadUrl};return s.createElement(a.LegacyComponent,e)}))}getType(){switch(this.getKey()){case C.BuildArtifactTypes.Container:return y.ContainerType;case C.BuildArtifactTypes.PipelineArtifact:return y.PipelineArtifact;case C.BuildArtifactTypes.FilePath:return y.FilePathType;case C.BuildArtifactTypes.GitRef:return y.GitRefType;case C.BuildArtifactTypes.SymbolRequest:return y.SymbolRequestType;case C.BuildArtifactTypes.SymbolStore:return y.SymbolStoreType;case C.BuildArtifactTypes.TfvcLabel:return y.TfvcLabelType;case C.BuildArtifactTypes.VersionControl:return y.VersionControlType}return y.UnknownType}openLink(t){(0,o.openLinkSecurely)(t)}}}(),function(t){g=e.providersContainer={};class r extends b.Base{getKey(){return C.BuildArtifactTypes.Container}supportsDownload(){return!0}supportsExploring(){return!0}}e.providersContainer.Container=r}(),function(t){_=e[t]={};class r extends b.Base{constructor(t,e,r){super(t,e,r)}getKey(){return C.BuildArtifactTypes.PipelineArtifact}supportsDownload(){return!0}supportsExploring(){return!0}getDownloadURL(){return this.artifact.resource.downloadUrl}}e[t].PipelineArtifact=r}("providersPipelineArtifact"),function(t){x=e.providersFilepath={};class r extends b.Base{getKey(){return C.BuildArtifactTypes.FilePath}supportsDownload(){return!0}supportsExploring(){return!1}onDownload(){this.showCopyDialog()}}e.providersFilepath.FilePath=r}(),function(t){w=e.providersGitRef={};class r extends b.Base{getKey(){return C.BuildArtifactTypes.GitRef}getDisplayOptions(){return{text:this.artifact.name,iconName:"GitLogo",tooltip:(0,n.format)(y.BuildArtifactLabelFormat,this.artifact.name),type:this.getType()}}}e.providersGitRef.GitRef=r}(),function(t){T=e.providersTfvcLabel={};class r extends b.Base{getKey(){return C.BuildArtifactTypes.TfvcLabel}supportsDownload(){return!1}getDisplayOptions(){return{text:this.artifact.name,iconName:"TFVCLogo",tooltip:(0,n.format)(y.BuildArtifactLabelFormat,this.artifact.name),type:this.getType()}}}e.providersTfvcLabel.TfvcLabel=r}(),function(t){B=e[t]={};class r extends b.Base{getKey(){return C.BuildArtifactTypes.VersionControl}getDisplayOptions(){return{text:this.artifact.name,iconName:"TFVCLogo",tooltip:(0,n.format)(y.BuildArtifactLabelFormat,this.artifact.name),type:this.getType()}}}e[t].VersionControl=r}("providersVersionControl"),function(t){L=e[t]={};class r extends b.Base{getKey(){return C.BuildArtifactTypes.SymbolRequest}}e[t].SymbolRequest=r}("providersSymbolRequest"),function(t){E=e[t]={};class r extends b.Base{getKey(){return C.BuildArtifactTypes.SymbolStore}}e[t].SymbolStore=r}("providersSymbolStore"),function(t){R=e.providersUnknown={};class r extends b.Base{getKey(){return C.BuildArtifactTypes.Unknown}}e.providersUnknown.Unknown=r}(),function(t){e[t]={};class r extends c.VssService{getArtifactProvider(t,e){switch(t.resource.type.toLowerCase()){case C.BuildArtifactTypes.Container:return new g.Container(this.pageContext,t,e);case C.BuildArtifactTypes.PipelineArtifact:return new _.PipelineArtifact(this.pageContext,t,e);case C.BuildArtifactTypes.FilePath:return new x.FilePath(this.pageContext,t,e);case C.BuildArtifactTypes.GitRef:return new w.GitRef(this.pageContext,t,e);case C.BuildArtifactTypes.TfvcLabel:return new T.TfvcLabel(this.pageContext,t,e);case C.BuildArtifactTypes.VersionControl:return new B.VersionControl(this.pageContext,t,e);case C.BuildArtifactTypes.SymbolRequest:return new L.SymbolRequest(this.pageContext,t,e);case C.BuildArtifactTypes.SymbolStore:return new E.SymbolStore(this.pageContext,t,e);default:return new R.Unknown(this.pageContext,t,e)}}}e[t].ArtifactProviderService=r,c.Services.add("IArtifactProviderService",{serviceFactory:r})}("providersArtifactProvider"),function(t){e.Store={};class r extends l.Store{constructor(t){super(),this._artifacts=[],this._artifactProviders=[],this._fetchingArtifacts={},this._setArtifacts=t=>{this._artifacts=t;const e={buildId:this._buildId,projectId:this._projectId};this._artifactProviders=(t||[]).map((t=>this._providerService.getArtifactProvider(t,e))),this._storeChanged()},this._onArtifactAdded=t=>{this._artifacts.push(t),this._artifacts=v.ArtifactsSource.sortArtifacts(this._artifacts),this._setArtifacts(this._artifacts)},this._storeChanged=()=>{this.emitChanged()},this._buildClient=t.pageContext.getRestClient("IBuildRestClient"),this._providerService=t.pageContext.getService("IArtifactProviderService"),this._actionHub=t.actionHub||new S.ArtifactsActionHub,this._projectId=t.projectId,this._actionCreator=t.actionCreator||new S.ArtifactsActionCreator({actionHub:this._actionHub,client:this._buildClient,projectId:this._projectId}),this._permissionsStore=t.permissionsStore?t.permissionsStore:new d.PermissionsStore({pageContext:t.pageContext}),this._security=new p.Security({projectId:this._projectId,store:this._permissionsStore}),this._actionHub.artifactsAvailable.addListener(this._setArtifacts),this._actionHub.artifactAdded.addListener(this._onArtifactAdded),this._permissionsStore.addListener(this._storeChanged),this._buildId=t.buildId}dispose(){this._actionHub.artifactsAvailable.removeListener(this._setArtifacts),this._actionHub.artifactAdded.removeListener(this._onArtifactAdded),this._permissionsStore.removeListener(this._storeChanged),this._fetchingArtifacts={}}getArtifactProviders(){return this._artifactProviders}canExploreArtifacts(){return!(this._security.isAnonymousUser()||this._security.isPublicUser())}addArtifact(t,e){this._buildId!==t||this._fetchingArtifacts[e]||(this._actionCreator.fetchArtifact(t,e),this._fetchingArtifacts[e]=!0)}updateBuild(t){this._buildId!==t&&(this._buildId=t,this._buildId?this._actionCreator.fetchArtifacts(this._buildId):this._setArtifacts([]))}}e.Store.ArtifactsStore=r,r.key="build-artifacts-store"}(),function(t){e.Timeline={};class r extends s.Component{constructor(t,e){super(t),this._updateArtifactsState=()=>{this.setState({providers:this._store.getArtifactProviders(),canExploreArtifacts:this._store.canExploreArtifacts()})},this._store=t.store,this.state={providers:this._store.getArtifactProviders(),canExploreArtifacts:this._store.canExploreArtifacts()}}componentDidMount(){this._store.addListener(this._updateArtifactsState)}componentWillUnmount(){this._store.removeListener(this._updateArtifactsState)}render(){return s.createElement(u.DetailsSection,{className:"details-timeline-left b-details-timeline ci-hover-behavior",sectionKey:"build-artifacts-timeline",chevronProps:{ariaLabel:y.AriaBuildArtifactDetailsChevron},isExpandedByDefault:!0},s.createElement(u.DetailsSectionHeader,{renderAsHeading:!0},s.createElement("span",null,y.BuildArtifacts)),s.createElement(u.DetailsSectionSecondaryHeader,null,s.createElement("span",null)),s.createElement(u.DetailsSectionContent,null,s.createElement(i,{providers:this.state.providers,canExploreArtifacts:this.state.canExploreArtifacts})))}}e.Timeline.ArtifactSnapshotContent=r;class i extends s.Component{render(){return s.createElement("div",{className:"build-artifacts-details-content"},s.createElement("ul",{className:"artifacts-list","aria-label":y.AriaBuildArtifactsList},this.props.providers.map((t=>s.createElement("li",{key:t.getArtifact().id},s.createElement(o,{provider:t,canExploreArtifacts:this.props.canExploreArtifacts}))))))}}class o extends s.Component{constructor(t){super(t),this._onDownload=()=>{this.props.provider.onDownload()},this._onExplore=()=>{this.props.provider.onExplore()},this.state={}}render(){const t=this.props.provider,e=t.getDisplayOptions(),r=t.getDownloadURL();let i=[];this.props.canExploreArtifacts&&t.supportsExploring()&&i.push({id:"artifact-explore",text:y.ViewContents,onActivate:this._onExplore,iconProps:{iconName:"DocumentSet"}}),t.supportsDownload()&&i.push({id:"artifact-download",text:y.Download,onActivate:this._onDownload,iconProps:{iconName:"Download"}});const o=this.state.target?"":"hidden";return s.createElement("div",{className:"build-artifact-item flex flex-center"},s.createElement("div",{className:"artifact-name-area flex flex-grow"},s.createElement(f.Icon,{className:"artifact-icon fontSizeL",iconName:e.iconName}),s.createElement("span",null," "),s.createElement(m.Tooltip,{text:(0,n.format)(y.DownloadFormat,e.text)},s.createElement("div",{className:"artifact-data flex flex-column relative"},r&&s.createElement(h.Link,{className:"artifact-name",href:r},e.text),!r&&s.createElement("div",{className:"artifact-name"},e.text),s.createElement("div",{className:"artifact-info"},e.type)))),s.createElement("div",{className:`button-area ${o} relative flex-self-end`},i.length>0?s.createElement(A.MenuButton,{hideDropdownIcon:!0,className:"subtle",contextualMenuProps:{menuProps:{id:"timeline-menu",items:i}},iconProps:{iconName:"More"}}):null))}}}()}),["Resources","Source","Action","Common","providers/Base","providers/Container","providers/PipelineArtifact","providers/Filepath","providers/GitRef","providers/TfvcLabel","providers/VersionControl","providers/SymbolRequest","providers/SymbolStore","providers/Unknown","providers/ArtifactProvider","Store","Timeline"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-build-web.common-artifacts"}}));